<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>workAI ‚Äî Votre logiciel sur mesure √† prix cass√©</title>
<meta name="description" content="Votre logiciel de gestion sur mesure √† prix cass√© : CRM, facturation, emailing, e-learning, e-commerce. Tous les modules inclus pour 15‚Ç¨/mois.">
<meta property="og:title" content="workAI ‚Äî Votre logiciel sur mesure √† prix cass√©">
<meta property="og:description" content="CRM, facturation, emailing, e-learning, e-commerce ‚Äî tous les modules inclus pour 15‚Ç¨/mois. Testez la d√©mo live.">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üç∞</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root{--bg:#060609;--surface:#0c0c12;--card:#10101a;--border:#1a1a24;--text:#e8e8ee;--muted:#888894;--accent:#00d4aa;--accent2:#ff6b35;--radius:16px}
:root.light{--bg:#f5f5f7;--surface:#ffffff;--card:#ffffff;--border:#e0e0e6;--text:#1a1a2e;--muted:#6b6b7b;--accent:#00d4aa;--accent2:#ff6b35}
*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.025;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
nav{position:fixed;top:0;left:0;right:0;z-index:300;padding:16px 32px;display:flex;align-items:center;justify-content:space-between;background:rgba(6,6,9,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.nav-logo{font-size:22px;font-weight:800;letter-spacing:-1px;cursor:pointer}.nav-logo span{color:var(--accent)}
.nav-links{display:flex;gap:24px;align-items:center}
.nav-links a{color:var(--muted);text-decoration:none;font-size:14px;font-weight:500;transition:color .3s}.nav-links a:hover{color:var(--text)}
.btn-sm{padding:10px 22px;border-radius:10px;font-weight:700;font-size:13px;text-decoration:none;transition:all .3s;border:none;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:6px}
.btn-accent{background:var(--accent);color:var(--bg)}.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
.hero{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:120px 24px 80px;position:relative}
.hero::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:800px;height:800px;border-radius:50%;background:radial-gradient(circle,rgba(0,212,170,.08) 0%,rgba(255,107,53,.04) 40%,transparent 70%);pointer-events:none}
.hero-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 18px;border-radius:50px;background:rgba(0,212,170,.08);border:1px solid rgba(0,212,170,.2);font-size:13px;font-weight:600;color:var(--accent);margin-bottom:32px;animation:fadeUp .8s ease-out}
.hero-badge .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.hero h1{font-size:clamp(40px,6vw,76px);font-weight:900;line-height:1.05;letter-spacing:-3px;max-width:900px;margin-bottom:24px;animation:fadeUp .8s ease-out .1s both}
.hero h1 .price{color:var(--accent)}.hero h1 .old{text-decoration:line-through;color:var(--muted);font-weight:500;opacity:.5}
.hero-sub{font-size:clamp(16px,2vw,20px);color:var(--muted);max-width:600px;line-height:1.6;margin-bottom:40px;animation:fadeUp .8s ease-out .2s both}
.hero-ctas{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;animation:fadeUp .8s ease-out .3s both}
.btn-primary{background:var(--accent);color:var(--bg);padding:16px 36px;border-radius:12px;font-size:16px;font-weight:700;border:none;cursor:pointer;font-family:inherit;transition:all .3s;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,212,170,.3)}
.btn-secondary{background:transparent;color:var(--text);padding:16px 36px;border-radius:12px;font-size:16px;font-weight:600;border:1px solid var(--border);cursor:pointer;font-family:inherit;transition:all .3s;text-decoration:none}
.hero-proof{margin-top:48px;display:flex;gap:40px;flex-wrap:wrap;justify-content:center;animation:fadeUp .8s ease-out .4s both}
.hero-proof .val{font-size:28px;font-weight:800;color:var(--accent);font-family:'JetBrains Mono',monospace}.hero-proof .lab{font-size:12px;color:var(--muted);margin-top:4px;letter-spacing:1px;text-transform:uppercase}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
section{padding:100px 24px}.container{max-width:1100px;margin:0 auto}
.section-tag{font-size:12px;letter-spacing:4px;text-transform:uppercase;color:var(--accent);font-weight:700;margin-bottom:16px}
.section-title{font-size:clamp(28px,4vw,44px);font-weight:800;letter-spacing:-2px;margin-bottom:16px}
.section-sub{font-size:17px;color:var(--muted);max-width:560px;line-height:1.6}
.problem{background:var(--surface);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.problem-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;margin-top:48px}
.problem-card{padding:32px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);transition:all .4s}
.problem-card:hover{border-color:rgba(255,107,53,.3);transform:translateY(-4px)}
.problem-card .icon{font-size:32px;margin-bottom:16px}.problem-card h3{font-size:18px;font-weight:700;margin-bottom:8px}.problem-card p{font-size:14px;color:var(--muted);line-height:1.6}
.problem-card .old-price{display:inline-block;margin-top:12px;padding:6px 14px;border-radius:8px;background:rgba(255,107,53,.1);border:1px solid rgba(255,107,53,.2);font-size:13px;font-weight:600;color:var(--accent2);font-family:'JetBrains Mono',monospace}
.modules-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:48px;max-width:900px;margin-left:auto;margin-right:auto}
.module-card{padding:24px 20px;border-radius:14px;border:2px solid var(--border);background:var(--surface);cursor:pointer;transition:all .3s;position:relative}
.module-card:hover{border-color:rgba(0,212,170,.3)}.module-card.selected{border-color:var(--accent);background:rgba(0,212,170,.04)}
.module-card.selected::after{content:'‚úì';position:absolute;top:12px;right:12px;width:24px;height:24px;border-radius:50%;background:var(--accent);color:var(--bg);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
.module-card .m-icon{font-size:28px;margin-bottom:12px}.module-card .m-name{font-size:15px;font-weight:700;margin-bottom:4px}.module-card .m-desc{font-size:12px;color:var(--muted)}
.modules-summary{margin-top:40px;padding:32px;border-radius:var(--radius);max-width:600px;margin-left:auto;margin-right:auto;background:linear-gradient(135deg,rgba(0,212,170,.06) 0%,rgba(255,107,53,.04) 100%);border:1px solid rgba(0,212,170,.15)}
.select-all-btn{background:rgba(0,212,170,.1);border:1px solid rgba(0,212,170,.25);color:var(--accent);padding:10px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;margin-top:24px}
.pricing-card{max-width:520px;margin:48px auto 0;padding:48px;border-radius:20px;background:var(--surface);border:2px solid var(--accent);position:relative;overflow:hidden}
.pricing-card::before{content:'';position:absolute;top:-50%;right:-50%;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(0,212,170,.08) 0%,transparent 70%);pointer-events:none}
.pricing-popular{display:inline-block;padding:6px 16px;border-radius:50px;background:var(--accent);color:var(--bg);font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:24px}
.pricing-amount{font-size:64px;font-weight:900;font-family:'JetBrains Mono',monospace;letter-spacing:-3px}.pricing-amount span{font-size:20px;color:var(--muted);font-weight:400}
.pricing-setup{font-size:15px;color:var(--muted);margin:8px 0 24px}.pricing-setup strong{color:var(--accent2)}
.pricing-features{list-style:none;text-align:left;margin-bottom:32px}.pricing-features li{padding:10px 0;font-size:15px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,.04)}.pricing-features li:last-child{border:none}.pricing-features .check{color:var(--accent);font-weight:800}
.pricing-compare{margin-top:24px;padding:20px;border-radius:12px;background:rgba(255,107,53,.06);border:1px solid rgba(255,107,53,.15);text-align:left}
.pricing-compare .line{display:flex;justify-content:space-between;padding:4px 0;font-size:13px}.pricing-compare .line .them{color:var(--accent2);text-decoration:line-through;opacity:.7}.pricing-compare .line .us{color:var(--accent);font-weight:700}
.demo-enter-box{max-width:700px;margin:40px auto 0;padding:48px;border-radius:24px;background:var(--bg);border:1px solid var(--border);position:relative;overflow:hidden}
.demo-enter-box::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(0,212,170,.04),rgba(255,107,53,.02));pointer-events:none}
.founder-box{max-width:560px;margin:40px auto 0;padding:40px;border-radius:20px;background:var(--bg);border:1px solid var(--border)}
.founder-box h3{font-size:24px;font-weight:800;margin-bottom:8px}.founder-box p{font-size:14px;color:var(--muted);line-height:1.6;margin-bottom:24px}
.founder-box .perk{display:flex;gap:10px;padding:6px 0;font-size:14px}
.form-row{display:flex;gap:8px}.form-row input{flex:1;padding:14px 18px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:15px;font-family:inherit;outline:none}.form-row input:focus{border-color:var(--accent)}.form-row input::placeholder{color:#555}
.form-row button{padding:14px 28px;border-radius:10px;border:none;background:var(--accent);color:var(--bg);font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap}
footer{padding:40px 24px;text-align:center;border-top:1px solid var(--border);font-size:13px;color:#444;letter-spacing:1px}
/* DEMO */
#demoApp{display:none;position:fixed;inset:0;z-index:250;background:var(--bg);overflow:hidden}
#demoApp.visible{display:flex;flex-direction:column;animation:fadeIn .4s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.demo-topbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;background:rgba(6,6,9,.95);border-bottom:1px solid var(--border);flex-shrink:0}
.demo-back{color:var(--accent);font-size:13px;font-weight:600;cursor:pointer;background:none;border:none;font-family:inherit}
.demo-branding{height:40px;display:flex;align-items:center;justify-content:center;gap:14px;background:rgba(0,212,170,.04);border-bottom:1px solid rgba(0,212,170,.1);flex-shrink:0}
.demo-branding span{font-size:12px;color:var(--accent);font-weight:500}
.swatch{width:18px;height:18px;border-radius:5px;border:2px solid transparent;cursor:pointer;transition:all .2s}.swatch.active{border-color:#fff;transform:scale(1.15)}
.demo-body{display:flex;flex:1;overflow:hidden}
.demo-sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);padding:12px 8px;overflow-y:auto;flex-shrink:0}
.s-section{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#555;font-weight:700;padding:12px 12px 6px}
.s-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;cursor:pointer;transition:all .2s;font-size:14px;color:var(--muted);margin-bottom:1px}
.s-item:hover{background:rgba(255,255,255,.03);color:var(--text)}.s-item.active{background:rgba(0,212,170,.08);color:var(--accent);font-weight:600}
.s-item .s-badge{margin-left:auto;font-size:10px;padding:2px 6px;border-radius:4px;background:var(--accent);color:var(--bg);font-weight:700}
.demo-main{flex:1;overflow-y:auto;padding:28px 32px}
.page-head{margin-bottom:24px}.page-head h1{font-size:24px;font-weight:800;letter-spacing:-1px;margin-bottom:4px}.page-head p{font-size:14px;color:var(--muted)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px}
.stat{padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border)}.stat .s-label{font-size:11px;color:var(--muted);margin-bottom:4px}.stat .s-value{font-size:24px;font-weight:800;font-family:'JetBrains Mono',monospace}.stat .s-change{font-size:11px;margin-top:3px;font-weight:600}.stat .s-change.up{color:var(--accent)}
.dt{width:100%;border-collapse:collapse}.dt th{text-align:left;padding:10px 14px;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:#555;font-weight:700;border-bottom:1px solid var(--border)}.dt td{padding:11px 14px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.03)}.dt tr:hover td{background:rgba(255,255,255,.015)}
.av{width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--bg);margin-right:6px;vertical-align:middle}
.badge{padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;display:inline-block}.badge-g{background:rgba(0,212,170,.1);color:var(--accent)}.badge-o{background:rgba(255,107,53,.1);color:var(--accent2)}.badge-b{background:rgba(96,165,250,.1);color:#60a5fa}.badge-m{background:rgba(255,255,255,.05);color:var(--muted)}.badge-click{cursor:pointer;transition:all .2s}.badge-click:hover{filter:brightness(1.2)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:400;display:flex;align-items:center;justify-content:center}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;width:90%;max-width:520px;max-height:90vh;overflow-y:auto;animation:modalIn .3s ease-out}.modal-lg{max-width:700px}
@keyframes modalIn{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
.modal h2{font-size:18px;font-weight:800;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.modal-close{margin-left:auto;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
.field{margin-bottom:12px}.field label{display:block;font-size:11px;font-weight:600;color:var(--muted);margin-bottom:5px;letter-spacing:.5px}
.field input,.field select,.field textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;transition:border-color .3s}.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent)}.field textarea{resize:vertical;min-height:60px}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn-full{width:100%;padding:13px;border-radius:12px;border:none;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .3s}
.toast{position:fixed;bottom:24px;right:24px;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:600;z-index:500;animation:toastIn .4s;box-shadow:0 12px 40px rgba(0,0,0,.4)}@keyframes toastIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.toast-success{background:var(--accent);color:var(--bg)}.toast-info{background:#3b82f6;color:#fff}
.chart-bars{display:flex;align-items:flex-end;gap:8px;height:150px;padding:12px 0}.chart-bar-w{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;height:100%;justify-content:flex-end}.chart-bar{width:100%;border-radius:6px 6px 0 0;transition:height .6s cubic-bezier(.16,1,.3,1);min-height:4px}.chart-lab{font-size:10px;color:#555;font-weight:600}.chart-val{font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}.cal-h{font-size:10px;font-weight:700;color:#555;text-align:center;padding:6px 0;letter-spacing:1px}
.cal-d{aspect-ratio:1;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:13px;font-weight:500;background:var(--card);border:1px solid var(--border);cursor:pointer;transition:all .2s;position:relative}.cal-d:hover:not(.empty){border-color:var(--accent);background:rgba(0,212,170,.04)}.cal-d.empty{background:transparent;border-color:transparent;cursor:default}.cal-d.today{border-color:var(--accent);background:rgba(0,212,170,.06)}.cal-d.has-appt::after{content:'';position:absolute;bottom:4px;width:5px;height:5px;border-radius:50%;background:var(--accent)}
.slot{padding:9px;border-radius:8px;border:1px solid var(--border);font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;text-align:center;margin-bottom:3px}.slot:hover:not(.booked){border-color:var(--accent);color:var(--accent)}.slot.booked{background:var(--accent);color:var(--bg);border-color:var(--accent);font-weight:700}
.inv-white{background:#fff;color:#222;border-radius:12px;padding:28px;font-family:'Outfit',sans-serif}.inv-table{width:100%;border-collapse:collapse;margin:14px 0}.inv-table th{text-align:left;padding:7px 0;font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#999;border-bottom:2px solid #eee}.inv-table td{padding:9px 0;font-size:12px;border-bottom:1px solid #f0f0f0}.inv-table td:last-child,.inv-table th:last-child{text-align:right}
.drop-zone{border:2px dashed var(--border);border-radius:14px;padding:28px;text-align:center;transition:all .3s;cursor:pointer}.drop-zone:hover,.drop-zone.drag{border-color:var(--accent);background:rgba(0,212,170,.04)}.drop-zone .dz-icon{font-size:32px;margin-bottom:8px}.drop-zone .dz-text{font-size:13px;color:var(--muted)}.drop-zone .dz-sub{font-size:11px;color:#555;margin-top:4px}
.ctx-menu{position:absolute;right:0;top:100%;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px;min-width:170px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:100;animation:modalIn .15s ease-out}.ctx-menu button{display:flex;align-items:center;gap:10px;width:100%;padding:10px 14px;border:none;background:none;color:var(--text);font-size:13px;font-family:inherit;cursor:pointer;border-radius:8px;text-align:left;transition:background .15s}.ctx-menu button:hover{background:rgba(255,255,255,.05)}.ctx-menu button.danger{color:var(--accent2)}.ctx-menu button.primary{color:var(--accent)}.ctx-trigger{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--muted);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:inherit}.ctx-trigger:hover{background:var(--card);color:var(--text);border-color:var(--text)}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}.fcard{padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border);transition:all .3s}.fcard:hover{border-color:rgba(0,212,170,.3);transform:translateY(-2px)}.fcard h3{font-size:14px;font-weight:700;margin:6px 0 3px}.fcard p{font-size:12px;color:var(--muted);line-height:1.4}
.eb-block{padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);margin-bottom:6px}.eb-handle{font-size:9px;color:#555;letter-spacing:1px;font-weight:700;text-transform:uppercase;margin-bottom:6px;display:flex;justify-content:space-between}.eb-handle .eb-del{color:var(--accent2);cursor:pointer;font-size:14px}
.email-card{background:#fff;color:#333;border-radius:12px;overflow:hidden;max-width:400px}
.lesson{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;background:var(--surface);border:1px solid var(--border);margin-bottom:3px;cursor:pointer;transition:all .2s}.lesson:hover{border-color:rgba(0,212,170,.3)}.lesson.done{border-color:rgba(0,212,170,.2)}.lesson-check{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;flex-shrink:0}
/* Activity feed */
.feed-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.03)}.feed-item:last-child{border:none}.feed-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}.feed-item .feed-text{font-size:13px;line-height:1.4}.feed-item .feed-time{font-size:11px;color:#555;margin-top:2px}
/* Objective bar */
.obj-bar{height:8px;border-radius:4px;background:var(--border);overflow:hidden;margin-top:6px}.obj-fill{height:100%;border-radius:4px;transition:width .8s cubic-bezier(.16,1,.3,1)}
/* Notif badge */
.notif-pop{position:absolute;top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:var(--accent2);font-size:8px;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center}
/* Quiz */
.quiz-opt{padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--bg);cursor:pointer;transition:all .2s;font-size:13px;margin-bottom:4px}.quiz-opt:hover{border-color:var(--accent)}.quiz-opt.correct{border-color:var(--accent);background:rgba(0,212,170,.08);color:var(--accent)}.quiz-opt.wrong{border-color:var(--accent2);background:rgba(255,107,53,.08);color:var(--accent2)}
/* Cart */
.cart-badge{position:relative;display:inline-block}.cart-count{position:absolute;top:-6px;right:-10px;width:18px;height:18px;border-radius:50%;background:var(--accent2);font-size:10px;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center}
/* Promo */
.promo-input{display:flex;gap:6px;margin-top:10px}.promo-input input{flex:1;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none}.promo-input button{padding:8px 16px;border-radius:8px;border:none;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit}
:root.light .demo-topbar{background:rgba(255,255,255,.95)}
:root.light .demo-branding{background:rgba(0,212,170,.06);border-bottom-color:rgba(0,212,170,.15)}
:root.light .s-item:hover{background:rgba(0,0,0,.04)}
:root.light .s-item.active{background:rgba(0,212,170,.1)}
:root.light .dt td{border-bottom-color:rgba(0,0,0,.05)}
:root.light .dt tr:hover td{background:rgba(0,0,0,.02)}
:root.light .modal-overlay{background:rgba(0,0,0,.3)}
:root.light .modal{background:var(--surface);box-shadow:0 20px 60px rgba(0,0,0,.15)}
:root.light .fcard{box-shadow:0 2px 8px rgba(0,0,0,.06)}
:root.light .fcard:hover{box-shadow:0 4px 16px rgba(0,0,0,.1)}
:root.light .stat{box-shadow:0 2px 8px rgba(0,0,0,.04)}
:root.light .lesson{background:var(--card)}
:root.light .quiz-opt{background:var(--card)}
:root.light .ctx-menu{background:var(--card);box-shadow:0 8px 24px rgba(0,0,0,.12)}
:root.light .ctx-menu button:hover{background:rgba(0,0,0,.04)}
:root.light .toast-success{color:#fff}
:root.light .btn-accent,:root.light .btn-primary,:root.light .form-row button,:root.light .s-item .s-badge,:root.light .btn-full[style*="background"]{color:#fff !important}
:root.light .av{color:#fff}
:root.light .badge-g{background:rgba(0,212,170,.12)}
:root.light .chart-bar-w .chart-lab{color:var(--muted)}
:root.light .feed-item{border-bottom-color:rgba(0,0,0,.06)}
:root.light body::after{display:none}
:root.light nav{background:rgba(255,255,255,.9)}
/* BIGGER FONTS GLOBALLY */
.page-head h1{font-size:28px;font-weight:800;letter-spacing:-1px;margin-bottom:6px}.page-head p{font-size:15px;color:var(--muted)}
.s-item{font-size:15px;padding:10px 14px}
.s-section{font-size:11px}
.stat .s-label{font-size:12px;margin-bottom:5px}.stat .s-value{font-size:26px}.stat .s-change{font-size:12px}
.dt th{font-size:11px;padding:12px 14px}.dt td{padding:12px 14px;font-size:14px}
.badge{font-size:12px;padding:4px 10px}
.field label{font-size:12px}.field input,.field select,.field textarea{font-size:14px;padding:11px 14px}
.btn-full{font-size:15px;padding:14px}
.modal h2{font-size:20px}
.fcard h3{font-size:16px;margin:8px 0 4px}.fcard p{font-size:13px}
.lesson{font-size:14px;padding:10px 14px}
.quiz-opt{font-size:14px;padding:13px 18px}
.feed-item .feed-text{font-size:14px}.feed-item .feed-time{font-size:12px}
.chart-lab{font-size:11px}.chart-val{font-size:11px}
.ctx-menu button{font-size:14px;padding:11px 16px}
.cal-d{font-size:14px}
.slot{font-size:14px;padding:10px}
.hamburger{display:none;flex-direction:column;gap:5px;cursor:pointer;z-index:301}.hamburger span{width:24px;height:2px;background:var(--text);transition:all .3s}.hamburger.open span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}.hamburger.open span:nth-child(2){opacity:0}.hamburger.open span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px)}
@media(max-width:768px){.hamburger{display:flex}nav .nav-links{display:none;position:fixed;inset:0;background:var(--bg);flex-direction:column;align-items:center;justify-content:center;gap:2rem;z-index:300}nav .nav-links.open{display:flex}section{padding:60px 20px}.hero{padding:100px 20px 60px}.demo-sidebar{display:none}.demo-main{padding:16px}.stats{grid-template-columns:1fr 1fr}.form-row{flex-direction:column}.pricing-amount{font-size:48px}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div id="landingPage">
<nav><div class="nav-logo" onclick="exitDemo()">work<span>AI</span></div><div class="nav-links" id="wNavLinks"><a href="#modules" onclick="closeWNav()">Modules</a><a href="#pricing" onclick="closeWNav()">Tarifs</a><a href="#demo-section" class="btn-sm btn-ghost" onclick="closeWNav()">üñ• D√©mo</a><a href="#founder" class="btn-sm btn-accent" onclick="closeWNav()">Offre Fondateur ‚Üí</a></div><div class="hamburger" id="wHamburger" onclick="toggleWNav()"><span></span><span></span><span></span></div></nav>
<section class="hero"><div class="hero-badge"><span class="dot"></span> 50 places ‚Äî Offre de lancement</div><h1>Votre logiciel sur mesure.<br><span class="old">5 000‚Ç¨</span> ‚Üí <span class="price">49‚Ç¨</span></h1><p class="hero-sub">Choisissez vos modules, uploadez votre logo, recevez votre application professionnelle en marque blanche.</p><div class="hero-ctas"><a href="#demo-section" class="btn-primary">üñ• Tester la d√©mo live ‚Üì</a><a href="#pricing" class="btn-secondary">D√©couvrir le tarif</a></div><div class="hero-proof"><div><div class="val">49‚Ç¨</div><div class="lab">Mise en place</div></div><div><div class="val">15‚Ç¨</div><div class="lab">/ mois tout compris</div></div><div><div class="val">3j</div><div class="lab">D√©lai livraison</div></div></div></section>
<section class="problem"><div class="container"><div class="section-tag">Le probl√®me</div><div class="section-title">Vous payez trop cher pour des outils g√©n√©riques.</div><div class="section-sub">Les ind√©pendants empilent les abonnements SaaS. Calendly, Henrri, Mailchimp...</div><div class="problem-grid"><div class="problem-card"><div class="icon">üìÖ</div><h3>Prise de rendez-vous</h3><p>Calendly, Cal.com pour g√©rer votre agenda.</p><div class="old-price">12-25‚Ç¨/mois</div></div><div class="problem-card"><div class="icon">üßæ</div><h3>Facturation</h3><p>Henrri, Freebe pour vos devis et factures.</p><div class="old-price">15-40‚Ç¨/mois</div></div><div class="problem-card"><div class="icon">üìá</div><h3>CRM</h3><p>HubSpot, Notion pour suivre vos clients.</p><div class="old-price">20-50‚Ç¨/mois</div></div></div><div style="text-align:center;margin-top:40px"><div style="font-size:15px;color:var(--muted)">Total moyen :</div><div style="font-size:36px;font-weight:900;color:var(--accent2);font-family:'JetBrains Mono',monospace;margin:8px 0">47 √† 115‚Ç¨/mois</div><div style="font-size:15px;color:var(--muted)">Chez workAI : <strong style="color:var(--accent);font-size:20px">15‚Ç¨/mois</strong>. Point.</div></div></div></section>
<section id="modules" style="text-align:center"><div class="container"><div class="section-tag">Votre logiciel</div><div class="section-title" style="max-width:700px;margin:0 auto 8px">Choisissez vos modules. Le prix ne change pas.</div><div style="margin-top:24px"><button class="select-all-btn" onclick="selectAllMods()">‚ú® Tout s√©lectionner ‚Äî m√™me prix</button></div><div class="modules-grid" id="modulesGrid"></div><div class="modules-summary" id="modulesSummary"></div></div></section>
<section id="demo-section"><div class="container" style="text-align:center"><div class="section-tag">D√©mo live</div><div class="section-title" style="max-width:700px;margin:0 auto 8px">Testez votre futur logiciel. Maintenant.</div><div class="demo-enter-box"><div style="font-size:48px;margin-bottom:16px">üñ•</div><h3 style="font-size:22px;font-weight:800;margin-bottom:8px">Entrez dans votre application</h3><p style="font-size:14px;color:var(--muted);margin-bottom:24px">Importez vos clients Excel, cr√©ez des factures, envoyez des campagnes, suivez vos formations.</p><button class="btn-primary" onclick="enterDemo()" style="font-size:18px;padding:18px 48px">Lancer la d√©mo ‚Üí</button></div></div></section>
<section id="pricing" style="text-align:center"><div class="container"><div class="section-tag">Tarif unique</div><div class="section-title">Un prix. Tous les modules. Votre marque.</div><div class="pricing-card"><div class="pricing-popular">Offre de lancement</div><div class="pricing-amount">15‚Ç¨<span>/mois</span></div><div class="pricing-setup">Mise en place : <strong>49‚Ç¨</strong> (une fois)</div><ul class="pricing-features"><li><span class="check">‚úì</span> Tous les modules inclus</li><li><span class="check">‚úì</span> Votre logo, couleurs, domaine</li><li><span class="check">‚úì</span> Livr√© en 3 jours</li><li><span class="check">‚úì</span> H√©berg√© et maintenu</li><li><span class="check">‚úì</span> Mises √† jour incluses</li><li><span class="check">‚úì</span> RGPD ‚Äî donn√©es en Europe</li></ul><a href="#founder" class="btn-primary" style="width:100%;justify-content:center">R√©server ma place ‚Üí</a><div class="pricing-compare"><div style="font-size:12px;font-weight:700;letter-spacing:1px;color:var(--accent2);margin-bottom:10px;text-transform:uppercase">Ailleurs vs nous</div><div class="line"><span>RDV</span><span class="them">25‚Ç¨</span><span class="us">Compris</span></div><div class="line"><span>CRM</span><span class="them">30‚Ç¨</span><span class="us">Compris</span></div><div class="line"><span>Factures</span><span class="them">20‚Ç¨</span><span class="us">Compris</span></div><div class="line"><span>Emailing</span><span class="them">25‚Ç¨</span><span class="us">Compris</span></div><div class="line"><span>E-learning</span><span class="them">50‚Ç¨</span><span class="us">Compris</span></div><div class="line" style="border-top:1px solid rgba(255,255,255,.06);padding-top:10px;margin-top:6px"><span style="font-weight:700">Total</span><span class="them" style="font-weight:700">150‚Ç¨/mois</span><span class="us" style="font-size:16px">15‚Ç¨/mois</span></div></div></div></div></section>
<section id="founder" style="text-align:center;background:linear-gradient(180deg,var(--surface),var(--bg));border-top:1px solid var(--border)"><div class="container"><div class="section-tag">Offre limit√©e</div><div class="section-title">50 fondateurs. Mise en place offerte.</div><div class="founder-box"><h3>üöÄ Offre Fondateur</h3><p>Acc√®s anticip√© au meilleur prix.</p><div style="text-align:left;margin-bottom:24px"><div class="perk"><span>üéÅ</span><span>Mise en place <strong>offerte</strong></span></div><div class="perk"><span>üí∞</span><span><strong>9‚Ç¨/mois</strong> pendant 6 mois</span></div><div class="perk"><span>üß©</span><span>Tous les modules inclus</span></div><div class="perk"><span>ü§ù</span><span>En √©change : votre avis honn√™te</span></div></div><div class="form-row"><input type="email" id="founderEmail" placeholder="votre@email.com"><button onclick="submitFounder()">Je r√©serve ‚Üí</button></div><div id="founderSpots" style="margin-top:16px;font-size:13px;color:var(--accent2);font-weight:600">üî• 47 places sur 50</div></div></div></section>
<footer>workAI ‚Äî Logiciel sur mesure √† prix cass√© ‚Äî 2026 ¬∑ <a href="/" style="color:var(--accent);text-decoration:none">Kaiden</a></footer>
</div>
<div id="demoApp"><div class="demo-topbar"><div style="display:flex;align-items:center"><button class="demo-back" onclick="exitDemo()">‚Üê workAI</button><div style="width:1px;height:24px;background:var(--border);margin:0 14px"></div><div style="display:flex;align-items:center;gap:10px"><div id="dBrandIcon" style="width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:var(--bg)">M</div><span style="font-size:15px;font-weight:700">Mon Entreprise</span></div></div><div style="display:flex;align-items:center;gap:10px"><span class="badge badge-g">D√©mo interactive</span><button onclick="toggleTheme()" id="themeToggle" style="width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s" title="Changer le th√®me">üåô</button><div class="av" id="dAvatar" style="width:32px;height:32px;font-size:12px">JD</div></div></div><div class="demo-branding"><span>üé® Branding :</span><div id="dSwatches" style="display:flex;gap:4px"></div></div><div class="demo-body"><div class="demo-sidebar" id="dSidebar"></div><div class="demo-main" id="dMain"></div></div></div>
<div id="modalRoot"></div><div id="toastRoot"></div>
<input type="file" id="xlsxInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleXLSX(event)">
<script>
// ===== MOBILE NAV =====
function toggleWNav(){document.getElementById('wNavLinks').classList.toggle('open');document.getElementById('wHamburger').classList.toggle('open')}
function closeWNav(){document.getElementById('wNavLinks').classList.remove('open');document.getElementById('wHamburger').classList.remove('open')}
// ===== STATE =====
let color='#00d4aa';const COLORS=[{n:"√âmeraude",h:"#00d4aa"},{n:"Saphir",h:"#3b82f6"},{n:"Corail",h:"#ff6b35"},{n:"Orchid√©e",h:"#a855f7"},{n:"Rose",h:"#ec4899"},{n:"Or",h:"#eab308"}];
const brand={logo:null,name:'Mon Entreprise',tagline:'',colors:{primary:'#00d4aa',secondary:'#1a1a2e',accent:'#eab308',text:'#e8e8ef'},font:'system'};
function extractColorsFromImage(img){
  const cv=document.createElement('canvas');const ctx=cv.getContext('2d');
  cv.width=img.naturalWidth||img.width;cv.height=img.naturalHeight||img.height;
  ctx.drawImage(img,0,0,cv.width,cv.height);
  const data=ctx.getImageData(0,0,cv.width,cv.height).data;
  const buckets={};const step=Math.max(1,Math.floor(data.length/4/2000));
  for(let i=0;i<data.length;i+=4*step){
    const r=data[i],g=data[i+1],b=data[i+2],a=data[i+3];
    if(a<128)continue;
    const lum=(r*0.299+g*0.587+b*0.114);
    if(lum<20||lum>235)continue;
    const qr=Math.round(r/32)*32,qg=Math.round(g/32)*32,qb=Math.round(b/32)*32;
    const key=qr+','+qg+','+qb;
    if(!buckets[key])buckets[key]={r:0,g:0,b:0,count:0};
    buckets[key].r+=r;buckets[key].g+=g;buckets[key].b+=b;buckets[key].count++;
  }
  const sorted=Object.values(buckets).sort((a,b)=>b.count-a.count);
  const palette=[];
  for(const b of sorted){
    if(palette.length>=5)break;
    const cr=Math.round(b.r/b.count),cg=Math.round(b.g/b.count),cb=Math.round(b.b/b.count);
    const hex='#'+[cr,cg,cb].map(v=>v.toString(16).padStart(2,'0')).join('');
    const sat=Math.max(cr,cg,cb)-Math.min(cr,cg,cb);
    const tooClose=palette.some(p=>{const pr=parseInt(p.slice(1,3),16),pg=parseInt(p.slice(3,5),16),pb=parseInt(p.slice(5,7),16);return Math.abs(pr-cr)+Math.abs(pg-cg)+Math.abs(pb-cb)<80;});
    if(!tooClose&&sat>25)palette.push(hex);
  }
  if(palette.length<2){
    const topB=sorted[0];if(topB){
      const cr=Math.round(topB.r/topB.count),cg=Math.round(topB.g/topB.count),cb=Math.round(topB.b/topB.count);
      palette.unshift('#'+[cr,cg,cb].map(v=>v.toString(16).padStart(2,'0')).join(''));
    }
  }
  return palette;
}
function handleLogoUpload(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    brand.logo=ev.target.result;
    const img=new Image();
    img.onload=function(){
      const palette=extractColorsFromImage(img);
      if(palette.length>=1){
        brand.colors.primary=palette[0];color=palette[0];
        document.documentElement.style.setProperty('--user-color',palette[0]);
      }
      if(palette.length>=2)brand.colors.accent=palette[1];
      if(palette.length>=3)brand.colors.secondary=palette[2];
      renderDemo();renderSwatches();
      toast('üé® Logo charg√© ¬∑ '+palette.length+' couleurs extraites !');
      setTimeout(()=>{
        const el=document.getElementById('brandPalettePreview');
        if(el)el.style.opacity='1';
      },100);
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}
function applyBrandColor(hex){color=hex;brand.colors.primary=hex;renderDemo();toast('üé® Couleur appliqu√©e');}
function setBrandProp(prop,val){const keys=prop.split('.');let obj=brand;for(let i=0;i<keys.length-1;i++)obj=obj[keys[i]];obj[keys[keys.length-1]]=val;}
let curMod='dashboard',searchQ='',selectedDay=null;
let bizType='micro'; // micro | ei_reel | eurl | sasu
let bizConfig={name:'Mon Entreprise',siret:'123 456 789 00012',tvaNum:'FR 12 345678901',addr:'123 Rue de la Paix, 75000 Paris',email:'contact@monentreprise.fr',tel:'06 12 34 56 78',ape:'8559A',rcs:'',tvaRate:20,tvaFranchise:true,urssafRate:21.2,mentionEI:false};
let invTab='invoices'; // invoices | compta | dashboard
let expenses=[{id:1,date:'2026-02-10',desc:'H√©bergement site web',cat:'Services en ligne',amount:29,tva:5.8,mode:'CB',ref:'RE-001'},{id:2,date:'2026-02-01',desc:'Abonnement Canva Pro',cat:'Services en ligne',amount:12,tva:2.4,mode:'CB',ref:'RE-002'},{id:3,date:'2026-01-15',desc:'Fournitures bureau',cat:'Fournitures',amount:45,tva:9,mode:'CB',ref:'RE-003'}];
// CRM State
const CRM_STAGES=['Nouveau','Prospect','Qualifi√©','Client','VIP'];
const CRM_STAGE_COLORS={Nouveau:'#60a5fa',Prospect:'#eab308',Qualifi√©:'#a855f7',Client:'#00d4aa',VIP:'#ec4899'};
const CRM_SOURCES=['Site web','LinkedIn','Recommandation','√âv√©nement','Email','Autre'];
const CRM_ACTIONS=['‚Äî','üìû Rappeler','üìß Envoyer email','üîÑ Relancer','üìÖ Planifier RDV','üìù Envoyer devis','üéÅ Envoyer offre','‚úÖ Rien √† faire'];
const CRM_INTERESTS=['‚Äî','Coaching individuel','Coaching groupe','Formation compl√®te','Pack entreprise','E-book','Atelier','Abonnement mensuel'];
let crmView='list'; // list | kanban | detail
let crmFilter='all';
let crmSort='recent';
let crmDetail=null;
let crmDetailTab='info';
let contacts=[
  {id:1,init:"SL",name:"Sophie Laurent",email:"sophie@email.com",phone:"06 12 34 56 78",company:"Fleur de Vie",tags:["VIP","Coaching"],stage:"VIP",source:"Recommandation",value:1200,interest:"Coaching individuel",action:"üìÖ Planifier RDV",followUp:"2025-02-18",created:"2023-06-15",lastContact:"2025-02-12",note:"Tr√®s satisfaite du programme. Veut continuer en 2025. A recommand√© 2 nouvelles clientes. Int√©ress√©e aussi par le coaching groupe.",activity:[{type:"invoice",text:"Facture FAC-2026-012 pay√©e ‚Äî 200‚Ç¨",date:"2025-02-14"},{type:"appt",text:"Coaching individuel ‚Äî 14h00",date:"2025-02-14"},{type:"email",text:"Newsletter F√©vrier ouverte",date:"2025-02-10"},{type:"note",text:"Note modifi√©e",date:"2025-02-12"},{type:"appt",text:"Bilan trimestriel",date:"2025-01-15"}]},
  {id:2,init:"MP",name:"Marie Petit",email:"marie.petit@gmail.com",phone:"06 98 76 54 32",company:"",tags:["Formation"],stage:"Client",source:"Site web",value:580,interest:"Formation compl√®te",action:"üìû Rappeler",followUp:"2025-02-16",created:"2024-09-01",lastContact:"2025-02-10",note:"Inscrite au programme avanc√©. Tr√®s motiv√©e. A pay√© la premi√®re tranche. Reste 290‚Ç¨ √† encaisser √† la fin du module 3.",activity:[{type:"invoice",text:"Facture FAC-2026-011 en attente ‚Äî 580‚Ç¨",date:"2025-02-10"},{type:"email",text:"Offre Saint-Valentin ouverte",date:"2025-02-12"},{type:"appt",text:"Bilan trimestriel ‚Äî 10h00",date:"2025-02-15"}]},
  {id:3,init:"TD",name:"Thomas Durand",email:"t.durand@pro.fr",phone:"07 11 22 33 44",company:"Durand Conseil",tags:["Prospect"],stage:"Prospect",source:"LinkedIn",value:0,interest:"Pack entreprise",action:"üîÑ Relancer",followUp:"2025-02-17",created:"2025-01-28",lastContact:"2025-02-05",note:"Premier contact via LinkedIn. Int√©ress√© par le coaching entreprise pour ses 3 associ√©s. Budget √† valider en interne. Relancer lundi.",activity:[{type:"appt",text:"Consultation initiale ‚Äî 16h30",date:"2025-02-17"},{type:"email",text:"Email de prospection envoy√©",date:"2025-02-01"}]},
  {id:4,init:"CG",name:"Camille Garcia",email:"camille.g@mail.com",phone:"06 55 44 33 22",company:"",tags:["Coaching","Fid√®le"],stage:"Client",source:"Recommandation",value:420,interest:"Coaching individuel",action:"üìù Envoyer devis",followUp:"2025-02-20",created:"2024-03-10",lastContact:"2025-02-08",note:"Fid√®le depuis mars 2024. Toujours ponctuelle. Souhaite passer au rythme bi-mensuel. Lui envoyer nouveau devis.",activity:[{type:"invoice",text:"Devis DEV-2026-004 envoy√© ‚Äî 420‚Ç¨",date:"2025-02-12"},{type:"appt",text:"Coaching individuel",date:"2025-02-08"}]},
  {id:5,init:"LB",name:"Luc Bernard",email:"luc.b@entreprise.fr",phone:"07 66 77 88 99",company:"Bernard & Associ√©s",tags:["Entreprise"],stage:"Client",source:"√âv√©nement",value:960,interest:"Pack entreprise",action:"üìû Rappeler",followUp:"2025-02-19",created:"2024-07-20",lastContact:"2025-02-05",note:"Contrat annuel pour 4 collaborateurs. Veut ajouter 2 personnes au programme. Demander tarif groupe √† jour. Rdv pr√©vu le 22.",activity:[{type:"appt",text:"Coaching entreprise ‚Äî 09h00",date:"2025-02-22"},{type:"invoice",text:"Facture pay√©e ‚Äî 960‚Ç¨",date:"2025-01-15"}]},
  {id:6,init:"JM",name:"Julie Martin",email:"julie.m@startup.io",phone:"06 10 20 30 40",company:"TechStart",tags:["Prospect"],stage:"Qualifi√©",source:"Site web",value:0,interest:"E-book",action:"üîÑ Relancer",followUp:"2025-02-15",created:"2025-02-01",lastContact:"2025-02-11",note:"A t√©l√©charg√© l'e-book. Tr√®s engag√©e sur les emails. A cliqu√© 3 fois sur l'offre coaching. Relancer avec un appel d√©couverte gratuit.",activity:[{type:"email",text:"E-book t√©l√©charg√©",date:"2025-02-01"},{type:"email",text:"Newsletter ouverte + cliqu√©e",date:"2025-02-10"}]},
  {id:7,init:"PA",name:"Pierre Aubert",email:"p.aubert@corp.com",phone:"07 50 60 70 80",company:"Aubert Corp",tags:["Entreprise"],stage:"Nouveau",source:"LinkedIn",value:0,interest:"‚Äî",action:"üìß Envoyer email",followUp:"2025-02-15",created:"2025-02-13",lastContact:"2025-02-13",note:"",activity:[{type:"note",text:"Ajout√© depuis LinkedIn",date:"2025-02-13"}]},
];
let nextId=8,nextNoteId=10;
let appointments=[{id:1,contact:"Sophie Laurent",type:"Coaching individuel",date:14,time:"14:00",dur:"60 min",status:"Confirm√©",notes:"Suivi mensuel"},{id:2,contact:"Marie Petit",type:"Bilan trimestriel",date:15,time:"10:00",dur:"45 min",status:"En attente",notes:"R√©sultats Q4"},{id:3,contact:"Thomas Durand",type:"Consultation initiale",date:17,time:"16:30",dur:"30 min",status:"Confirm√©",notes:""},{id:4,contact:"Sophie Laurent",type:"Atelier groupe",date:14,time:"10:00",dur:"90 min",status:"Confirm√©",notes:"Bien-√™tre"},{id:5,contact:"Luc Bernard",type:"Coaching entreprise",date:22,time:"09:00",dur:"60 min",status:"Confirm√©",notes:""}];
let bookedSlots=new Set(["09:00","11:00"]);
let invFilter='all',openCtx=null;
const PAY_TERMS=[{v:'net30',l:'Net 30 jours'},{v:'net45',l:'Net 45 jours'},{v:'net60',l:'Net 60 jours'},{v:'immediate',l:'Paiement comptant'},{v:'custom',l:'Personnalis√©'}];
const UNITS=[{v:'',l:'‚Äî'},{v:'h',l:'Heure'},{v:'j',l:'Jour'},{v:'s√©ance',l:'S√©ance'},{v:'forfait',l:'Forfait'},{v:'mois',l:'Mois'},{v:'u',l:'Unit√©'}];
const SUBTYPES=[{v:'standard',l:'Standard'},{v:'acompte',l:'Acompte'},{v:'solde',l:'Solde'},{v:'avoir',l:'Avoir'}];
function nextInvNum(type){const prefix=type==='quote'?'DEV':'FAC';const existing=invoices.filter(i=>i.type===type&&i.num.startsWith(prefix+'-2026-'));const nums=existing.map(i=>parseInt(i.num.split('-').pop())||0);const next=nums.length?Math.max(...nums)+1:1;return prefix+'-2026-'+String(next).padStart(3,'0');}
let invoices=[{id:1,num:"FAC-2026-001",client:"Sophie Laurent",items:[{desc:"Coaching individuel",qty:2,price:60,unit:'s√©ance',remise:0},{desc:"Programme personnalis√©",qty:1,price:80,unit:'forfait',remise:0}],status:"Pay√©e",type:"invoice",subtype:"standard",date:"14/02/2026",due:"14/03/2026",siret:"123 456 789 00012",tva:"FR 12 345678901",addr:"123 Rue de la Paix, 75000 Paris",cAddr:"12 Avenue des Fleurs, 69000 Lyon",paidDate:"14/02/2026",payMode:"Virement",payTerms:"net30"},{id:2,num:"FAC-2026-002",client:"Marie Petit",items:[{desc:"Formation compl√®te",qty:1,price:580,unit:'forfait',remise:10}],status:"En attente",type:"invoice",subtype:"standard",date:"10/02/2026",due:"10/03/2026",siret:"123 456 789 00012",tva:"FR 12 345678901",addr:"123 Rue de la Paix, 75000 Paris",cAddr:"",payTerms:"net30"},{id:3,num:"FAC-2026-003",client:"Luc Bernard",items:[{desc:"Coaching entreprise",qty:3,price:320,unit:'mois',remise:0}],status:"Pay√©e",type:"invoice",subtype:"standard",date:"15/01/2026",due:"15/02/2026",siret:"123 456 789 00012",tva:"FR 12 345678901",addr:"123 Rue de la Paix, 75000 Paris",cAddr:"45 Bd Haussmann, 75009 Paris",paidDate:"28/01/2026",payMode:"Virement",payTerms:"net30"},{id:4,num:"FAC-2026-004",client:"Thomas Durand",items:[{desc:"Consultation initiale",qty:1,price:150,unit:'s√©ance',remise:0}],status:"En retard",type:"invoice",subtype:"standard",date:"20/01/2026",due:"20/02/2026",siret:"123 456 789 00012",tva:"FR 12 345678901",addr:"123 Rue de la Paix, 75000 Paris",cAddr:"",payTerms:"net30"},{id:5,num:"FAC-2026-005",client:"Camille Garcia",items:[{desc:"Pack coaching 5 s√©ances (acompte 30%)",qty:1,price:126,unit:'forfait',remise:0}],status:"Pay√©e",type:"invoice",subtype:"acompte",date:"12/02/2026",due:"28/02/2026",siret:"123 456 789 00012",tva:"FR 12 345678901",addr:"123 Rue de la Paix, 75000 Paris",cAddr:"",paidDate:"13/02/2026",payMode:"CB",payTerms:"immediate",linkedTo:"DEV-2026-001"},{id:6,num:"DEV-2026-001",client:"Camille Garcia",items:[{desc:"Pack coaching 5 s√©ances",qty:5,price:84,unit:'s√©ance',remise:0}],status:"Accept√©",type:"quote",date:"12/02/2026",due:"28/02/2026",siret:"123 456 789 00012",tva:"FR 12 345678901",addr:"123 Rue de la Paix, 75000 Paris",cAddr:""},{id:7,num:"DEV-2026-002",client:"Julie Martin",items:[{desc:"Coaching individuel",qty:10,price:60,unit:'h',remise:5},{desc:"Acc√®s plateforme e-learning",qty:1,price:120,unit:'forfait',remise:0}],status:"Devis envoy√©",type:"quote",date:"13/02/2026",due:"27/02/2026",siret:"123 456 789 00012",tva:"FR 12 345678901",addr:"123 Rue de la Paix, 75000 Paris",cAddr:""},{id:8,num:"AV-2026-001",client:"Sophie Laurent",items:[{desc:"Annulation 1 s√©ance coaching",qty:1,price:-60,unit:'s√©ance',remise:0}],status:"√âmis",type:"invoice",subtype:"avoir",date:"15/02/2026",due:"",siret:"123 456 789 00012",tva:"FR 12 345678901",addr:"123 Rue de la Paix, 75000 Paris",cAddr:"12 Avenue des Fleurs, 69000 Lyon",linkedTo:"FAC-2026-001"}];
// Email system
let emView='campaigns'; // campaigns | create | analytics
let emStep=1; // create wizard step 1-4
let emPreviewMode='desktop';
let campaigns=[
  {id:1,name:"Newsletter F√©vrier",subject:"üì¨ Les actus du mois",status:"sent",sentAt:"10 f√©v, 14:30",audience:"all",audienceCount:124,stats:{sent:124,opened:113,clicked:42,unsub:1},blocks:[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},\n\nVoici les nouveaut√©s de f√©vrier."},{type:"button",content:"Voir les nouveaut√©s ‚Üí"},{type:"footer",content:"Se d√©sabonner"}]},
  {id:2,name:"Offre Saint-Valentin",subject:"üíù -20% pour la Saint-Valentin",status:"sent",sentAt:"12 f√©v, 09:00",audience:"actif",audienceCount:98,stats:{sent:98,opened:91,clicked:38,unsub:0},blocks:[{type:"header",content:"Mon Entreprise"},{type:"image",content:""},{type:"text",content:"Bonjour {{prenom}},\n\nPour la Saint-Valentin, profitez de -20% sur toutes nos offres."},{type:"button",content:"J'en profite ‚Üí"},{type:"footer",content:"Se d√©sabonner"}]},
  {id:3,name:"Rappel formation",subject:"üéì Votre formation vous attend",status:"scheduled",scheduledAt:"16 f√©v, 10:00",audience:"formation",audienceCount:42,stats:{sent:0,opened:0,clicked:0,unsub:0},blocks:[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},\n\nVous n'avez pas encore termin√© votre formation. Reprenez l√† o√π vous en √©tiez !"},{type:"button",content:"Reprendre la formation ‚Üí"},{type:"footer",content:"Se d√©sabonner"}]},
  {id:4,name:"Prospection Q1",subject:"D√©couvrez nos services",status:"draft",audience:"prospect",audienceCount:18,stats:{sent:0,opened:0,clicked:0,unsub:0},blocks:[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},"},{type:"footer",content:"Se d√©sabonner"}]},
];
let curCampaign=null; // campaign being edited/viewed
let editBlocks=[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},\n\nVotre message ici."},{type:"button",content:"En savoir plus ‚Üí"},{type:"footer",content:"Se d√©sabonner"}];
let editSubject="",editName="",editAudience="all",editSchedule="now",editScheduleDate="",editABtest=false,editSubjectB="";
const TEMPLATES=[
  {name:"Newsletter",icon:"üì¨",blocks:[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},\n\nVoici les nouveaut√©s du mois."},{type:"image",content:""},{type:"text",content:"D√©couvrez nos derni√®res actualit√©s et offres exclusives."},{type:"button",content:"Lire la suite ‚Üí"},{type:"footer",content:"Se d√©sabonner"}]},
  {name:"Promotion",icon:"üéÅ",blocks:[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},\n\nOffre exclusive r√©serv√©e √† nos meilleurs clients."},{type:"button",content:"J'en profite ‚Üí"},{type:"divider",content:""},{type:"text",content:"Cette offre expire dans 48h."},{type:"footer",content:"Se d√©sabonner"}]},
  {name:"Bienvenue",icon:"üëã",blocks:[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},\n\nBienvenue ! Nous sommes ravis de vous compter parmi nous.\n\nVoici ce que vous pouvez faire d√®s maintenant :"},{type:"button",content:"Commencer ‚Üí"},{type:"text",content:"N'h√©sitez pas √† nous contacter si vous avez la moindre question."},{type:"footer",content:"Se d√©sabonner"}]},
  {name:"Relance",icon:"üîÑ",blocks:[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},\n\nCela fait un moment ! Vous nous manquez.\n\nRevenez d√©couvrir nos derni√®res nouveaut√©s."},{type:"button",content:"Revenir ‚Üí"},{type:"footer",content:"Se d√©sabonner"}]},
  {name:"√âv√©nement",icon:"üéâ",blocks:[{type:"header",content:"Mon Entreprise"},{type:"image",content:""},{type:"text",content:"Bonjour {{prenom}},\n\nVous √™tes invit√©(e) √† notre prochain √©v√©nement !"},{type:"button",content:"R√©server ma place ‚Üí"},{type:"text",content:"üìÖ Date : √† confirmer\nüìç Lieu : en ligne"},{type:"footer",content:"Se d√©sabonner"}]},
  {name:"Vide",icon:"üìù",blocks:[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Votre message..."},{type:"footer",content:"Se d√©sabonner"}]},
];
const AUDIENCES=[{id:"all",name:"Tous les contacts",icon:"üë•"},{id:"actif",name:"Clients actifs",icon:"‚úÖ"},{id:"prospect",name:"Prospects",icon:"üéØ"},{id:"vip",name:"VIP & Fid√®les",icon:"‚≠ê"},{id:"formation",name:"Inscrits formation",icon:"üéì"},{id:"recent",name:"Contacts r√©cents (7j)",icon:"üïê"}];
function getAudienceCount(id){const m={all:contacts.length,actif:contacts.filter(c=>c.stage==='Client'||c.stage==='VIP').length,prospect:contacts.filter(c=>c.stage==='Prospect'||c.stage==='Nouveau').length,vip:contacts.filter(c=>c.tags.some(t=>t==='VIP'||t==='Fid√®le')).length,formation:contacts.filter(c=>c.tags.includes('Formation')).length,recent:Math.min(contacts.length,3)};return m[id]||0;}
let learnView='list',editCourseId=null,editModuleId=null,previewStepIdx=0,previewModIdx=0,quizState={current:0,score:0,answered:[]};
const STEP_TYPES=[{v:'video',l:'üé¨ Vid√©o',icon:'üé¨'},{v:'text',l:'üìù Texte',icon:'üìù'},{v:'pdf',l:'üìÑ Document PDF',icon:'üìÑ'},{v:'quiz',l:'üß† Quiz',icon:'üß†'}];
let formations=[
{id:1,title:"Les Bases du Coaching",desc:"Formation compl√®te pour d√©buter en coaching professionnel. 6 modules progressifs avec vid√©os, exercices pratiques et quiz de validation.",thumb:"üéØ",status:"Publi√©",price:297,students:18,rating:4.8,created:"10/01/2026",modules:[
  {id:1,title:"Introduction",order:1,steps:[
    {id:1,type:'video',title:'Bienvenue dans la formation',content:'https://www.youtube.com/embed/dQw4w9WgXcQ',duration:'5:30',done:true},
    {id:2,type:'text',title:'Objectifs de la formation',content:'Cette formation va vous apprendre les bases du coaching professionnel. √Ä la fin, vous serez capable de mener une s√©ance de coaching structur√©e, d\'utiliser les outils fondamentaux, et d\'accompagner vos clients vers leurs objectifs.',done:true},
    {id:3,type:'pdf',title:'Guide de d√©marrage',content:'guide-coaching-bases.pdf',size:'2.4 Mo',done:true}
  ]},
  {id:2,title:"L'√©coute active",order:2,steps:[
    {id:4,type:'video',title:'Les 3 niveaux d\'√©coute',content:'https://www.youtube.com/embed/dQw4w9WgXcQ',duration:'12:45',done:true},
    {id:5,type:'text',title:'Exercice pratique',content:'Exercice : pendant votre prochaine conversation, concentrez-vous uniquement sur l\'√©coute. Ne pr√©parez pas votre r√©ponse. Notez ce que vous observez de diff√©rent dans l\'√©change.',done:false},
    {id:6,type:'quiz',title:'Quiz ‚Äî √âcoute active',questions:[
      {q:'Quel est le premier niveau d\'√©coute ?',opts:['L\'√©coute interne','L\'√©coute focalis√©e','L\'√©coute globale','L\'√©coute s√©lective'],correct:0},
      {q:'Que signifie "reformuler" en coaching ?',opts:['R√©p√©ter mot pour mot','R√©sumer avec ses propres mots','Poser une question','Donner un conseil'],correct:1}
    ],done:false}
  ]},
  {id:3,title:"Les questions puissantes",order:3,steps:[
    {id:7,type:'video',title:'L\'art du questionnement',content:'https://www.youtube.com/embed/dQw4w9WgXcQ',duration:'18:20',done:false},
    {id:8,type:'text',title:'Les 10 questions essentielles',content:'1. Qu\'est-ce qui est vraiment important pour toi ?\n2. Qu\'est-ce qui te retient ?\n3. Quel serait le premier pas ?\n4. Comment sauras-tu que tu as r√©ussi ?\n5. Que ferais-tu si tu n\'avais pas peur ?',done:false},
    {id:9,type:'pdf',title:'Fiche outil ‚Äî Questions',content:'fiche-questions.pdf',size:'890 Ko',done:false}
  ]},
  {id:4,title:"Structurer une s√©ance",order:4,steps:[
    {id:10,type:'video',title:'Le mod√®le GROW',content:'https://www.youtube.com/embed/dQw4w9WgXcQ',duration:'22:10',done:false},
    {id:11,type:'text',title:'Template de s√©ance',content:'G ‚Äî Goal : Objectif de la s√©ance\nR ‚Äî Reality : Situation actuelle\nO ‚Äî Options : Possibilit√©s\nW ‚Äî Will : Plan d\'action',done:false},
    {id:12,type:'quiz',title:'Quiz ‚Äî Mod√®le GROW',questions:[
      {q:'Que repr√©sente le G dans GROW ?',opts:['Growth','Goal','Guide','Ground'],correct:1},
      {q:'√Ä quelle √©tape explore-t-on les options ?',opts:['Reality','Goal','Options','Will'],correct:2},
      {q:'Que fait-on √† l\'√©tape Will ?',opts:['Fixer l\'objectif','Analyser','Explorer','D√©finir le plan d\'action'],correct:3}
    ],done:false}
  ]}
]},
{id:2,title:"Programme Avanc√© ‚Äî Coaching d'√©quipe",desc:"Techniques avanc√©es pour le coaching de groupes et d'√©quipes en entreprise.",thumb:"üöÄ",status:"Publi√©",price:497,students:12,rating:4.9,created:"15/01/2026",modules:[
  {id:1,title:"Dynamique de groupe",order:1,steps:[
    {id:1,type:'video',title:'Comprendre les dynamiques',content:'',duration:'15:00',done:false},
    {id:2,type:'text',title:'Les r√¥les en √©quipe',content:'Selon Belbin, il existe 9 r√¥les cl√©s dans une √©quipe...',done:false}
  ]},
  {id:2,title:"Facilitation",order:2,steps:[
    {id:3,type:'video',title:'Techniques de facilitation',content:'',duration:'20:00',done:false},
    {id:4,type:'pdf',title:'Guide du facilitateur',content:'guide-facilitation.pdf',size:'3.1 Mo',done:false}
  ]}
]},
{id:3,title:"Masterclass VIP",desc:"Contenu exclusif r√©serv√© aux membres premium. √âtudes de cas r√©els et supervision.",thumb:"üëë",status:"Brouillon",price:0,students:8,rating:0,created:"01/02/2026",modules:[
  {id:1,title:"√âtude de cas #1",order:1,steps:[
    {id:1,type:'video',title:'Cas : reconversion professionnelle',content:'',duration:'35:00',done:false},
    {id:2,type:'text',title:'Analyse et debrief',content:'Points cl√©s de cette s√©ance...',done:false}
  ]}
]}
];
const formLearners=[
{fid:1,name:'Sophie Laurent',email:'sophie@email.com',avatar:'SL',enrolled:'12/01/2026',lastActive:'14/02/2026',progress:75,currentModule:'Les questions puissantes',currentStep:'L\'art du questionnement',quizScore:100,status:'active'},
{fid:1,name:'Marie Petit',email:'marie@email.com',avatar:'MP',enrolled:'15/01/2026',lastActive:'13/02/2026',progress:50,currentModule:'L\'√©coute active',currentStep:'Exercice pratique',quizScore:null,status:'active'},
{fid:1,name:'Luc Bernard',email:'luc@email.com',avatar:'LB',enrolled:'18/01/2026',lastActive:'10/02/2026',progress:100,currentModule:'Termin√©',currentStep:'‚Äî',quizScore:92,status:'completed'},
{fid:1,name:'Thomas Durand',email:'thomas@email.com',avatar:'TD',enrolled:'20/01/2026',lastActive:'28/01/2026',progress:25,currentModule:'Introduction',currentStep:'Guide de d√©marrage',quizScore:null,status:'inactive'},
{fid:1,name:'Camille Garcia',email:'camille@email.com',avatar:'CG',enrolled:'01/02/2026',lastActive:'15/02/2026',progress:62,currentModule:'L\'√©coute active',currentStep:'Quiz ‚Äî √âcoute active',quizScore:50,status:'active'},
{fid:1,name:'Julie Martin',email:'julie@email.com',avatar:'JM',enrolled:'03/02/2026',lastActive:'14/02/2026',progress:87,currentModule:'Structurer une s√©ance',currentStep:'Le mod√®le GROW',quizScore:100,status:'active'},
{fid:2,name:'Sophie Laurent',email:'sophie@email.com',avatar:'SL',enrolled:'01/02/2026',lastActive:'12/02/2026',progress:50,currentModule:'Dynamique de groupe',currentStep:'Les r√¥les en √©quipe',quizScore:null,status:'active'},
{fid:2,name:'Luc Bernard',email:'luc@email.com',avatar:'LB',enrolled:'01/02/2026',lastActive:'11/02/2026',progress:25,currentModule:'Dynamique de groupe',currentStep:'Comprendre les dynamiques',quizScore:null,status:'active'},
{fid:3,name:'Julie Martin',email:'julie@email.com',avatar:'JM',enrolled:'05/02/2026',lastActive:'14/02/2026',progress:0,currentModule:'Pas commenc√©',currentStep:'‚Äî',quizScore:null,status:'active'}
];
const qualiopiConfig={
1:{enabled:true,posQuiz:true,minScore:70,satisfactionSurvey:true,emargement:true,prerequis:'Aucun pr√©requis technique. Ouvert √† toute personne souhaitant d√©couvrir le coaching.',objectifs:['Ma√Ætriser les fondamentaux du coaching','Conduire un entretien de coaching de 45 min','Utiliser les techniques de questionnement','Structurer un accompagnement complet'],modalites:'Formation 100% en ligne, asynchrone. Vid√©os, exercices pratiques, quiz de validation par module. √âvaluation finale avec score minimum de 70%.'},
2:{enabled:true,posQuiz:true,minScore:75,satisfactionSurvey:true,emargement:true,prerequis:'Avoir suivi "Les Bases du Coaching" ou justifier de 50h de pratique.',objectifs:['Animer des s√©ances de coaching collectif','G√©rer les dynamiques de groupe','Faciliter des ateliers collaboratifs'],modalites:'Formation en ligne avec √©tudes de cas vid√©o et exercices de facilitation.'},
3:{enabled:false,posQuiz:false,minScore:60,satisfactionSurvey:false,emargement:false,prerequis:'',objectifs:[],modalites:''}
};
const qualiopiTracking={
1:[
{name:'Sophie Laurent',posScore:65,finalScore:82,satisfaction:9,emargements:['12/01 09:14','15/01 14:22','20/01 10:05','28/01 16:33','05/02 11:12','14/02 09:45'],completedAt:null},
{name:'Marie Petit',posScore:40,finalScore:null,satisfaction:null,emargements:['15/01 10:00','22/01 14:15','01/02 09:30','13/02 11:00'],completedAt:null},
{name:'Luc Bernard',posScore:55,finalScore:88,satisfaction:10,emargements:['18/01 08:45','22/01 10:30','27/01 14:00','02/02 09:15','06/02 11:30','08/02 14:00','10/02 16:45'],completedAt:'10/02/2026'},
{name:'Thomas Durand',posScore:30,finalScore:null,satisfaction:null,emargements:['20/01 10:00','28/01 14:30'],completedAt:null},
{name:'Camille Garcia',posScore:45,finalScore:null,satisfaction:null,emargements:['01/02 09:00','05/02 11:30','10/02 14:00','15/02 10:15'],completedAt:null},
{name:'Julie Martin',posScore:70,finalScore:null,satisfaction:null,emargements:['03/02 08:30','06/02 10:00','09/02 14:30','11/02 09:00','13/02 11:15','14/02 16:00'],completedAt:null}
],
2:[
{name:'Sophie Laurent',posScore:72,finalScore:null,satisfaction:null,emargements:['01/02 09:00','05/02 14:00','12/02 10:30'],completedAt:null},
{name:'Luc Bernard',posScore:68,finalScore:null,satisfaction:null,emargements:['01/02 09:00','11/02 14:30'],completedAt:null}
]
};
let cart=[],promoCode='',promoApplied=false;
const PRODUCTS=[{id:1,name:"Coaching 1h",price:60,sold:18,stock:50,cat:"Service"},{id:2,name:"Pack 5 s√©ances",price:250,sold:8,stock:20,cat:"Service"},{id:3,name:"E-book Bien-√™tre",price:19,sold:42,stock:999,cat:"Digital"},{id:4,name:"Atelier groupe",price:35,sold:24,stock:15,cat:"√âv√©nement"}];
const PROMOS={WORKAI10:{type:'pct',val:10},BIENVENUE:{type:'fixed',val:5}};
const MODS_DATA=[{id:"appointments",icon:"üìÖ",name:"Prise de rendez-vous",desc:"Calendrier, booking, rappels"},{id:"contacts",icon:"üìá",name:"CRM & Contacts",desc:"Fiches client, tags, suivi"},{id:"invoices",icon:"üßæ",name:"Devis & Factures",desc:"PDF, paiements, l√©gal"},{id:"planning",icon:"üìã",name:"Planning & Agenda",desc:"Vue semaine/mois"},{id:"emailing",icon:"üìß",name:"Emailing",desc:"Campagnes, templates"},{id:"elearning",icon:"üéì",name:"E-learning",desc:"Cours, quiz, certificats"},{id:"ecommerce",icon:"üõçÔ∏è",name:"Catalogue & Ventes",desc:"Produits, panier, promos"},{id:"dashboard",icon:"üìä",name:"Dashboard & Stats",desc:"CA, objectifs, activit√©"},{id:"notifications",icon:"üîî",name:"Notifications",desc:"Email, SMS, rappels"},{id:"files",icon:"üìÅ",name:"Gestion de fichiers",desc:"Documents, stockage"}];
let selectedMods=new Set();
const FEED=[{icon:"üí∞",text:"Sophie Laurent a pay√© FAC-2026-012",time:"il y a 5 min",color:"#00d4aa"},{icon:"üìÖ",text:"Nouveau RDV r√©serv√© ‚Äî Marie Petit",time:"il y a 23 min",color:"#3b82f6"},{icon:"üìß",text:"Campagne \"Offre sp√©ciale\" envoy√©e",time:"il y a 1h",color:"#a855f7"},{icon:"üéì",text:"Thomas a termin√© le module 2",time:"il y a 2h",color:"#eab308"},{icon:"üõçÔ∏è",text:"Nouvelle commande E-book ‚Äî 19‚Ç¨",time:"il y a 3h",color:"#ec4899"},{icon:"üìá",text:"3 contacts import√©s depuis Excel",time:"il y a 5h",color:"#ff6b35"}];
const OBJECTIVES=[{name:"CA mensuel",current:4280,target:5000},{name:"Nouveaux clients",current:3,target:5},{name:"Formations compl√©t√©es",current:7,target:10}];
// ===== UTILS =====
function setC(h){color=h;brand.colors.primary=h;document.documentElement.style.setProperty('--accent',h);renderDemo();renderSwatches();}
function toast(m,t='success'){const el=document.createElement('div');el.className='toast toast-'+t;el.innerHTML=m;document.getElementById('toastRoot').appendChild(el);setTimeout(()=>el.remove(),3000);}
function closeModal(){document.getElementById('modalRoot').innerHTML='';}
function showModal(h,lg){document.getElementById('modalRoot').innerHTML=`<div class="modal-overlay" onclick="if(event.target===this)closeModal()"><div class="modal ${lg?'modal-lg':''}">${h}</div></div>`;}
function invTotal(items){return items.reduce((a,l)=>{const base=(l.qty||0)*(Math.abs(l.price)||0);const rem=l.remise?base*l.remise/100:0;return a+(l.price<0?-(base-rem):base-rem);},0);}
function lineTotal(l){const base=(l.qty||0)*(Math.abs(l.price)||0);const rem=l.remise?base*l.remise/100:0;return l.price<0?-(base-rem):base-rem;}
function getInit(n){return n.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);}
function getApptsForDay(d){return appointments.filter(a=>a.date===d);}
function searchInput(val){searchQ=val;renderDemo();const el=document.getElementById('crmSearch');if(el){el.focus();el.setSelectionRange(el.value.length,el.value.length);}}
function toggleCtx(id,e){e&&e.stopPropagation();if(openCtx===id){openCtx=null;}else{openCtx=id;}renderDemo();if(openCtx){setTimeout(()=>document.addEventListener('click',closeCtx,{once:true}),10);}}function closeCtx(){openCtx=null;renderDemo();}
// ===== LANDING =====
function renderLandingMods(){
  document.getElementById('modulesGrid').innerHTML=MODS_DATA.map(m=>`<div class="module-card ${selectedMods.has(m.id)?'selected':''}" onclick="toggleMod('${m.id}')"><div class="m-icon">${m.icon}</div><div class="m-name">${m.name}</div><div class="m-desc">${m.desc}</div></div>`).join('');
  const b=document.getElementById('modulesSummary');
  if(!selectedMods.size){b.innerHTML='<div style="font-size:15px;color:var(--muted);text-align:center">S√©lectionnez des modules</div>';return;}
  const it=MODS_DATA.filter(m=>selectedMods.has(m.id));
  b.innerHTML=`<div style="font-size:14px;color:var(--muted);margin-bottom:8px"><span style="color:var(--accent);font-weight:700">${it.length}</span> modules</div>${it.map(m=>`<div style="display:flex;justify-content:space-between;padding:5px 0;font-size:14px"><span style="color:var(--muted)">${m.icon} ${m.name}</span><span style="color:var(--accent);font-weight:600">Compris ‚úì</span></div>`).join('')}<div style="height:1px;background:rgba(255,255,255,.06);margin:12px 0"></div><div style="display:flex;justify-content:space-between;align-items:baseline"><span style="font-weight:600">Tarif</span><span><span style="font-size:32px;font-weight:900;color:var(--accent);font-family:'JetBrains Mono',monospace">15‚Ç¨</span><span style="color:var(--muted)">/mois</span></span></div><div style="text-align:center;margin-top:16px"><a href="#founder" class="btn-primary" style="display:inline-flex">Offre Fondateur ‚Üí</a></div>`;
}
function toggleMod(id){selectedMods.has(id)?selectedMods.delete(id):selectedMods.add(id);renderLandingMods();}
function selectAllMods(){selectedMods.size===MODS_DATA.length?selectedMods.clear():MODS_DATA.forEach(m=>selectedMods.add(m.id));renderLandingMods();}
function submitFounder(){const e=document.getElementById('founderEmail');if(!e.value||!e.value.includes('@'))return;fetch('/api/lead-capture',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prenom:'',email:e.value,source:'workAI Fondateur'})}).catch(()=>{});document.getElementById('founderSpots').innerHTML='‚úÖ Vous √™tes sur la liste !';document.getElementById('founderSpots').style.color='var(--accent)';e.value='';toast('üéâ Inscription confirm√©e !');}
// ===== DEMO CORE =====
function enterDemo(){document.getElementById('landingPage').style.display='none';document.getElementById('demoApp').classList.add('visible');document.body.style.overflow='hidden';renderDemo();renderSwatches();}
function exitDemo(){document.getElementById('demoApp').classList.remove('visible');document.getElementById('landingPage').style.display='';document.body.style.overflow='';}
let darkMode=true;
function toggleTheme(){darkMode=!darkMode;document.documentElement.classList.toggle('light',!darkMode);document.getElementById('themeToggle').textContent=darkMode?'üåô':'‚òÄÔ∏è';document.getElementById('themeToggle').title=darkMode?'Passer en mode clair':'Passer en mode sombre';renderDemo();}
function renderSwatches(){const brandC=brand.logo?[brand.colors.primary,brand.colors.accent,brand.colors.secondary].filter(c=>c&&c!=='#1a1a2e'):[];const bHtml=brandC.map(c=>`<div class="swatch ${color===c?'active':''}" style="background:${c};box-shadow:0 0 0 1px rgba(255,255,255,.2)" onclick="setC('${c}')" title="Extrait du logo"></div>`).join('');const sep=brandC.length?'<div style="width:1px;height:16px;background:var(--border);margin:0 2px"></div>':'';document.getElementById('dSwatches').innerHTML=bHtml+sep+COLORS.map(c=>`<div class="swatch ${color===c.h?'active':''}" style="background:${c.h}" onclick="setC('${c.h}')"></div>`).join('');}
const SB=[{s:"Socle",items:[{id:"dashboard",icon:"üìä",name:"Dashboard"},{id:"contacts",icon:"üìá",name:"Contacts"}]},{s:"Modules",items:[{id:"appointments",icon:"üìÖ",name:"Rendez-vous"},{id:"invoices",icon:"üßæ",name:"Factures"},{id:"emailing",icon:"üìß",name:"Emailing"},{id:"elearning",icon:"üéì",name:"E-learning"},{id:"ecommerce",icon:"üõçÔ∏è",name:"Boutique"},{id:"files",icon:"üìÅ",name:"Fichiers"}]},{s:"Config",items:[{id:"settings",icon:"‚öôÔ∏è",name:"Param√®tres"}]}];
function renderDemo(){
  let sb='';SB.forEach(sec=>{sb+=`<div class="s-section">${sec.s}</div>`;sec.items.forEach(it=>{const bdg=it.id==='contacts'?`<span class="s-badge">${contacts.length}</span>`:it.id==='appointments'?`<span class="s-badge">${appointments.length}</span>`:it.id==='invoices'?`<span class="s-badge">${invoices.length}</span>`:it.id==='ecommerce'&&cart.length?`<span class="s-badge">${cart.length}</span>`:'';sb+=`<div class="s-item ${curMod===it.id?'active':''}" onclick="curMod='${it.id}';selectedDay=null;if('${it.id}'==='contacts'&&crmView==='detail'){crmView='list';crmDetail=null;}renderDemo()"><span style="font-size:17px;width:22px;text-align:center">${it.icon}</span><span>${it.name}</span>${bdg}</div>`;});});
  document.getElementById('dSidebar').innerHTML=sb;
  document.getElementById('dBrandIcon').style.background=brand.logo?'transparent':color;
  document.getElementById('dBrandIcon').style.color='#fff';
  document.getElementById('dBrandIcon').innerHTML=brand.logo?'<img src="'+brand.logo+'" style="width:100%;height:100%;object-fit:contain;border-radius:8px">':'M';
  document.getElementById('dAvatar').style.background=color;
  document.getElementById('dAvatar').style.color='#fff';
  const brandNameEl=document.getElementById('dBrandIcon')?.nextElementSibling;
  if(brandNameEl&&brandNameEl.tagName==='SPAN')brandNameEl.textContent=brand.name||'Mon Entreprise';
  const R={dashboard:pgDash,contacts:pgContacts,appointments:pgAppts,invoices:pgInvoices,emailing:pgEmail,elearning:pgLearn,ecommerce:pgShop,files:pgFiles,settings:pgSettings};
  document.getElementById('dMain').innerHTML=(R[curMod]||pgDash)();
  setTimeout(()=>{document.querySelectorAll('[id^="pdf_"]').forEach(el=>{if(!el.id.includes('_pg')&&!el.innerHTML.trim()){el.dataset.page='0';el.innerHTML=PDF_PAGES[0];}});},0);
}
// ===== DASHBOARD =====
function pgDash(){
  const rev=invoices.reduce((a,b)=>a+invTotal(b.items),0);
  return `<div class="page-head"><h1>Dashboard</h1><p>Vue d'ensemble de votre activit√©</p></div>
  <div class="stats"><div class="stat"><div class="s-label">Chiffre d'affaires</div><div class="s-value" style="color:${color}">${rev.toLocaleString()}‚Ç¨</div><div class="s-change up">‚Üë +12%</div></div><div class="stat"><div class="s-label">Clients</div><div class="s-value">${contacts.length}</div><div class="s-change up">‚Üë +3</div></div><div class="stat"><div class="s-label">RDV ce mois</div><div class="s-value">${appointments.length}</div></div><div class="stat"><div class="s-label">En attente</div><div class="s-value" style="color:var(--accent2)">${invoices.filter(i=>i.status==='En attente').length}</div></div></div>
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px">
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)"><div style="font-size:13px;font-weight:700;margin-bottom:10px">CA ‚Äî 6 derniers mois</div><div class="chart-bars">${[65,45,72,58,85,92].map((v,i)=>`<div class="chart-bar-w"><div class="chart-val" style="color:${color}">${v*47}‚Ç¨</div><div class="chart-bar" style="height:${v}%;background:${color}${i===5?'':'40'}"></div><div class="chart-lab">${['Sep','Oct','Nov','D√©c','Jan','F√©v'][i]}</div></div>`).join('')}</div></div>
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">üéØ Objectifs du mois</div>
      ${OBJECTIVES.map(o=>{const pct=Math.min(100,Math.round(o.current/o.target*100));return`<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span style="color:var(--muted)">${o.name}</span><span style="font-weight:700;color:${pct>=100?color:'var(--text)'}">${o.current}/${o.target}</span></div><div class="obj-bar"><div class="obj-fill" style="width:${pct}%;background:${pct>=100?color:pct>60?'#3b82f6':'var(--accent2)'}"></div></div></div>`;}).join('')}
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;margin-bottom:10px"><div style="font-size:13px;font-weight:700">üìã Prochains RDV</div><button onclick="curMod='appointments';renderDemo()" style="background:none;border:none;color:${color};font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">Voir tout ‚Üí</button></div>
      <table class="dt"><tbody>${appointments.slice(0,3).map(a=>`<tr><td><span class="av" style="background:${color}">${getInit(a.contact)}</span>${a.contact}</td><td style="color:var(--muted)">${a.date} f√©v, ${a.time}</td><td><span class="badge badge-${a.status==='Confirm√©'?'g':'o'}">${a.status}</span></td></tr>`).join('')}</tbody></table>
    </div>
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">‚ö° Activit√© r√©cente</div>
      ${FEED.map(f=>`<div class="feed-item"><div class="feed-dot" style="background:${f.color}"></div><div><div class="feed-text">${f.icon} ${f.text}</div><div class="feed-time">${f.time}</div></div></div>`).join('')}
    </div>
  </div>`;
}
// ===== CRM ‚Äî TERRAIN FIRST =====
function pgContacts(){
  if(crmView==='detail'&&crmDetail)return pgCrmDetail();
  if(crmView==='kanban')return pgCrmKanban();
  return pgCrmList();
}
function crmFiltered(){
  let f=contacts;
  if(crmFilter!=='all')f=f.filter(c=>c.stage===crmFilter);
  if(searchQ)f=f.filter(c=>c.name.toLowerCase().includes(searchQ.toLowerCase())||c.email.toLowerCase().includes(searchQ.toLowerCase())||(c.company||'').toLowerCase().includes(searchQ.toLowerCase()));
  if(crmSort==='name')f=[...f].sort((a,b)=>a.name.localeCompare(b.name));
  else if(crmSort==='value')f=[...f].sort((a,b)=>b.value-a.value);
  else if(crmSort==='followup')f=[...f].sort((a,b)=>new Date(a.followUp||'2099-01-01')-new Date(b.followUp||'2099-01-01'));
  else f=[...f].sort((a,b)=>new Date(b.lastContact)-new Date(a.lastContact));
  return f;
}
function daysLabel(d){if(!d)return'‚Äî';const diff=Math.floor((Date.now()-new Date(d))/(864e5));return diff===0?"Aujourd'hui":diff===1?'Hier':diff+'j';}
function daysUntil(d){if(!d)return null;const diff=Math.floor((new Date(d)-Date.now())/(864e5));return diff;}
function fuColor(d){const du=daysUntil(d);if(du===null)return'#555';if(du<0)return'var(--accent2)';if(du===0)return color;if(du<=2)return'#eab308';return'var(--muted)';}
function fuLabel(d){if(!d)return'‚Äî';const du=daysUntil(d);if(du<0)return'‚ö† En retard';if(du===0)return"Aujourd'hui";if(du===1)return'Demain';return new Date(d).toLocaleDateString('fr-FR',{day:'numeric',month:'short'});}
function pgCrmList(){
  const f=crmFiltered();const totalValue=contacts.reduce((a,c)=>a+c.value,0);
  const urgent=contacts.filter(c=>{const du=daysUntil(c.followUp);return du!==null&&du<=0&&c.action&&c.action!=='‚Äî'&&c.action!=='‚úÖ Rien √† faire';}).length;
  return `<div class="page-head"><h1>CRM</h1><p>${contacts.length} contacts ¬∑ ${totalValue.toLocaleString()}‚Ç¨ ¬∑ <span style="color:${urgent?'var(--accent2)':color}">${urgent} relance${urgent>1?'s':''} urgente${urgent>1?'s':''}</span></p></div>
  <div class="stats" style="grid-template-columns:repeat(${CRM_STAGES.length},1fr);margin-bottom:14px">${CRM_STAGES.map(s=>{const cnt=contacts.filter(c=>c.stage===s).length;return`<div class="stat" style="cursor:pointer;${crmFilter===s?'border-color:'+CRM_STAGE_COLORS[s]:''}" onclick="crmFilter=crmFilter==='${s}'?'all':'${s}';renderDemo()"><div class="s-label" style="display:flex;align-items:center;gap:4px"><span style="width:6px;height:6px;border-radius:50%;background:${CRM_STAGE_COLORS[s]}"></span>${s}</div><div class="s-value">${cnt}</div></div>`;}).join('')}</div>
  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
    <input id="crmSearch" style="flex:1;min-width:200px;padding:10px 16px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px;font-family:inherit;outline:none" placeholder="üîç Rechercher un contact..." value="${searchQ}" oninput="searchInput(this.value)">
    <div style="display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--border)">${[{v:'list',l:'‚ò∞ Liste'},{v:'kanban',l:'‚ó´ Kanban'}].map(v=>`<button onclick="crmView='${v.v}';renderDemo()" style="padding:8px 14px;border:none;font-size:12px;cursor:pointer;font-family:inherit;${crmView===v.v?'background:'+color+';color:var(--bg);font-weight:700':'background:var(--card);color:var(--muted)'}">${v.l}</button>`).join('')}</div>
    <select onchange="crmSort=this.value;renderDemo()" style="padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;font-family:inherit;outline:none"><option value="recent" ${crmSort==='recent'?'selected':''}>R√©cents</option><option value="followup" ${crmSort==='followup'?'selected':''}>Relance ‚Üë</option><option value="name" ${crmSort==='name'?'selected':''}>Nom A-Z</option><option value="value" ${crmSort==='value'?'selected':''}>Valeur ‚Üì</option></select>
    <button onclick="modalAddContact()" style="padding:9px 18px;border-radius:10px;border:none;background:${color};color:var(--bg);font-weight:700;font-size:13px;cursor:pointer;font-family:inherit">+ Nouveau</button>
    <button onclick="document.getElementById('xlsxInput').click()" style="padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;cursor:pointer;font-family:inherit">üì•</button>
  </div>
  <div style="display:flex;flex-direction:column;gap:6px">
  ${f.map(c=>{const sc=CRM_STAGE_COLORS[c.stage]||color;const fuC=fuColor(c.followUp);const fuL=fuLabel(c.followUp);const isLate=daysUntil(c.followUp)!==null&&daysUntil(c.followUp)<=0&&c.action!=='‚Äî'&&c.action!=='‚úÖ Rien √† faire';
  return`<div style="border-radius:12px;background:var(--card);border:1px solid var(--border);${isLate?'border-left:3px solid var(--accent2)':''}">
    <div style="padding:10px 14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:13px">
      <span class="av" style="background:${sc};width:34px;height:34px;font-size:12px;flex-shrink:0">${c.init}</span>
      <span style="font-weight:700;font-size:14px;min-width:120px;cursor:pointer" onclick="openDetail(${c.id})">${c.name}</span>
      <span style="color:var(--muted);min-width:120px">üì± ${c.phone}</span>
      <span style="color:var(--muted);min-width:140px;font-size:12px">üìß ${c.email}</span>
      <span class="badge badge-click" style="background:${sc}18;color:${sc};border:1px solid ${sc}30;font-size:11px" onclick="cycleStage(${c.id})">${c.stage}</span>
      <select onchange="updateField(${c.id},'interest',this.value)" style="padding:3px 6px;border-radius:5px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none;max-width:150px">${CRM_INTERESTS.map(i=>`<option ${c.interest===i?'selected':''}>${i}</option>`).join('')}</select>
      <select onchange="updateField(${c.id},'action',this.value)" style="padding:3px 6px;border-radius:5px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none;max-width:150px">${CRM_ACTIONS.map(a=>`<option ${c.action===a?'selected':''}>${a}</option>`).join('')}</select>
      <span style="display:flex;align-items:center;gap:4px"><input type="date" value="${c.followUp||''}" onchange="updateField(${c.id},'followUp',this.value);renderDemo()" style="padding:3px 6px;border-radius:5px;border:1px solid var(--border);background:var(--bg);color:${fuC};font-size:12px;font-family:inherit;outline:none;font-weight:600;width:120px"><span style="color:${fuC};font-weight:600;font-size:12px;white-space:nowrap">${fuL}</span></span>
      <span style="color:var(--muted);font-size:12px;white-space:nowrap">üïê ${daysLabel(c.lastContact)}</span>
      ${c.value?`<span style="font-family:'JetBrains Mono',monospace;font-weight:700;color:${sc};font-size:13px;margin-left:auto">${c.value.toLocaleString()}‚Ç¨</span>`:''}
      <button onclick="openDetail(${c.id})" style="background:none;border:none;color:${color};cursor:pointer;font-size:12px;font-weight:600;font-family:inherit;margin-left:${c.value?'0':'auto'}">Fiche‚Üí</button>
    </div>
    <div style="padding:4px 14px 10px 58px;display:flex;align-items:center;gap:8px">
      <textarea onchange="updateField(${c.id},'note',this.value)" style="flex:1;padding:5px 10px;border-radius:6px;border:1px solid transparent;background:transparent;color:var(--muted);font-size:13px;font-family:inherit;outline:none;resize:none;line-height:1.5;height:22px;overflow:hidden;transition:all .2s" onfocus="this.style.borderColor='${color}40';this.style.background='var(--bg)';this.style.color='var(--text)';this.style.height='auto';this.style.minHeight='48px'" onblur="this.style.borderColor='transparent';this.style.background='transparent';this.style.color='var(--muted)';this.style.height='22px';this.style.minHeight='22px'" placeholder="Note...">${c.note||''}</textarea>
      ${c.tags.length?`<div style="display:flex;gap:3px;flex-shrink:0">${c.tags.map(t=>`<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg);color:var(--muted)">${t}</span>`).join('')}</div>`:''}
    </div>
  </div>`;}).join('')}
  </div>
  ${f.length===0?'<div style="padding:40px;text-align:center;color:var(--muted);font-size:14px">Aucun contact trouv√©</div>':''}
  <div class="drop-zone" style="margin-top:14px" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="event.preventDefault();this.classList.remove('drag');handleXLSXDrop(event)"><div class="dz-icon">üìä</div><div class="dz-text">Glissez un fichier Excel pour importer</div><div class="dz-sub">.xlsx .xls .csv</div></div>`;
}
function pgCrmKanban(){
  const totalValue=contacts.reduce((a,c)=>a+c.value,0);
  const urgent=contacts.filter(c=>{const du=daysUntil(c.followUp);return du!==null&&du<=0&&c.action&&c.action!=='‚Äî'&&c.action!=='‚úÖ Rien √† faire';}).length;
  return `<div class="page-head"><h1>CRM</h1><p>${contacts.length} contacts ¬∑ ${totalValue.toLocaleString()}‚Ç¨ ¬∑ <span style="color:${urgent?'var(--accent2)':color}">${urgent} relances urgentes</span></p></div>
  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
    <input id="crmSearch" style="flex:1;min-width:200px;padding:10px 16px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px;font-family:inherit;outline:none" placeholder="üîç Rechercher..." value="${searchQ}" oninput="searchInput(this.value)">
    <div style="display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--border)">${[{v:'list',l:'‚ò∞ Liste'},{v:'kanban',l:'‚ó´ Kanban'}].map(v=>`<button onclick="crmView='${v.v}';renderDemo()" style="padding:8px 14px;border:none;font-size:12px;cursor:pointer;font-family:inherit;${crmView===v.v?'background:'+color+';color:var(--bg);font-weight:700':'background:var(--card);color:var(--muted)'}">${v.l}</button>`).join('')}</div>
    <button onclick="modalAddContact()" style="padding:9px 18px;border-radius:10px;border:none;background:${color};color:var(--bg);font-weight:700;font-size:13px;cursor:pointer;font-family:inherit">+ Nouveau</button>
  </div>
  <div style="display:flex;gap:10px;overflow-x:auto;padding-bottom:12px">
  ${CRM_STAGES.map(stage=>{const sc=CRM_STAGE_COLORS[stage];const cs=contacts.filter(c=>c.stage===stage).filter(c=>!searchQ||c.name.toLowerCase().includes(searchQ.toLowerCase()));const stageVal=cs.reduce((a,c)=>a+c.value,0);
  return`<div style="min-width:210px;flex:1;background:var(--card);border-radius:14px;border:1px solid var(--border);overflow:hidden">
    <div style="padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between"><div style="display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:${sc}"></span><span style="font-size:12px;font-weight:700">${stage}</span><span style="font-size:10px;color:var(--muted);background:var(--bg);padding:1px 6px;border-radius:4px">${cs.length}</span></div>${stageVal?`<span style="font-size:10px;font-weight:600;color:${sc};font-family:'JetBrains Mono',monospace">${stageVal.toLocaleString()}‚Ç¨</span>`:''}</div>
    <div style="padding:6px;max-height:500px;overflow-y:auto">
    ${cs.map(c=>{const fuC=fuColor(c.followUp);return`<div onclick="openDetail(${c.id})" style="padding:10px;border-radius:10px;background:var(--bg);border:1px solid var(--border);margin-bottom:6px;cursor:pointer;transition:all .2s;${daysUntil(c.followUp)!==null&&daysUntil(c.followUp)<=0?'border-left:2px solid var(--accent2)':''}" onmouseover="this.style.borderColor='${sc}40'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="font-size:13px;font-weight:600">${c.name}</div>
      ${c.company?`<div style="font-size:10px;color:var(--muted)">${c.company}</div>`:''}
      <div style="font-size:11px;color:var(--muted);margin-top:4px">üì± ${c.phone}</div>
      ${c.interest&&c.interest!=='‚Äî'?`<div style="font-size:10px;margin-top:4px;padding:2px 6px;border-radius:4px;background:${sc}10;color:${sc};display:inline-block">üéØ ${c.interest}</div>`:''}
      ${c.action&&c.action!=='‚Äî'&&c.action!=='‚úÖ Rien √† faire'?`<div style="font-size:10px;margin-top:4px;color:${fuC};font-weight:600">${c.action} ¬∑ ${fuLabel(c.followUp)}</div>`:''}
      ${c.note?`<div style="font-size:10px;color:#777;margin-top:4px;line-height:1.4;max-height:36px;overflow:hidden">${c.note.slice(0,80)}${c.note.length>80?'...':''}</div>`:''}
      ${c.value?`<div style="font-size:12px;font-weight:800;color:${sc};font-family:'JetBrains Mono',monospace;margin-top:4px">${c.value.toLocaleString()}‚Ç¨</div>`:''}
    </div>`;}).join('')}
    ${cs.length===0?'<div style="padding:20px;text-align:center;font-size:11px;color:#555">Vide</div>':''}
    </div>
  </div>`;}).join('')}
  </div>`;
}
// ===== CLIENT DETAIL =====
function openDetail(id){crmDetail=id;crmView='detail';crmDetailTab='info';renderDemo();}
function pgCrmDetail(){
  const c=contacts.find(x=>x.id===crmDetail);if(!c){crmView='list';return pgCrmList();}
  const sc=CRM_STAGE_COLORS[c.stage]||color;
  const cAppts=appointments.filter(a=>a.contact===c.name);
  const cInvs=invoices.filter(i=>i.client===c.name);
  const tabs=[{id:'info',l:'Infos',i:'üë§'},{id:'activity',l:'Activit√©',i:'‚ö°'},{id:'invoices',l:'Factures',i:'üßæ'}];
  return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:20px"><button onclick="crmView='list';crmDetail=null;renderDemo()" style="background:none;border:none;color:${color};cursor:pointer;font-size:13px;font-weight:600;font-family:inherit">‚Üê CRM</button><div style="width:1px;height:20px;background:var(--border)"></div><span style="font-size:13px;color:var(--muted)">Fiche client</span></div>
  <div style="display:grid;grid-template-columns:280px 1fr;gap:16px">
    <div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:hidden">
      <div style="padding:24px 20px;text-align:center;background:linear-gradient(135deg,${sc}10,${sc}05);border-bottom:1px solid var(--border)">
        <div style="width:56px;height:56px;border-radius:50%;background:${sc};display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:var(--bg);margin:0 auto 10px">${c.init}</div>
        <div style="font-size:18px;font-weight:800">${c.name}</div>
        ${c.company?`<div style="font-size:13px;color:var(--muted);margin-top:2px">${c.company}</div>`:''}
        <div style="margin-top:10px;display:flex;justify-content:center;gap:3px;flex-wrap:wrap">${CRM_STAGES.map(s=>`<span onclick="changeStage(${c.id},'${s}')" style="padding:4px 9px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;transition:all .2s;${c.stage===s?'background:'+CRM_STAGE_COLORS[s]+';color:var(--bg)':'background:var(--bg);color:var(--muted);border:1px solid var(--border)'}">${s}</span>`).join('')}</div>
      </div>
      <div style="padding:16px 20px">
        <div style="margin-bottom:12px">${[{i:'üì±',v:c.phone,l:'T√©l√©phone'},{i:'üìß',v:c.email,l:'Email'},{i:'üè¢',v:c.company||'‚Äî',l:'Entreprise'},{i:'üîó',v:c.source,l:'Source'},{i:'üéØ',v:c.interest||'‚Äî',l:'Int√©ress√© par'},{i:'‚ö°',v:c.action||'‚Äî',l:'Action'},{i:'üìÖ',v:fuLabel(c.followUp),l:'Relance'}].map(f=>`<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px"><span>${f.i}</span><span style="color:var(--muted);min-width:70px">${f.l}</span><span style="font-weight:500">${f.v}</span></div>`).join('')}</div>
        <div style="display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:var(--bg);margin-bottom:10px"><div style="text-align:center"><div style="font-size:16px;font-weight:800;color:${sc};font-family:'JetBrains Mono',monospace">${c.value?c.value.toLocaleString()+'‚Ç¨':'0‚Ç¨'}</div><div style="font-size:9px;color:var(--muted)">Valeur</div></div><div style="text-align:center"><div style="font-size:16px;font-weight:800">${cAppts.length}</div><div style="font-size:9px;color:var(--muted)">RDV</div></div><div style="text-align:center"><div style="font-size:16px;font-weight:800">${cInvs.length}</div><div style="font-size:9px;color:var(--muted)">Factures</div></div></div>
        <div style="display:flex;flex-direction:column;gap:4px">
          <button onclick="modalEditContact(${c.id})" style="width:100%;padding:9px;border-radius:8px;border:none;background:${color};color:var(--bg);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">‚úèÔ∏è Modifier</button>
          <button onclick="curMod='appointments';renderDemo()" style="width:100%;padding:9px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">üìÖ Prendre RDV</button>
          <button onclick="curMod='invoices';renderDemo()" style="width:100%;padding:9px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">üßæ Cr√©er facture</button>
        </div>
        <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:3px">${c.tags.map(t=>`<span class="badge badge-m" style="font-size:10px">${t}</span>`).join('')}<span onclick="modalAddTag(${c.id})" style="font-size:10px;padding:3px 8px;border-radius:6px;border:1px dashed var(--border);color:var(--muted);cursor:pointer">+</span></div>
      </div>
    </div>
    <div>
      <div style="display:flex;gap:2px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:2px">${tabs.map(t=>`<button onclick="crmDetailTab='${t.id}';renderDemo()" style="padding:9px 16px;border:none;border-bottom:2px solid ${crmDetailTab===t.id?color:'transparent'};background:none;color:${crmDetailTab===t.id?color:'var(--muted)'};font-size:13px;font-weight:${crmDetailTab===t.id?'700':'500'};cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:5px">${t.i} ${t.l}</button>`).join('')}</div>
      ${crmDetailTab==='info'?crmTabInfo(c):crmDetailTab==='activity'?crmTabActivity(c):crmTabInvoices(c)}
    </div>
  </div>`;
}
function crmTabInfo(c){
  const sc=CRM_STAGE_COLORS[c.stage];const cAppts=appointments.filter(a=>a.contact===c.name);
  return `<div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border);margin-bottom:12px">
    <div style="font-size:12px;font-weight:700;margin-bottom:8px">üìù Notes</div>
    <textarea onchange="updateField(${c.id},'note',this.value)" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;resize:vertical;min-height:80px;line-height:1.6" onfocus="this.style.borderColor='${color}'" onblur="this.style.borderColor='var(--border)'">${c.note||''}</textarea>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:12px;font-weight:700;margin-bottom:12px">üìã Infos</div>
      ${[{l:'Nom',v:c.name},{l:'Email',v:c.email},{l:'T√©l√©phone',v:c.phone},{l:'Entreprise',v:c.company||'‚Äî'},{l:'Source',v:c.source},{l:'Pipeline',v:c.stage},{l:'Int√©r√™t',v:c.interest||'‚Äî'},{l:'Action',v:c.action||'‚Äî'},{l:'Relance',v:fuLabel(c.followUp)},{l:'Dernier √©change',v:daysLabel(c.lastContact)}].map(f=>`<div style="display:flex;justify-content:space-between;padding:5px 0;font-size:12px;border-bottom:1px solid rgba(255,255,255,.03)"><span style="color:var(--muted)">${f.l}</span><span style="font-weight:500">${f.v}</span></div>`).join('')}
    </div>
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:12px;font-weight:700;margin-bottom:12px">üìÖ Prochains RDV</div>
      ${cAppts.length?cAppts.slice(0,4).map(a=>`<div style="display:flex;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.03)"><div style="min-width:42px;text-align:center"><div style="font-size:14px;font-weight:700;color:${sc}">${a.date}</div><div style="font-size:9px;color:var(--muted)">f√©v</div></div><div><div style="font-size:12px;font-weight:600">${a.type}</div><div style="font-size:11px;color:var(--muted)">${a.time} ¬∑ ${a.dur}</div></div></div>`).join(''):'<div style="font-size:12px;color:var(--muted);padding:12px 0">Aucun RDV</div>'}
    </div>
  </div>`;
}
function crmTabActivity(c){
  const typeIcons={invoice:'üßæ',appt:'üìÖ',email:'üìß',note:'üìù',call:'üìû',status:'üîÑ'};
  const typeColors={invoice:'#00d4aa',appt:'#3b82f6',email:'#a855f7',note:'#eab308',call:'#ec4899',status:'#60a5fa'};
  return `<div style="position:relative;padding-left:24px">${c.activity.map((a,i)=>`<div style="position:relative;padding-bottom:${i<c.activity.length-1?'16px':'0'}">
    <div style="position:absolute;left:-24px;top:0;width:16px;height:16px;border-radius:50%;background:${typeColors[a.type]||'#555'};display:flex;align-items:center;justify-content:center;font-size:8px;z-index:1">${typeIcons[a.type]||'‚Ä¢'}</div>
    ${i<c.activity.length-1?`<div style="position:absolute;left:-17px;top:16px;bottom:0;width:2px;background:var(--border)"></div>`:''}
    <div style="padding:10px 14px;border-radius:10px;background:var(--card);border:1px solid var(--border)"><div style="font-size:13px">${a.text}</div><div style="font-size:10px;color:#555;margin-top:3px">${a.date}</div></div>
  </div>`).join('')}</div>
  ${c.activity.length===0?'<div style="padding:24px;text-align:center;color:var(--muted)">Aucune activit√©</div>':''}`;
}
function crmTabInvoices(c){
  const cInvs=invoices.filter(i=>i.client===c.name);const total=cInvs.reduce((a,i)=>a+invTotal(i.items),0);
  return `<div style="font-size:14px;font-weight:700;margin-bottom:12px">${cInvs.length} documents ¬∑ ${total.toLocaleString()}‚Ç¨</div>
  ${cInvs.length?`<div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:hidden"><table class="dt"><thead><tr><th>N¬∞</th><th>Montant</th><th>Date</th><th>Statut</th></tr></thead><tbody>${cInvs.map(inv=>`<tr><td style="font-family:'JetBrains Mono',monospace;font-size:11px">${inv.num}</td><td style="font-weight:600">${invTotal(inv.items).toLocaleString()}‚Ç¨</td><td style="font-size:12px;color:var(--muted)">${inv.date}</td><td><span class="badge badge-${inv.status==='Pay√©e'?'g':inv.status==='En attente'?'o':'m'}">${inv.status}</span></td></tr>`).join('')}</tbody></table></div>`:'<div style="padding:24px;text-align:center;color:var(--muted)">Aucune facture</div>'}`;
}
// CRM Actions
function updateField(id,field,val){const c=contacts.find(x=>x.id===id);if(!c)return;c[field]=val;if(field==='note')c.lastContact=new Date().toISOString().slice(0,10);}
function cycleStage(id){const c=contacts.find(x=>x.id===id);if(!c)return;const i=CRM_STAGES.indexOf(c.stage);c.stage=CRM_STAGES[(i+1)%CRM_STAGES.length];c.activity.unshift({type:'status',text:'Pipeline ‚Üí '+c.stage,date:new Date().toISOString().slice(0,10)});renderDemo();toast('‚Üí '+c.name+' : '+c.stage);}
function changeStage(id,stage){const c=contacts.find(x=>x.id===id);if(!c||c.stage===stage)return;c.stage=stage;c.activity.unshift({type:'status',text:'Pipeline ‚Üí '+stage,date:new Date().toISOString().slice(0,10)});renderDemo();toast('‚Üí '+c.name+' : '+stage);}
function modalAddTag(id){showModal(`<h2>üè∑ Ajouter un tag<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Nom du tag</label><input id="mtTag" placeholder="Ex: VIP, Formation"></div><button class="btn-full" style="background:${color};color:var(--bg)" onclick="const c=contacts.find(x=>x.id===${id});if(c){const t=document.getElementById('mtTag').value.trim();if(t&&!c.tags.includes(t)){c.tags.push(t);}closeModal();renderDemo();toast('üè∑ Tag ajout√©');}">Ajouter</button>`);}
function modalEditContact(id){const c=contacts.find(x=>x.id===id);if(!c)return;showModal(`<h2>‚úèÔ∏è Modifier<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Nom</label><input id="meN" value="${c.name}"></div><div class="field-row"><div class="field"><label>Email</label><input id="meE" value="${c.email}"></div><div class="field"><label>T√©l√©phone</label><input id="meP" value="${c.phone}"></div></div><div class="field-row"><div class="field"><label>Entreprise</label><input id="meC" value="${c.company||''}"></div><div class="field"><label>Source</label><select id="meS">${CRM_SOURCES.map(s=>`<option ${s===c.source?'selected':''}>${s}</option>`).join('')}</select></div></div><div class="field"><label>Valeur client (‚Ç¨)</label><input id="meV" type="number" value="${c.value}"></div><button class="btn-full" style="background:${color};color:var(--bg)" onclick="saveEditContact(${c.id})">Sauvegarder ‚Üí</button>`);}
function saveEditContact(id){const c=contacts.find(x=>x.id===id);if(!c)return;c.name=document.getElementById('meN').value;c.init=getInit(c.name);c.email=document.getElementById('meE').value;c.phone=document.getElementById('meP').value;c.company=document.getElementById('meC').value;c.source=document.getElementById('meS').value;c.value=parseInt(document.getElementById('meV').value)||0;closeModal();renderDemo();toast('‚úÖ Modifi√©');}
function handleXLSX(e){const f=e.target.files[0];if(f)processFile(f);e.target.value='';}
function handleXLSXDrop(e){const f=e.dataTransfer.files[0];if(f)processFile(f);}
function processFile(file){const r=new FileReader();r.onload=function(e){try{const wb=XLSX.read(e.target.result,{type:'array'});const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);let cnt=0;data.forEach(row=>{const n=row.Nom||row.nom||row.Name||row.name||row['Nom complet']||'';if(!n)return;const em=row.Email||row.email||row.Mail||'';const ph=row.T√©l√©phone||row.telephone||row.Phone||row.Tel||'';contacts.push({id:nextId++,init:getInit(n),name:n,email:em||'‚Äî',phone:ph||'‚Äî',company:row.Entreprise||row.Company||'',tags:['Import√©'],stage:'Nouveau',source:'Import Excel',value:0,interest:'‚Äî',action:'üìß Envoyer email',followUp:'',created:new Date().toISOString().slice(0,10),lastContact:new Date().toISOString().slice(0,10),note:'',activity:[{type:'note',text:'Import√© depuis Excel',date:new Date().toISOString().slice(0,10)}]});cnt++;});renderDemo();toast(`üì• ${cnt} contacts import√©s !`);}catch(err){toast('‚ö†Ô∏è Erreur','info');}};r.readAsArrayBuffer(file);}
function modalAddContact(){showModal(`<h2>üìá Nouveau contact<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Nom</label><input id="mcN" placeholder="Marie Dupont"></div><div class="field-row"><div class="field"><label>Email</label><input id="mcE" placeholder="marie@email.com"></div><div class="field"><label>T√©l√©phone</label><input id="mcP" placeholder="06 12 34 56 78"></div></div><div class="field-row"><div class="field"><label>Entreprise</label><input id="mcCo" placeholder="Optionnel"></div><div class="field"><label>Source</label><select id="mcSrc">${CRM_SOURCES.map(s=>`<option>${s}</option>`).join('')}</select></div></div><div class="field-row"><div class="field"><label>Pipeline</label><select id="mcSt">${CRM_STAGES.map(s=>`<option>${s}</option>`).join('')}</select></div><div class="field"><label>Int√©ress√© par</label><select id="mcInt">${CRM_INTERESTS.map(i=>`<option>${i}</option>`).join('')}</select></div></div><div class="field"><label>Note</label><textarea id="mcNo" placeholder="Notes..."></textarea></div><button class="btn-full" style="background:${color};color:var(--bg)" onclick="addContact()">Ajouter ‚Üí</button>`);}
function addContact(){const n=document.getElementById('mcN').value;if(!n){toast('‚ö†Ô∏è Nom requis','info');return;}const c={id:nextId++,init:getInit(n),name:n,email:document.getElementById('mcE').value||'‚Äî',phone:document.getElementById('mcP').value||'‚Äî',company:document.getElementById('mcCo').value||'',tags:['Nouveau'],stage:document.getElementById('mcSt').value,source:document.getElementById('mcSrc').value,value:0,interest:document.getElementById('mcInt').value,action:'‚Äî',followUp:'',created:new Date().toISOString().slice(0,10),lastContact:new Date().toISOString().slice(0,10),note:document.getElementById('mcNo').value,activity:[{type:'note',text:'Contact cr√©√©',date:new Date().toISOString().slice(0,10)}]};contacts.unshift(c);closeModal();renderDemo();toast('‚úÖ '+n+' ajout√© !');}
// ===== APPOINTMENTS =====
function pgAppts(){
  const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'],slots=["09:00","10:00","11:00","14:00","15:00","16:00","17:00"],dayA=selectedDay?getApptsForDay(selectedDay):[];
  return `<div class="page-head"><h1>Rendez-vous</h1><p>F√©vrier 2025 ¬∑ ${appointments.length} RDV</p></div>
  <div style="margin-bottom:16px"><button onclick="modalNewAppt()" style="padding:9px 18px;border-radius:10px;border:none;background:${color};color:var(--bg);font-weight:700;font-size:13px;cursor:pointer;font-family:inherit">+ Nouveau RDV</button></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div>
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">üìÖ Calendrier ‚Äî <span style="color:var(--muted);font-weight:400">cliquez un jour</span></div>
      <div style="padding:14px;border-radius:14px;background:var(--card);border:1px solid var(--border)"><div class="cal-grid">${days.map(d=>`<div class="cal-h">${d}</div>`).join('')}${[0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,0,0].map(d=>{if(!d)return'<div class="cal-d empty"></div>';const td=d===14,has=getApptsForDay(d).length>0,sel=selectedDay===d;return`<div class="cal-d ${td?'today':''} ${has?'has-appt':''}" style="${sel?`background:${color}20;border-color:${color}`:''}" onclick="selectedDay=${d};renderDemo()">${d}</div>`;}).join('')}</div></div>
      ${selectedDay?`<div style="margin-top:12px;padding:16px;border-radius:14px;background:var(--card);border:1px solid ${color}40"><div style="font-size:13px;font-weight:700;margin-bottom:10px;color:${color}">üìã ${selectedDay} f√©vrier ‚Äî ${dayA.length} RDV</div>${dayA.length?dayA.map(a=>`<div style="display:flex;gap:12px;padding:10px;border-radius:10px;background:var(--surface);border:1px solid var(--border);margin-bottom:5px"><div style="text-align:center;min-width:48px"><div style="font-size:16px;font-weight:800;color:${color}">${a.time}</div><div style="font-size:10px;color:var(--muted)">${a.dur}</div></div><div style="flex:1"><div style="font-size:13px;font-weight:700">${a.type}</div><div style="font-size:11px;color:var(--muted);margin-top:2px"><span class="av" style="background:${color};width:18px;height:18px;font-size:8px">${getInit(a.contact)}</span>${a.contact}</div>${a.notes?`<div style="font-size:11px;color:#666;margin-top:3px;font-style:italic">${a.notes}</div>`:''}</div><span class="badge badge-${a.status==='Confirm√©'?'g':'o'}" style="height:fit-content">${a.status}</span></div>`).join(''):'<div style="text-align:center;color:var(--muted);padding:12px;font-size:12px">Aucun RDV</div>'}</div>`:'<div style="margin-top:12px;padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border);text-align:center;color:var(--muted);font-size:12px">S√©lectionnez un jour</div>'}
    </div>
    <div>
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">üåê Page de booking publique</div>
      <div style="border-radius:14px;border:1px solid var(--border);background:var(--card);overflow:hidden">
        <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px"><div style="width:36px;height:36px;border-radius:10px;background:${color};display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:var(--bg)">M</div><div><div style="font-size:14px;font-weight:700">Mon Entreprise</div><div style="font-size:10px;color:var(--muted)">monentreprise.workai.fr/booking</div></div></div>
        <div style="padding:16px"><div style="font-size:11px;font-weight:600;color:var(--muted);margin-bottom:8px">Ven. 14 f√©vrier</div>${slots.map(s=>{const tk=bookedSlots.has(s);return`<div class="slot ${tk?'booked':''}" onclick="${tk?'':`bookSlot('${s}')`}">${s}${tk?' ‚úì':''}</div>`;}).join('')}<div style="margin-top:10px;padding:10px;border-radius:8px;background:rgba(0,212,170,.04);border:1px solid rgba(0,212,170,.1);font-size:10px;color:var(--muted)">üí° Page publique ‚Äî vos clients ne voient pas le dashboard</div></div>
      </div>
    </div>
  </div>`;
}
function bookSlot(s){bookedSlots.add(s);appointments.push({id:Date.now(),contact:"Nouveau client",type:"R√©servation en ligne",date:14,time:s,dur:"60 min",status:"Confirm√©",notes:"Via lien public"});renderDemo();toast('‚úÖ Cr√©neau '+s+' r√©serv√© !');}
function modalNewAppt(){showModal(`<h2>üìÖ Nouveau RDV<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Client</label><select id="maC">${contacts.map(c=>`<option>${c.name}</option>`).join('')}</select></div><div class="field"><label>Type</label><input id="maT" value="Coaching individuel"></div><div class="field-row"><div class="field"><label>Jour (f√©v)</label><input id="maD" type="number" min="1" max="28" value="20"></div><div class="field"><label>Heure</label><input id="maH" value="14:00"></div></div><div class="field-row"><div class="field"><label>Dur√©e</label><input id="maDu" value="60 min"></div><div class="field"><label>Statut</label><select id="maSt"><option>Confirm√©</option><option>En attente</option></select></div></div><div class="field"><label>Notes</label><textarea id="maN"></textarea></div><button class="btn-full" style="background:${color};color:var(--bg)" onclick="addAppt()">Cr√©er ‚Üí</button>`);}
function addAppt(){const cl=document.getElementById('maC').value;appointments.push({id:Date.now(),contact:cl,type:document.getElementById('maT').value,date:parseInt(document.getElementById('maD').value),time:document.getElementById('maH').value,dur:document.getElementById('maDu').value,status:document.getElementById('maSt').value,notes:document.getElementById('maN').value});closeModal();renderDemo();toast('‚úÖ RDV avec '+cl);}
// ===== FACTURES & DEVIS ‚Äî MINI PENNYLANE =====
let invView='list'; // list | stats
function pgInvoices(){
  const tabs=`<div style="display:flex;gap:0;margin-bottom:18px;border-bottom:1px solid var(--border)">${[{v:'invoices',l:'üßæ Factures & Devis'},{v:'compta',l:'üìí Comptabilit√©'},{v:'findash',l:'üìä Tableau de bord'}].map(t=>`<button onclick="invTab='${t.v}';renderDemo()" style="padding:12px 20px;border:none;background:none;color:${invTab===t.v?color:'var(--muted)'};font-size:13px;font-weight:${invTab===t.v?'700':'500'};cursor:pointer;font-family:inherit;border-bottom:2px solid ${invTab===t.v?color:'transparent'};transition:all .2s">${t.l}</button>`).join('')}</div>`;
  if(invTab==='compta')return tabs+pgCompta();
  if(invTab==='findash')return tabs+pgFinDash();
  return tabs+pgInvList();
}
function pgInvList(){
  const allInv=invoices.filter(i=>i.type==='invoice'&&i.subtype!=='avoir'),allQ=invoices.filter(i=>i.type==='quote'),avoirs=invoices.filter(i=>i.subtype==='avoir');
  const totalHT=allInv.reduce((a,b)=>a+invTotal(b.items),0);
  const paid=allInv.filter(i=>i.status==='Pay√©e');const paidHT=paid.reduce((a,b)=>a+invTotal(b.items),0);
  const pending=allInv.filter(i=>i.status==='En attente');const pendingHT=pending.reduce((a,b)=>a+invTotal(b.items),0);
  const late=allInv.filter(i=>i.status==='En retard');const lateHT=late.reduce((a,b)=>a+invTotal(b.items),0);
  const quotesHT=allQ.reduce((a,b)=>a+invTotal(b.items),0);
  const accepted=allQ.filter(i=>i.status==='Accept√©');const convRate=allQ.length?Math.round(accepted.length/allQ.length*100):0;
  const tvaR=tvaApplicable()?bizConfig.tvaRate:0;
  const filtered=invFilter==='all'?invoices:invFilter==='invoice'?allInv:invFilter==='quote'?allQ:invFilter==='late'?late:invFilter==='paid'?paid:invFilter==='avoir'?avoirs:invoices;
  return `<div class="page-head"><h1>Factures & Devis</h1><p>${invoices.length} documents ¬∑ Num√©rotation s√©quentielle</p></div>
  <div class="stats" style="grid-template-columns:repeat(4,1fr)">
    <div class="stat"><div class="s-label">CA encaiss√©</div><div class="s-value" style="color:${color}">${Math.round(paidHT*(1+tvaR/100)).toLocaleString()}‚Ç¨</div><div class="s-change up">${paid.length} facture${paid.length>1?'s':''}</div></div>
    <div class="stat"><div class="s-label">En attente</div><div class="s-value" style="color:#eab308">${Math.round(pendingHT*(1+tvaR/100)).toLocaleString()}‚Ç¨</div><div class="s-change">${pending.length} facture${pending.length>1?'s':''}</div></div>
    <div class="stat"><div class="s-label">En retard</div><div class="s-value" style="color:var(--accent2)">${Math.round(lateHT*(1+tvaR/100)).toLocaleString()}‚Ç¨</div>${late.length?`<div class="s-change" style="color:var(--accent2)">‚ö† ${late.length} impay√©e${late.length>1?'s':''}</div>`:''}</div>
    <div class="stat"><div class="s-label">Devis</div><div class="s-value">${Math.round(quotesHT*(1+tvaR/100)).toLocaleString()}‚Ç¨</div><div class="s-change">${convRate}% conversion</div></div>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
    <div style="display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--border)">${[{v:'all',l:'Tout ('+invoices.length+')'},{v:'invoice',l:'Factures ('+allInv.length+')'},{v:'quote',l:'Devis ('+allQ.length+')'},{v:'avoir',l:'Avoirs ('+avoirs.length+')'},{v:'late',l:'‚ö† Retard ('+late.length+')'},{v:'paid',l:'‚úì Pay√©es'}].map(t=>`<button onclick="invFilter='${t.v}';renderDemo()" style="padding:7px 11px;border:none;font-size:11px;cursor:pointer;font-family:inherit;${invFilter===t.v?'background:'+color+';color:var(--bg);font-weight:700':'background:var(--card);color:var(--muted)'}">${t.l}</button>`).join('')}</div>
    <div style="margin-left:auto;display:flex;gap:6px">
      <button onclick="exportCSV()" style="padding:9px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;cursor:pointer;font-family:inherit" title="Export CSV comptable">üì• Export</button>
      <button onclick="modalEditInv(null,'quote')" style="padding:9px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-weight:600;font-size:12px;cursor:pointer;font-family:inherit">+ Devis</button>
      <button onclick="modalEditInv(null,'invoice')" style="padding:9px 16px;border-radius:10px;border:none;background:${color};color:var(--bg);font-weight:700;font-size:12px;cursor:pointer;font-family:inherit">+ Facture</button>
    </div>
  </div>
  ${late.length?`<div style="padding:12px 16px;border-radius:12px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);margin-bottom:14px;display:flex;align-items:center;gap:10px"><span style="font-size:16px">‚ö†Ô∏è</span><div style="flex:1"><div style="font-size:13px;font-weight:700;color:var(--accent2)">${late.length} facture${late.length>1?'s':''} en retard ‚Äî ${Math.round(lateHT*(1+tvaR/100)).toLocaleString()}‚Ç¨ TTC</div><div style="font-size:12px;color:var(--muted);margin-top:2px">${late.map(i=>i.client).join(', ')} ¬∑ P√©nalit√©s 12,45% + 40‚Ç¨</div></div><button onclick="relanceAll()" style="padding:8px 16px;border-radius:8px;border:none;background:var(--accent2);color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;flex-shrink:0">üìß Relancer tout</button></div>`:''}`+
  `<div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:visible">
  <table style="width:100%;border-collapse:collapse;font-size:12px">
  <thead><tr style="border-bottom:1px solid var(--border);font-size:11px;color:var(--muted)"><th style="padding:10px 12px;text-align:left;font-weight:600">Document</th><th style="padding:10px 8px;text-align:left;font-weight:600">Client</th><th style="padding:10px 8px;text-align:left;font-weight:600">√âmission</th><th style="padding:10px 8px;text-align:left;font-weight:600">√âch√©ance</th><th style="padding:10px 8px;text-align:right;font-weight:600">Montant</th><th style="padding:10px 8px;text-align:center;font-weight:600">Statut</th><th style="padding:10px 8px;text-align:center;font-weight:600">Paiement</th><th style="padding:10px 8px;text-align:right;font-weight:600">Actions</th></tr></thead>
  <tbody>
  ${filtered.map(inv=>{const t=invTotal(inv.items);const ttc=Math.round(t*(1+tvaR/100));const isQ=inv.type==='quote';const isLate=inv.status==='En retard';const isAvoir=inv.subtype==='avoir';const isAcompte=inv.subtype==='acompte';const isPaid=inv.status==='Pay√©e';
  const icon=isAvoir?'üìÑ':isAcompte?'üí∞':isQ?'üìã':'üßæ';
  const typeLabel=isAvoir?'Avoir':isAcompte?'Acompte':isQ?'Devis':'Facture';
  const stBadge=inv.status==='Pay√©e'||inv.status==='Accept√©'?'g':inv.status==='En attente'||inv.status==='Devis envoy√©'?'o':inv.status==='En retard'?'m':'b';
  return`<tr style="border-bottom:1px solid rgba(255,255,255,.04);${isLate?'background:rgba(239,68,68,.03)':isAvoir?'background:rgba(239,68,68,.02)':''}" onmouseover="this.style.background='rgba(255,255,255,.03)'" onmouseout="this.style.background='${isLate?'rgba(239,68,68,.03)':isAvoir?'rgba(239,68,68,.02)':''}'">
    <td style="padding:10px 12px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:14px">${icon}</span><div><div style="font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600">${inv.num}</div><div style="font-size:10px;color:var(--muted)">${typeLabel}${inv.linkedTo?' ¬∑ r√©f. '+inv.linkedTo:''}</div></div></div></td>
    <td style="padding:10px 8px"><div style="font-weight:600;font-size:12px">${inv.client}</div></td>
    <td style="padding:10px 8px;color:var(--muted);font-size:11px">${inv.date}</td>
    <td style="padding:10px 8px;font-size:11px">${inv.due||'‚Äî'}</td>
    <td style="padding:10px 8px;text-align:right"><div style="font-size:13px;font-weight:800;font-family:'JetBrains Mono',monospace;color:${isAvoir?'var(--accent2)':isLate?'var(--accent2)':color}">${isAvoir?'‚àí':''}${Math.abs(ttc).toLocaleString()}‚Ç¨</div><div style="font-size:10px;color:var(--muted)">${isAvoir?'‚àí':''}${Math.abs(t).toLocaleString()}‚Ç¨ HT</div></td>
    <td style="padding:10px 8px;text-align:center"><span class="badge badge-click badge-${stBadge}" onclick="${isAvoir?'':'cycleStatus('+inv.id+')'}" style="cursor:${isAvoir?'default':'pointer'};font-size:10px" title="${isAvoir?'':'Cliquer pour changer'}">${inv.status}</span></td>
    <td style="padding:10px 8px;text-align:center;font-size:11px">${isPaid?`<div style="color:#22c55e;font-weight:600;font-size:10px">${inv.payMode||'‚Äî'}</div><div style="font-size:9px;color:var(--muted)">${inv.paidDate||''}</div>`:inv.lastRelance?`<div style="color:var(--accent2);font-weight:600;font-size:10px">Relance ${inv.relanceCount||1}x</div><div style="font-size:9px;color:var(--muted)">${inv.lastRelance}</div>`:'<span style="color:var(--muted)">‚Äî</span>'}</td>
    <td style="padding:10px 8px;text-align:right;position:relative">
      <button class="ctx-trigger" onclick="toggleCtx('inv${inv.id}',event)">‚ãØ</button>
      ${openCtx==='inv'+inv.id?`<div class="ctx-menu" onclick="event.stopPropagation()">
        <button class="primary" onclick="modalViewInv(${inv.id});openCtx=null">üìÑ Voir / PDF</button>
        ${isPaid||isAvoir?`<button style="color:var(--muted);cursor:default" onclick="toast('üîí Document verrouill√© ‚Äî cr√©ez un avoir pour corriger')">üîí Modifier (verrouill√©)</button>`:`<button onclick="modalEditInv(${inv.id});openCtx=null">‚úèÔ∏è Modifier</button>`}
        <button onclick="dupInvoice(${inv.id});openCtx=null">üìã Dupliquer</button>
        ${isQ&&inv.status==='Accept√©'?`<button class="primary" onclick="convertToInvoice(${inv.id});openCtx=null">üßæ Convertir en facture</button><button onclick="createAcompte(${inv.id});openCtx=null">üí∞ Acompte 30%</button>`:``}
        ${!isQ&&!isAvoir&&isPaid?`<button onclick="createAvoir(${inv.id});openCtx=null">üìÑ Cr√©er un avoir</button>`:''}
        ${!isQ&&inv.status==='En attente'?`<button style="color:#22c55e" onclick="showPayModal(${inv.id});openCtx=null">üí∞ Enregistrer paiement</button>`:''}
        ${isLate?`<button style="color:var(--accent2)" onclick="relanceOne(${inv.id});openCtx=null">üìß Relance</button>`:''}
        <div style="height:1px;background:var(--border);margin:4px 0"></div>
        ${isPaid||isAvoir?`<button style="color:var(--muted);cursor:default" onclick="toast('üîí Impossible de supprimer un document comptabilis√©')">üîí Supprimer (verrouill√©)</button>`:`<button class="danger" onclick="if(confirm('Supprimer ${inv.num} ?')){invoices=invoices.filter(i=>i.id!==${inv.id});openCtx=null;renderDemo();toast('üóë Supprim√©')}">üóë Supprimer</button>`}
      </div>`:``}
    </td>
  </tr>`;}).join('')}
  </tbody></table>
  </div>
  ${filtered.length===0?'<div style="padding:40px;text-align:center;color:var(--muted);font-size:14px">Aucun document</div>':''}
  <div style="margin-top:20px;padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><div style="font-size:13px;font-weight:700">üìä R√©partition mensuelle</div><div style="font-size:11px;color:var(--muted)">S√©quentiel : FAC-2026-001 ‚Üí ${nextInvNum('invoice')}</div></div>
    <div class="chart-bars" style="height:100px">${['Oct','Nov','D√©c','Jan','F√©v'].map((m,i)=>{const vals=[480,720,580,960,paidHT];const v=vals[i];return`<div class="chart-bar-w"><div class="chart-val" style="color:${color}">${v}‚Ç¨</div><div class="chart-bar" style="height:${Math.round(v/960*100)}%;background:${i===4?color:color+'50'}"></div><div class="chart-lab">${m}</div></div>`;}).join('')}</div>
  </div>`;
}
const SCYCLE={invoice:['En attente','Pay√©e','En retard'],quote:['Devis envoy√©','Accept√©','Refus√©','Converti']};
function cycleStatus(id){const inv=invoices.find(i=>i.id===id);if(!inv)return;if(inv.subtype==='avoir')return toast('Les avoirs ne changent pas de statut');if(inv.status==='Pay√©e')return toast('üîí Facture pay√©e ‚Äî cr√©ez un avoir pour corriger');const c=SCYCLE[inv.type];const next=c[(c.indexOf(inv.status)+1)%c.length];if(next==='Pay√©e'){showPayModal(id);return;}inv.status=next;renderDemo();toast('üìã ‚Üí '+inv.status);}
function showPayModal(id){const inv=invoices.find(i=>i.id===id);if(!inv)return;const ttc=Math.round(invTotal(inv.items)*1.2);showModal(`<h2>üí∞ Enregistrer le paiement<button class="modal-close" onclick="closeModal()">√ó</button></h2><div style="font-size:13px;margin-bottom:14px"><strong>${inv.num}</strong> ‚Äî ${inv.client} ‚Äî <strong style="color:${color}">${ttc.toLocaleString()}‚Ç¨ TTC</strong></div><div class="field-row"><div class="field"><label>Date de paiement</label><input id="payDt" type="date" value="${new Date().toISOString().slice(0,10)}"></div><div class="field"><label>Mode de r√®glement</label><select id="payMd"><option>Virement</option><option>CB</option><option>Ch√®que</option><option>Esp√®ces</option><option>PayPal</option><option>Pr√©l√®vement</option></select></div></div><div class="field"><label>R√©f√©rence paiement <span style="color:var(--muted);font-size:11px">(optionnel)</span></label><input id="payRef" placeholder="Ex: VIR-20260215"></div><button class="btn-full" style="background:${color};color:var(--bg)" onclick="confirmPay(${id})">‚úÖ Confirmer le paiement</button>`,true);}
function confirmPay(id){const inv=invoices.find(i=>i.id===id);if(!inv)return;const dt=document.getElementById('payDt');const md=document.getElementById('payMd');inv.status='Pay√©e';inv.paidDate=dt?new Date(dt.value).toLocaleDateString('fr-FR'):new Date().toLocaleDateString('fr-FR');inv.payMode=md?md.value:'Virement';inv.payRef=document.getElementById('payRef')?.value||'';const c=contacts.find(x=>x.name===inv.client);if(c){c.activity.unshift({type:'payment',text:'Paiement '+inv.num+' ('+inv.payMode+')',date:new Date().toISOString().slice(0,10)});c.lastContact=new Date().toISOString().slice(0,10);}closeModal();renderDemo();toast('üí∞ '+inv.num+' ‚Äî Pay√©e par '+inv.payMode);}
function convertToInvoice(id){const q=invoices.find(i=>i.id===id);if(!q)return;const num=nextInvNum('invoice');invoices.unshift({id:Date.now(),num,client:q.client,items:JSON.parse(JSON.stringify(q.items)),status:'En attente',type:'invoice',subtype:'standard',date:new Date().toLocaleDateString('fr-FR'),due:'',siret:q.siret,tva:q.tva,addr:q.addr,cAddr:q.cAddr,siren:q.siren||'',opType:q.opType||'PS',tvaDebit:q.tvaDebit||false,fromQuote:q.num,payTerms:q.payTerms||'net30'});q.status='Converti';renderDemo();toast('üßæ Facture '+num+' cr√©√©e depuis '+q.num);}
function dupInvoice(id){const inv=invoices.find(i=>i.id===id);if(!inv)return;const num=nextInvNum(inv.type);invoices.unshift({...JSON.parse(JSON.stringify(inv)),id:Date.now(),num,status:inv.type==='quote'?'Devis envoy√©':'En attente',date:new Date().toLocaleDateString('fr-FR'),paidDate:undefined,payMode:undefined,payRef:undefined,lastRelance:undefined,relanceCount:0});renderDemo();toast('üìã '+num+' dupliqu√©');}
function createAvoir(id){const inv=invoices.find(i=>i.id===id);if(!inv)return;const avNum='AV-2026-'+String(invoices.filter(i=>i.subtype==='avoir').length+1).padStart(3,'0');const items=inv.items.map(l=>({...l,price:-Math.abs(l.price)}));invoices.unshift({id:Date.now(),num:avNum,client:inv.client,items,status:'√âmis',type:'invoice',subtype:'avoir',date:new Date().toLocaleDateString('fr-FR'),due:'',siret:inv.siret,tva:inv.tva,addr:inv.addr,cAddr:inv.cAddr,linkedTo:inv.num,payTerms:'immediate'});renderDemo();toast('üìÑ Avoir '+avNum+' cr√©√© (r√©f. '+inv.num+')');}
function createAcompte(id){const q=invoices.find(i=>i.id===id);if(!q)return;const num=nextInvNum('invoice');const total=invTotal(q.items);const acompte=Math.round(total*0.3);invoices.unshift({id:Date.now(),num,client:q.client,items:[{desc:'Acompte 30% ‚Äî '+q.items[0]?.desc||'Prestation',qty:1,price:acompte,unit:'forfait',remise:0}],status:'En attente',type:'invoice',subtype:'acompte',date:new Date().toLocaleDateString('fr-FR'),due:'',siret:q.siret,tva:q.tva,addr:q.addr,cAddr:q.cAddr,linkedTo:q.num,payTerms:'immediate'});renderDemo();toast('üßæ Acompte 30% ('+acompte+'‚Ç¨) cr√©√© depuis '+q.num);}
function relanceOne(id){const inv=invoices.find(i=>i.id===id);if(!inv)return;const t=Math.round(invTotal(inv.items)*1.2);const defaultMsg=`Bonjour,\n\nSauf erreur de notre part, nous constatons que la facture ${inv.num} d'un montant de ${t.toLocaleString()}‚Ç¨ TTC, √©mise le ${inv.date} et arriv√©e √† √©ch√©ance le ${inv.due}, n'a pas encore √©t√© r√©gl√©e.\n\nConform√©ment aux conditions g√©n√©rales, des p√©nalit√©s de retard au taux de 12,45% annuel ainsi qu'une indemnit√© forfaitaire de recouvrement de 40‚Ç¨ sont exigibles de plein droit.\n\nNous vous prions de bien vouloir proc√©der au r√®glement dans les meilleurs d√©lais.\n\nCordialement,\n${bizConfig.name}`;showModal(`<h2>üìß Relance ‚Äî ${inv.num}<button class="modal-close" onclick="closeModal()">√ó</button></h2><div style="font-size:13px;color:var(--muted);margin-bottom:12px"><strong>${inv.client}</strong> ¬∑ ${t.toLocaleString()}‚Ç¨ TTC ¬∑ √âch√©ance: ${inv.due}</div><div class="field"><label>Objet</label><input id="rlObj" value="Relance facture ${inv.num} ‚Äî ${t.toLocaleString()}‚Ç¨"></div><div class="field"><label>Message</label><textarea id="rlMsg" rows="10" style="line-height:1.6">${defaultMsg}</textarea></div><button class="btn-full" style="background:var(--accent2);color:#fff" onclick="sendRelance(${inv.id})">üìß Envoyer la relance</button>`);}
function sendRelance(id){const inv=invoices.find(i=>i.id==id);if(!inv)return;inv.lastRelance=new Date().toLocaleDateString('fr-FR');inv.relanceCount=(inv.relanceCount||0)+1;const c=contacts.find(x=>x.name===inv.client);if(c){c.activity.unshift({type:'email',text:'Relance facture '+inv.num+' ('+inv.relanceCount+'e)',date:new Date().toISOString().slice(0,10)});c.lastContact=new Date().toISOString().slice(0,10);}closeModal();renderDemo();toast('üìß Relance '+inv.relanceCount+' envoy√©e √† '+inv.client);}
function relanceAll(){const late=invoices.filter(i=>i.status==='En retard');if(!late.length)return;showModal(`<h2>üìß Relancer tout<button class="modal-close" onclick="closeModal()">√ó</button></h2><div style="margin-bottom:14px;font-size:13px">${late.length} facture${late.length>1?'s':''} en retard :</div>${late.map(inv=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px"><span>${inv.client} ‚Äî ${inv.num}</span><span style="font-weight:700;color:var(--accent2)">${Math.round(invTotal(inv.items)*1.2).toLocaleString()}‚Ç¨</span></div>`).join('')}<div class="field" style="margin-top:14px"><label>Message de relance (appliqu√© √† tous)</label><textarea id="rlAllMsg" rows="6" style="line-height:1.6">Bonjour,\n\nSauf erreur de notre part, votre facture est arriv√©e √† √©ch√©ance. Merci de proc√©der au r√®glement.\n\nCordialement,\n${bizConfig.name}</textarea></div><button class="btn-full" style="background:var(--accent2);color:#fff" onclick="sendRelanceAll()">üìß Envoyer ${late.length} relances</button>`);}
function sendRelanceAll(){const late=invoices.filter(i=>i.status==='En retard');late.forEach(inv=>{inv.lastRelance=new Date().toLocaleDateString('fr-FR');inv.relanceCount=(inv.relanceCount||0)+1;const c=contacts.find(x=>x.name===inv.client);if(c){c.activity.unshift({type:'email',text:'Relance facture '+inv.num,date:new Date().toISOString().slice(0,10)});c.lastContact=new Date().toISOString().slice(0,10);}});closeModal();renderDemo();toast('üìß '+late.length+' relances envoy√©es');}
function modalViewInv(id){const inv=invoices.find(i=>i.id===id);if(!inv)return;const t=invTotal(inv.items);const tvaRate=tvaApplicable()?bizConfig.tvaRate:0;const tvaAmt=Math.round(t*tvaRate/100);const ttc=Math.round(t*(1+tvaRate/100));const isAvoir=inv.subtype==='avoir';const isAcompte=inv.subtype==='acompte';const docTitle=isAvoir?'AVOIR':isAcompte?'FACTURE D&#39;ACOMPTE':inv.type==='quote'?'DEVIS':'FACTURE';const opLabel={LB:'Livraison de biens',PS:'Prestation de services',LBPS:'Livraison de biens et prestation de services'};const ptLabel={'net30':'Net 30 jours','net45':'Net 45 jours','net60':'Net 60 jours','immediate':'Paiement comptant','custom':'Selon conditions'};showModal(`<h2>${isAvoir?'üìÑ':'üßæ'} ${inv.num}<button class="modal-close" onclick="closeModal()">√ó</button></h2><div style="display:flex;gap:6px;margin-bottom:14px"><button onclick="downloadPDF('${inv.id}')" style="padding:8px 16px;border-radius:8px;border:none;background:${color};color:var(--bg);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">üì• T√©l√©charger PDF</button><button onclick="window.print()" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;cursor:pointer;font-family:inherit">üñ® Imprimer</button></div><div id="invPdf${inv.id}" class="inv-white"><div style="display:flex;justify-content:space-between;margin-bottom:18px"><div><div style="font-size:18px;font-weight:800;color:#1a73e8">${bizConfig.name}</div><div style="font-size:11px;color:#999;margin-top:4px">${bizConfig.addr}</div><div style="font-size:11px;color:#999">SIRET: ${bizConfig.siret}${tvaApplicable()?' ¬∑ TVA: '+bizConfig.tvaNum:''}</div>${bizConfig.rcs?'<div style="font-size:11px;color:#999">'+bizConfig.rcs+'</div>':''}</div><div style="text-align:right"><div style="font-size:20px;font-weight:800;color:${isAvoir?'#dc2626':'#222'}">${docTitle}</div>${isAvoir?'<div style="font-size:11px;color:#dc2626;margin-top:2px">R√©f. facture : '+inv.linkedTo+'</div>':''}${isAcompte?'<div style="font-size:11px;color:#2563eb;margin-top:2px">R√©f. devis : '+(inv.linkedTo||'‚Äî')+'</div>':''}<div style="font-size:12px;color:#888;margin-top:4px;line-height:1.8">${inv.num}<br>Date: ${inv.date}${inv.due?'<br>√âch√©ance: '+inv.due:''}</div></div></div><div style="display:flex;gap:10px;margin-bottom:14px"><div style="flex:1;font-size:12px;color:#555;padding:10px;background:#f9f9f9;border-radius:8px"><strong>√âmetteur</strong><br>${bizConfig.addr}<br>SIRET: ${bizConfig.siret}</div><div style="flex:1;font-size:12px;color:#555;padding:10px;background:#f9f9f9;border-radius:8px"><strong>Client</strong><br>${inv.client}${inv.cAddr?'<br>'+inv.cAddr:''}${inv.siren?'<br>SIREN: '+inv.siren:''}</div></div><table class="inv-table"><thead><tr><th style="text-align:left">Description</th><th>Qt√©</th><th>Unit√©</th>${inv.items.some(l=>l.remise)?'<th>Remise</th>':''}<th>P.U. HT</th><th style="text-align:right">Total HT</th></tr></thead><tbody>${inv.items.map(l=>`<tr><td>${l.desc}</td><td style="text-align:center">${Math.abs(l.qty)}</td><td style="text-align:center;font-size:11px;color:#888">${l.unit||'‚Äî'}</td>${inv.items.some(x=>x.remise)?'<td style="text-align:center;color:#dc2626">'+(l.remise?'-'+l.remise+'%':'‚Äî')+'</td>':''}<td style="text-align:right">${Math.abs(l.price).toLocaleString()}‚Ç¨</td><td style="text-align:right;font-weight:600">${lineTotal(l).toLocaleString()}‚Ç¨</td></tr>`).join('')}</tbody></table><div style="text-align:right;margin-top:12px;font-size:13px"><div style="padding:4px 0;display:flex;justify-content:flex-end;gap:28px"><span style="color:#888">Total HT</span><span>${t.toLocaleString()}‚Ç¨</span></div>${tvaRate?`<div style="padding:4px 0;display:flex;justify-content:flex-end;gap:28px"><span style="color:#888">TVA ${tvaRate}%</span><span>${tvaAmt.toLocaleString()}‚Ç¨</span></div>`:`<div style="padding:4px 0;display:flex;justify-content:flex-end;gap:28px;font-size:11px;color:#aaa"><span>TVA non applicable, art. 293 B du CGI</span></div>`}<div style="font-size:20px;font-weight:800;padding-top:8px;border-top:2px solid #222;margin-top:8px;display:flex;justify-content:flex-end;gap:28px"><span>${isAvoir?'Avoir':'TTC'}</span><span style="color:${isAvoir?'#dc2626':'#1a73e8'}">${isAvoir?'‚àí':''}${Math.abs(ttc).toLocaleString()}‚Ç¨</span></div></div>${inv.payMode?'<div style="margin-top:10px;padding:8px 10px;background:#f0fdf4;border-radius:6px;font-size:11px;color:#15803d"><strong>R√©gl√©e</strong> le '+inv.paidDate+' par '+inv.payMode+(inv.payRef?' ‚Äî R√©f: '+inv.payRef:'')+'</div>':''}<div style="margin-top:14px;font-size:9px;color:#aaa;border-top:1px solid #eee;padding-top:8px;line-height:1.6"><strong>Conditions de r√®glement</strong><br>${ptLabel[inv.payTerms||'net30']||'Net 30 jours'}<br><strong>P√©nalit√©s de retard</strong> : taux annuel de 12,45% (3√ó taux directeur BCE 4,15%) applicables d√®s le 1er jour de retard<br><strong>Indemnit√© forfaitaire de recouvrement</strong> : 40‚Ç¨ (art. D.441-5 du Code de commerce)<br><strong>Escompte</strong> : pas d&#39;escompte pour paiement anticip√©<br>Cat√©gorie: ${opLabel[inv.opType||'PS']||'Prestation de services'}${inv.tvaDebit?' ¬∑ Option TVA sur les d√©bits':''}<br>Conforme facturation √©lectronique ‚Äî Norme EN 16931</div></div>`,true);}
function downloadPDF(id){const el=document.getElementById('invPdf'+id);if(!el)return;const inv=invoices.find(i=>i.id==id);const fname=(inv?inv.num:'facture')+'.pdf';html2pdf().set({margin:8,filename:fname,image:{type:'jpeg',quality:.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).from(el).save().then(()=>toast('üì• '+fname+' t√©l√©charg√©'));}
function exportCSV(){const paidInv=invoices.filter(i=>i.type==='invoice'&&i.status==='Pay√©e');const rows=[['Date','N¬∞ Pi√®ce','Client','Description','Montant HT','TVA','TTC','Mode r√®glement','R√©f√©rence']];paidInv.forEach(inv=>{const t=invTotal(inv.items);const tvaR=tvaApplicable()?bizConfig.tvaRate:0;rows.push([inv.paidDate||inv.date,inv.num,inv.client,inv.items.map(l=>l.desc).join(' + '),t,Math.round(t*tvaR/100),Math.round(t*(1+tvaR/100)),inv.payMode||'',inv.payRef||'']);});const csv='\uFEFF'+rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(';')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='livre-recettes-'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('üì• Export CSV t√©l√©charg√©');}
function modalEditInv(id,newType){
  const isNew=!id;const inv=isNew?{num:nextInvNum(newType||'invoice'),client:contacts[0]?.name||'',items:[{desc:'',qty:1,price:0,unit:'',remise:0}],type:newType,subtype:'standard',date:new Date().toLocaleDateString('fr-FR'),due:'',siret:bizConfig.siret,tva:bizConfig.tvaNum,addr:bizConfig.addr,cAddr:'',siren:'',opType:'PS',tvaDebit:false,payTerms:'net30'}:invoices.find(i=>i.id===id);if(!inv)return;
  if(!isNew&&(inv.status==='Pay√©e'||inv.subtype==='avoir')){toast('üîí Document verrouill√© ‚Äî cr√©ez un avoir pour corriger');return;}
  const lineRow=(l)=>`<div style="display:grid;grid-template-columns:1fr 80px 55px 65px 55px 20px;gap:5px;margin-bottom:5px;align-items:center"><input class="ild" value="${l.desc}" placeholder="Description" style="padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none"><select class="ilu" style="padding:8px 4px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none">${UNITS.map(u=>'<option value="'+u.v+'" '+(u.v===(l.unit||'')?'selected':'')+'>'+u.l+'</option>').join('')}</select><input class="ilq" type="number" value="${l.qty}" placeholder="Qt√©" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;text-align:center"><input class="ilp" type="number" value="${l.price}" placeholder="‚Ç¨ HT" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;text-align:right"><input class="ilr" type="number" value="${l.remise||0}" placeholder="%" min="0" max="100" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none;text-align:center"><span onclick="this.parentElement.remove()" style="cursor:pointer;color:var(--accent2);text-align:center;font-size:14px">√ó</span></div>`;
  showModal(`<h2>üßæ ${isNew?(inv.type==='quote'?'Nouveau devis':'Nouvelle facture'):'Modifier '+inv.num}<button class="modal-close" onclick="closeModal()">√ó</button></h2>
  <div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--muted);margin-bottom:12px">${inv.num}${inv.subtype&&inv.subtype!=='standard'?' ¬∑ <span style="color:'+color+';font-weight:700">'+inv.subtype.toUpperCase()+'</span>':''}</div>
  <div class="field-row"><div class="field"><label>Client</label><select id="miC">${contacts.map(c=>'<option '+(c.name===inv.client?'selected':'')+'>'+c.name+'</option>').join('')}</select></div><div class="field"><label>Conditions de paiement</label><select id="miPT">${PAY_TERMS.map(p=>'<option value="'+p.v+'" '+(p.v===(inv.payTerms||'net30')?'selected':'')+'>'+p.l+'</option>').join('')}</select></div></div>
  <div class="field-row"><div class="field"><label>Date d'√©mission</label><input id="miDt" value="${inv.date}"></div><div class="field"><label>√âch√©ance</label><input id="miDu" value="${inv.due}" placeholder="JJ/MM/AAAA"></div></div>
  <div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1.5px;margin:12px 0 6px">INFORMATIONS L√âGALES</div>
  <div class="field-row"><div class="field"><label>SIRET</label><input id="miSi" value="${inv.siret}"></div><div class="field"><label>N¬∞ TVA</label><input id="miTv" value="${inv.tva}"></div></div>
  <div class="field"><label>Adresse entreprise</label><input id="miAd" value="${inv.addr}"></div>
  <div class="field-row"><div class="field"><label>Adresse client</label><input id="miCA" value="${inv.cAddr||''}"></div><div class="field"><label>SIREN client</label><input id="miSiren" value="${inv.siren||''}" placeholder="XXX XXX XXX"></div></div>
  <div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1.5px;margin:12px 0 6px">E-FACTURATION 2026</div>
  <div class="field-row"><div class="field"><label>Cat√©gorie</label><select id="miOp"><option value="PS" ${(inv.opType||'PS')==='PS'?'selected':''}>PS ‚Äî Prestation de services</option><option value="LB" ${inv.opType==='LB'?'selected':''}>LB ‚Äî Livraison de biens</option><option value="LBPS" ${inv.opType==='LBPS'?'selected':''}>LBPS ‚Äî Mixte</option></select></div><div class="field"><label style="display:flex;align-items:center;gap:8px;margin-top:18px"><input type="checkbox" id="miTvaD" ${inv.tvaDebit?'checked':''}> TVA sur les d√©bits</label></div></div>
  <div style="font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1.5px;margin:12px 0 6px">LIGNES</div>
  <div style="display:grid;grid-template-columns:1fr 80px 55px 65px 55px 20px;gap:5px;margin-bottom:5px;font-size:10px;color:var(--muted);padding:0 2px"><span>Description</span><span>Unit√©</span><span style="text-align:center">Qt√©</span><span style="text-align:right">P.U. HT</span><span style="text-align:center">Rem%</span><span></span></div>
  <div id="invL">${(inv.items||[{desc:'',qty:1,price:0,unit:'',remise:0}]).map(l=>lineRow(l)).join('')}</div>
  <div style="font-size:13px;color:${color};cursor:pointer;font-weight:600;margin-bottom:14px" onclick="document.getElementById('invL').insertAdjacentHTML('beforeend',addLineHTML())">+ Ajouter une ligne</div>
  <button class="btn-full" style="background:${color};color:var(--bg)" onclick="saveInv(${id||'null'},'${inv.type}','${inv.num}','${inv.subtype||'standard'}')">${isNew?'Cr√©er':'Sauvegarder'} ‚Üí</button>`,true);
}
function addLineHTML(){return '<div style="display:grid;grid-template-columns:1fr 80px 55px 65px 55px 20px;gap:5px;margin-bottom:5px;align-items:center"><input class="ild" placeholder="Description" style="padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none"><select class="ilu" style="padding:8px 4px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none">'+UNITS.map(u=>'<option value="'+u.v+'">'+u.l+'</option>').join('')+'</select><input class="ilq" type="number" value="1" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;text-align:center"><input class="ilp" type="number" value="0" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;text-align:right"><input class="ilr" type="number" value="0" min="0" max="100" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none;text-align:center"><span onclick="this.parentElement.remove()" style="cursor:pointer;color:var(--accent2);text-align:center;font-size:14px">√ó</span></div>';}
function saveInv(id,type,num,subtype){const ds=document.querySelectorAll('.ild'),qs=document.querySelectorAll('.ilq'),ps=document.querySelectorAll('.ilp'),us=document.querySelectorAll('.ilu'),rs=document.querySelectorAll('.ilr');const items=[];ds.forEach((_,i)=>{if(ds[i].value)items.push({desc:ds[i].value,qty:parseInt(qs[i].value)||1,price:parseFloat(ps[i].value)||0,unit:us[i]?.value||'',remise:parseInt(rs[i]?.value)||0});});const o={num,client:document.getElementById('miC').value,items,status:type==='quote'?'Devis envoy√©':'En attente',type,subtype:subtype||'standard',date:document.getElementById('miDt').value,due:document.getElementById('miDu').value,siret:document.getElementById('miSi').value,tva:document.getElementById('miTv').value,addr:document.getElementById('miAd').value,cAddr:document.getElementById('miCA').value,siren:document.getElementById('miSiren').value,opType:document.getElementById('miOp').value,tvaDebit:document.getElementById('miTvaD').checked,payTerms:document.getElementById('miPT')?.value||'net30'};if(id&&id!=='null'){const idx=invoices.findIndex(i=>i.id===parseInt(id));if(idx>=0){o.id=parseInt(id);o.status=invoices[idx].status;o.paidDate=invoices[idx].paidDate;o.payMode=invoices[idx].payMode;invoices[idx]={...invoices[idx],...o};}}else{o.id=Date.now();invoices.unshift(o);}closeModal();renderDemo();toast('‚úÖ '+num+' ‚Äî '+invTotal(items)+'‚Ç¨ HT');}
// ===== COMPTABILIT√â =====
function isMicro(){return bizType==='micro';}
function tvaApplicable(){return !bizConfig.tvaFranchise;}
function getLegalMention(){if(isMicro()&&bizConfig.tvaFranchise)return'TVA non applicable, article 293 B du CGI';return'';}
function pgCompta(){
  const paidInv=invoices.filter(i=>i.type==='invoice'&&i.status==='Pay√©e');
  const recettes=paidInv.map(inv=>({date:inv.paidDate||inv.date,num:inv.num,client:inv.client,desc:inv.items.map(l=>l.desc).join(', '),amount:invTotal(inv.items),tva:tvaApplicable()?Math.round(invTotal(inv.items)*bizConfig.tvaRate/100):0,mode:inv.payMode||'Virement',ref:inv.num}));
  const totalR=recettes.reduce((a,b)=>a+b.amount,0);
  const totalTVAC=recettes.reduce((a,b)=>a+b.tva,0);
  const isMic=isMicro();
  const totalExp=expenses.reduce((a,b)=>a+b.amount,0);
  const totalTVAD=expenses.reduce((a,b)=>a+(b.tva||0),0);
  const thS='padding:12px 10px;text-align:left;font-size:12px;white-space:nowrap';
  const thR='padding:12px 10px;text-align:right;font-size:12px;white-space:nowrap';
  const tdS='padding:11px 10px;font-size:13px';
  const tdR='padding:11px 10px;font-size:13px;text-align:right';
  const mono="font-family:'JetBrains Mono',monospace";
  const cols=!isMic?`<colgroup><col style="width:11%"><col style="width:12%"><col style="width:20%"><col style="width:18%"><col style="width:10%"><col style="width:10%"><col style="width:10%"><col style="width:9%"></colgroup>`:`<colgroup><col style="width:13%"><col style="width:14%"><col style="width:22%"><col style="width:22%"><col style="width:16%"><col style="width:13%"></colgroup>`;
  return`<div class="page-head"><h1>${isMic?'üìí Livre de recettes':'üìí Journal des op√©rations'}</h1><p style="font-size:13px">${isMic?'Registre chronologique obligatoire ‚Äî Art. L123-28 du Code de commerce':'Comptabilit√© de tr√©sorerie ‚Äî R√©gime r√©el simplifi√©'}</p></div>
  ${isMic?`<div style="padding:14px 18px;border-radius:12px;background:rgba(0,212,170,.04);border:1px solid rgba(0,212,170,.1);margin-bottom:16px;font-size:13px;color:var(--muted)">üìã Ce registre est <strong>auto-aliment√©</strong> depuis vos factures pass√©es en "Pay√©e". Il constitue votre livre de recettes l√©gal. ${getLegalMention()?'<br>Mention applicable : <em>'+getLegalMention()+'</em>':''}</div>`:`<div style="padding:14px 18px;border-radius:12px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.1);margin-bottom:16px;font-size:13px;color:var(--muted)">üìã Journal des encaissements et d√©caissements. Les cr√©ances et dettes sont constat√©es √† la cl√¥ture. <strong>TVA ${bizConfig.tvaRate}%</strong> applicable.</div>`}
  <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center"><span>RECETTES${isMic?'':' (ENCAISSEMENTS)'}</span><span style="color:${color};${mono};font-size:15px">${totalR.toLocaleString()}‚Ç¨${!isMic?' HT':' TTC'}</span></div>
  <div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:visible;margin-bottom:18px">
  <table style="width:100%;border-collapse:collapse;table-layout:fixed">${cols}
  <thead><tr style="border-bottom:1px solid var(--border);color:var(--muted)"><th style="${thS}">Date</th><th style="${thS}">N¬∞ Pi√®ce</th><th style="${thS}">Client</th><th style="${thS}">Nature</th>${!isMic?`<th style="${thR}">HT</th><th style="${thR}">TVA</th>`:''}<th style="${thR}">${isMic?'Montant TTC':'TTC'}</th><th style="${thS}">R√®glement</th></tr></thead>
  <tbody>${recettes.length?recettes.map(r=>`<tr style="border-bottom:1px solid rgba(255,255,255,.04)"><td style="${tdS}">${r.date}</td><td style="${tdS};${mono}">${r.num}</td><td style="${tdS};font-weight:500">${r.client}</td><td style="${tdS};color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.desc}</td>${!isMic?`<td style="${tdR};${mono}">${r.amount.toLocaleString()}‚Ç¨</td><td style="${tdR};color:var(--muted)">${r.tva}‚Ç¨</td>`:''}<td style="${tdR};font-weight:700;${mono};color:${color}">${isMic?r.amount.toLocaleString():(r.amount+r.tva).toLocaleString()}‚Ç¨</td><td style="${tdS}">${r.mode}</td></tr>`).join(''):'<tr><td colspan="8" style="padding:24px;text-align:center;color:var(--muted);font-size:13px">Les factures marqu√©es "Pay√©e" appara√Ætront ici automatiquement</td></tr>'}</tbody>
  ${recettes.length?`<tfoot><tr style="border-top:2px solid var(--border)"><td colspan="${isMic?4:5}" style="padding:12px 10px;font-weight:700;font-size:13px">TOTAL</td>${!isMic?`<td style="padding:12px 10px;text-align:right;font-weight:700;${mono};font-size:13px">${totalTVAC.toLocaleString()}‚Ç¨</td>`:''}<td style="padding:12px 10px;text-align:right;font-weight:700;${mono};font-size:14px;color:${color}">${isMic?totalR.toLocaleString():(totalR+totalTVAC).toLocaleString()}‚Ç¨</td><td></td></tr></tfoot>`:''}
  </table></div>
  ${!isMic?`<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center"><span>D√âPENSES (D√âCAISSEMENTS)</span><span style="color:var(--accent2);${mono};font-size:15px">${totalExp.toLocaleString()}‚Ç¨ HT</span></div>
  <div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:visible;margin-bottom:18px">
  <table style="width:100%;border-collapse:collapse;table-layout:fixed">${cols}
  <thead><tr style="border-bottom:1px solid var(--border);color:var(--muted)"><th style="${thS}">Date</th><th style="${thS}">N¬∞ Pi√®ce</th><th style="${thS}">Description</th><th style="${thS}">Cat√©gorie</th><th style="${thR}">HT</th><th style="${thR}">TVA d√©d.</th><th style="${thR}">TTC</th><th style="${thS}">R√®glement</th></tr></thead>
  <tbody>${expenses.map(e=>`<tr style="border-bottom:1px solid rgba(255,255,255,.04)"><td style="${tdS}">${e.date}</td><td style="${tdS};${mono}">${e.ref}</td><td style="${tdS};font-weight:500">${e.desc}</td><td style="${tdS};color:var(--muted)">${e.cat}</td><td style="${tdR};${mono}">${e.amount}‚Ç¨</td><td style="${tdR};color:var(--muted)">${e.tva||0}‚Ç¨</td><td style="${tdR};font-weight:700;${mono};color:var(--accent2)">${e.amount+(e.tva||0)}‚Ç¨</td><td style="${tdS}">${e.mode}</td></tr>`).join('')}</tbody>
  <tfoot><tr style="border-top:2px solid var(--border)"><td colspan="4" style="padding:12px 10px;font-weight:700;font-size:13px">TOTAL</td><td style="padding:12px 10px;text-align:right;font-weight:700;${mono};font-size:13px">${totalExp}‚Ç¨</td><td style="padding:12px 10px;text-align:right;font-weight:700;${mono};font-size:13px">${totalTVAD}‚Ç¨</td><td style="padding:12px 10px;text-align:right;font-weight:700;${mono};font-size:14px;color:var(--accent2)">${totalExp+totalTVAD}‚Ç¨</td><td></td></tr></tfoot>
  </table></div>
  <div style="padding:16px 20px;border-radius:12px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.1);display:flex;justify-content:space-between;align-items:center"><div style="font-size:14px"><strong>Solde TVA</strong> <span style="color:var(--muted)">(collect√©e ‚àí d√©ductible)</span></div><div style="font-size:18px;font-weight:800;${mono};color:${(totalTVAC-totalTVAD)>=0?'var(--accent2)':color}">${(totalTVAC-totalTVAD)>=0?'√Ä reverser':'Cr√©dit TVA'} : ${Math.abs(totalTVAC-totalTVAD).toLocaleString()}‚Ç¨</div></div>`:''}
  ${isMic?`<div style="margin-top:18px;padding:16px 18px;border-radius:12px;background:var(--card);border:1px solid var(--border)"><div style="font-size:14px;font-weight:700;margin-bottom:10px">üìÖ R√©cap pour d√©claration URSSAF</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">${['Janvier','F√©vrier','Mars'].map((m,i)=>{const v=[960,200,0][i];return`<div style="padding:12px;border-radius:8px;background:var(--bg);text-align:center"><div style="font-size:12px;color:var(--muted)">${m} 2026</div><div style="font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-top:4px">${v.toLocaleString()}‚Ç¨</div><div style="font-size:11px;color:var(--muted);margin-top:2px">Cotis. ‚âà ${Math.round(v*bizConfig.urssafRate/100)}‚Ç¨</div></div>`;}).join('')}</div><div style="font-size:11px;color:var(--muted);margin-top:10px">Taux cotisations : ${bizConfig.urssafRate}% ¬∑ ${bizConfig.tvaFranchise?getLegalMention():''}</div></div>`:''}`;}
function pgFinDash(){
  const allInv=invoices.filter(i=>i.type==='invoice');
  const paid=allInv.filter(i=>i.status==='Pay√©e');const paidHT=paid.reduce((a,b)=>a+invTotal(b.items),0);
  const pending=allInv.filter(i=>i.status==='En attente');const pendingHT=pending.reduce((a,b)=>a+invTotal(b.items),0);
  const late=allInv.filter(i=>i.status==='En retard');const lateHT=late.reduce((a,b)=>a+invTotal(b.items),0);
  const allQ=invoices.filter(i=>i.type==='quote');const quotesHT=allQ.reduce((a,b)=>a+invTotal(b.items),0);
  const accepted=allQ.filter(i=>i.status==='Accept√©'||i.status==='Converti');
  const convRate=allQ.length?Math.round(accepted.length/allQ.length*100):0;
  const totalExp=expenses.reduce((a,b)=>a+b.amount,0);
  const totalTVAC=tvaApplicable()?Math.round(paidHT*bizConfig.tvaRate/100):0;
  const totalTVAD=expenses.reduce((a,b)=>a+(b.tva||0),0);
  const isMic=isMicro();
  const result=paidHT-totalExp;
  const months=['Sep','Oct','Nov','D√©c','Jan','F√©v'];const caData=[320,480,720,580,960,paidHT];
  return`<div class="page-head"><h1>üìä Tableau de bord financier</h1><p>${isMic?'Micro-entreprise':'Soci√©t√© ‚Äî R√©gime r√©el simplifi√©'} ¬∑ Exercice 2026</p></div>
  <div class="stats" style="grid-template-columns:repeat(${isMic?3:4},1fr)">
    <div class="stat"><div class="s-label">CA encaiss√©${isMic?' TTC':' HT'}</div><div class="s-value" style="color:${color}">${isMic?paidHT.toLocaleString():paidHT.toLocaleString()}‚Ç¨</div><div class="s-change up">${paid.length} facture${paid.length>1?'s':''}</div></div>
    <div class="stat"><div class="s-label">En attente + retard</div><div class="s-value" style="color:#eab308">${(pendingHT+lateHT).toLocaleString()}‚Ç¨</div><div class="s-change">${pending.length+late.length} facture${pending.length+late.length>1?'s':''}</div></div>
    ${isMic?`<div class="stat"><div class="s-label">Cotisations URSSAF</div><div class="s-value" style="color:var(--accent2)">‚âà ${Math.round(paidHT*bizConfig.urssafRate/100).toLocaleString()}‚Ç¨</div><div class="s-change">Taux ${bizConfig.urssafRate}%</div></div>`:`<div class="stat"><div class="s-label">D√©penses HT</div><div class="s-value" style="color:var(--accent2)">${totalExp.toLocaleString()}‚Ç¨</div></div>
    <div class="stat"><div class="s-label">R√©sultat</div><div class="s-value" style="color:${result>=0?color:'var(--accent2)'}">${result>=0?'+':''}${result.toLocaleString()}‚Ç¨</div><div class="s-change">${result>=0?'B√©n√©fice':'D√©ficit'}</div></div>`}
  </div>
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-top:14px">
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:14px">CA ‚Äî 6 derniers mois</div>
      <div class="chart-bars">${caData.map((v,i)=>{const max=Math.max(...caData);return`<div class="chart-bar-w"><div class="chart-val" style="color:${color}">${v}‚Ç¨</div><div class="chart-bar" style="height:${max?Math.round(v/max*100):0}%;background:${i===5?color:color+'50'}"></div><div class="chart-lab">${months[i]}</div></div>`;}).join('')}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
        <div style="font-size:12px;font-weight:700;margin-bottom:10px">Pipeline devis</div>
        <div style="font-size:22px;font-weight:800;color:${color}">${quotesHT.toLocaleString()}‚Ç¨</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${allQ.length} devis ¬∑ ${convRate}% conversion</div>
      </div>
      ${!isMic?`<div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
        <div style="font-size:12px;font-weight:700;margin-bottom:10px">Solde TVA</div>
        <div style="font-size:18px;font-weight:800;color:${(totalTVAC-totalTVAD)>=0?'var(--accent2)':color}">${Math.abs(totalTVAC-totalTVAD).toLocaleString()}‚Ç¨</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${(totalTVAC-totalTVAD)>=0?'√Ä reverser au Tr√©sor':'Cr√©dit de TVA'}</div>
      </div>`:
      `<div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
        <div style="font-size:12px;font-weight:700;margin-bottom:10px">Prochaine d√©claration</div>
        <div style="font-size:16px;font-weight:700;color:${color}">30 avril 2026</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">D√©cl. trimestrielle URSSAF</div>
      </div>`}
    </div>
  </div>
  ${late.length?`<div style="margin-top:14px;padding:14px 16px;border-radius:12px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.1)"><div style="font-size:13px;font-weight:700;color:var(--accent2);margin-bottom:8px">‚ö† Factures en retard</div>${late.map(inv=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:12px"><span>${inv.client} ‚Äî ${inv.num}</span><span style="font-weight:700;color:var(--accent2)">${Math.round(invTotal(inv.items)*1.2).toLocaleString()}‚Ç¨</span></div>`).join('')}</div>`:''}`;}
// ===== EMAILING ‚Äî MINI BREVO =====
function pgEmail(){
  if(emView==='create')return pgEmailCreate();
  if(emView==='analytics'&&curCampaign)return pgEmailAnalytics();
  return pgEmailCampaigns();
}
function pgEmailCampaigns(){
  const totalSent=campaigns.reduce((a,c)=>a+c.stats.sent,0),totalOpened=campaigns.reduce((a,c)=>a+c.stats.opened,0),totalClicked=campaigns.reduce((a,c)=>a+c.stats.clicked,0);
  const openRate=totalSent?Math.round(totalOpened/totalSent*100):0,clickRate=totalOpened?Math.round(totalClicked/totalOpened*100):0;
  return `<div class="page-head"><h1>Emailing</h1><p>${campaigns.length} campagnes ¬∑ ${totalSent} emails envoy√©s</p></div>
  <div class="stats"><div class="stat"><div class="s-label">Emails envoy√©s</div><div class="s-value" style="color:${color}">${totalSent}</div></div><div class="stat"><div class="s-label">Taux d'ouverture</div><div class="s-value">${openRate}%</div><div class="s-change up">‚Üë vs moyenne secteur</div></div><div class="stat"><div class="s-label">Taux de clic</div><div class="s-value">${clickRate}%</div></div><div class="stat"><div class="s-label">D√©sabonnements</div><div class="s-value" style="color:var(--accent)">${campaigns.reduce((a,c)=>a+c.stats.unsub,0)}</div></div></div>
  <div style="display:flex;gap:8px;margin-bottom:16px"><button onclick="startNewCampaign()" style="padding:10px 22px;border-radius:10px;border:none;background:${color};color:var(--bg);font-weight:700;font-size:14px;cursor:pointer;font-family:inherit">+ Nouvelle campagne</button></div>
  <div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:hidden">
    <table class="dt"><thead><tr><th>Campagne</th><th>Statut</th><th>Audience</th><th>Envoy√©s</th><th>Ouverture</th><th>Clics</th><th></th></tr></thead><tbody>
    ${campaigns.map(c=>{const or=c.stats.sent?Math.round(c.stats.opened/c.stats.sent*100):0;const cr=c.stats.opened?Math.round(c.stats.clicked/c.stats.opened*100):0;
    return`<tr><td><div style="font-weight:600">${c.name}</div><div style="font-size:10px;color:var(--muted);margin-top:1px">${c.subject}</div></td>
    <td><span class="badge badge-${c.status==='sent'?'g':c.status==='scheduled'?'b':c.status==='sending'?'o':'m'}">${c.status==='sent'?'‚úì Envoy√©e':c.status==='scheduled'?'‚è∞ Programm√©e':c.status==='sending'?'‚è≥ En cours':'üìù Brouillon'}</span></td>
    <td style="font-size:12px;color:var(--muted)">${c.audienceCount} contacts</td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:12px">${c.stats.sent||'‚Äî'}</td>
    <td>${c.stats.sent?`<div style="display:flex;align-items:center;gap:6px"><div style="width:40px;height:4px;border-radius:2px;background:var(--border)"><div style="width:${or}%;height:100%;border-radius:2px;background:${or>70?color:or>40?'#eab308':'var(--accent2)'}"></div></div><span style="font-size:11px;font-weight:600;color:${or>70?color:'var(--muted)'}">${or}%</span></div>`:'‚Äî'}</td>
    <td>${c.stats.sent?`<span style="font-size:11px;font-weight:600">${cr}%</span>`:'‚Äî'}</td>
    <td style="white-space:nowrap">${c.status==='sent'?`<button onclick="viewCampaignStats(${c.id})" style="background:none;border:none;color:${color};cursor:pointer;font-size:11px;font-weight:600;font-family:inherit">üìä Stats</button>`:`<button onclick="editCampaign(${c.id})" style="background:none;border:none;color:${color};cursor:pointer;font-size:11px;font-weight:600;font-family:inherit">Modifier</button>`} <button onclick="dupCampaign(${c.id})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;font-family:inherit">Dupliquer</button> <button onclick="campaigns=campaigns.filter(x=>x.id!==${c.id});renderDemo();toast('üóë Campagne supprim√©e')" style="background:none;border:none;color:var(--accent2);cursor:pointer;font-size:11px;font-family:inherit">√ó</button></td></tr>`;}).join('')}
    </tbody></table></div>`;
}
function startNewCampaign(){emView='create';emStep=1;editBlocks=[{type:"header",content:"Mon Entreprise"},{type:"text",content:"Bonjour {{prenom}},"},{type:"footer",content:"Se d√©sabonner"}];editSubject='';editName='';editAudience='all';editSchedule='now';editScheduleDate='';editABtest=false;editSubjectB='';renderDemo();}
function editCampaign(id){const c=campaigns.find(x=>x.id===id);if(!c)return;emView='create';emStep=2;editBlocks=JSON.parse(JSON.stringify(c.blocks));editSubject=c.subject;editName=c.name;editAudience=c.audience;curCampaign=c;renderDemo();}
function dupCampaign(id){const c=campaigns.find(x=>x.id===id);if(!c)return;campaigns.unshift({...JSON.parse(JSON.stringify(c)),id:Date.now(),name:c.name+' (copie)',status:'draft',stats:{sent:0,opened:0,clicked:0,unsub:0}});renderDemo();toast('üìã Campagne dupliqu√©e');}
function viewCampaignStats(id){curCampaign=campaigns.find(x=>x.id===id);if(!curCampaign)return;emView='analytics';renderDemo();}
function pgEmailCreate(){
  const steps=[{n:"Template",icon:"üìê"},{n:"Contenu",icon:"‚úèÔ∏è"},{n:"Audience",icon:"üë•"},{n:"Envoi",icon:"üöÄ"}];
  return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:24px"><button onclick="emView='campaigns';curCampaign=null;renderDemo()" style="background:none;border:none;color:${color};cursor:pointer;font-size:13px;font-weight:600;font-family:inherit">‚Üê Campagnes</button><div style="width:1px;height:20px;background:var(--border)"></div><span style="font-size:16px;font-weight:800">${editName||'Nouvelle campagne'}</span></div>
  <div style="display:flex;gap:4px;margin-bottom:24px">${steps.map((s,i)=>`<div onclick="emStep=${i+1};renderDemo()" style="flex:1;padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all .2s;${emStep===i+1?`background:${color}15;border:1px solid ${color}40;color:${color}`:`background:var(--card);border:1px solid var(--border);color:var(--muted)`}"><div style="font-size:16px">${s.icon}</div><div style="font-size:11px;font-weight:600;margin-top:2px">${s.n}</div></div>`).join('')}</div>
  ${emStep===1?pgEmailStep1():emStep===2?pgEmailStep2():emStep===3?pgEmailStep3():pgEmailStep4()}`;
}
function pgEmailStep1(){
  return `<div style="font-size:14px;font-weight:700;margin-bottom:16px">Choisissez un template</div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px">
  ${TEMPLATES.map((t,i)=>`<div onclick="editBlocks=JSON.parse(JSON.stringify(TEMPLATES[${i}].blocks));emStep=2;renderDemo()" style="padding:20px;border-radius:14px;border:1px solid var(--border);background:var(--card);cursor:pointer;transition:all .3s;text-align:center" onmouseover="this.style.borderColor='${color}40'" onmouseout="this.style.borderColor='var(--border)'"><div style="font-size:28px;margin-bottom:8px">${t.icon}</div><div style="font-size:13px;font-weight:700">${t.name}</div></div>`).join('')}
  </div>`;
}
function pgEmailStep2(){
  return `<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div>
      <div class="field"><label>Nom de la campagne</label><input value="${editName}" oninput="editName=this.value" placeholder="Ex: Newsletter Mars" style="padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%"></div>
      <div class="field"><label>Objet de l'email</label><input value="${editSubject}" oninput="editSubject=this.value" placeholder="üéÅ Votre offre exclusive" style="padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%"></div>
      <div style="margin-bottom:12px"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--muted)"><input type="checkbox" ${editABtest?'checked':''} onchange="editABtest=this.checked;renderDemo()"> A/B test sur l'objet</label></div>
      ${editABtest?`<div class="field"><label>Objet B (envoy√© √† 50% de l'audience)</label><input value="${editSubjectB}" oninput="editSubjectB=this.value" placeholder="Variante B de l'objet" style="padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%"></div>`:''}
      <div style="font-size:10px;font-weight:700;color:#555;letter-spacing:1.5px;margin:14px 0 8px">BLOCS DE CONTENU</div>
      <div id="eBlocks">${editBlocks.map((b,i)=>renderEditBlock(b,i)).join('')}</div>
      <div style="display:flex;gap:4px;margin:10px 0;flex-wrap:wrap">
        ${[{t:'text',l:'Texte',i:'üìù'},{t:'button',l:'Bouton',i:'üîò'},{t:'image',l:'Image',i:'üì∑'},{t:'divider',l:'Ligne',i:'‚ûñ'},{t:'spacer',l:'Espace',i:'‚ÜïÔ∏è'},{t:'social',l:'R√©seaux',i:'üîó'}].map(x=>`<button onclick="addEditBlock('${x.t}')" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:3px">${x.i} ${x.l}</button>`).join('')}
      </div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:12px">Variables : <code style="background:var(--bg);padding:2px 6px;border-radius:4px">{{prenom}}</code> <code style="background:var(--bg);padding:2px 6px;border-radius:4px">{{nom}}</code> <code style="background:var(--bg);padding:2px 6px;border-radius:4px">{{email}}</code></div>
      <div style="display:flex;gap:8px"><button onclick="emStep=3;renderDemo()" style="flex:1;padding:12px;border-radius:10px;border:none;background:${color};color:var(--bg);font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">Suivant : Audience ‚Üí</button><button onclick="saveDraft()" style="padding:12px 20px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Brouillon</button></div>
    </div>
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-size:13px;font-weight:700">üëÅ Aper√ßu</div>
      <div style="display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--border)">${['desktop','mobile'].map(m=>`<button onclick="emPreviewMode='${m}';renderDemo()" style="padding:5px 12px;border:none;font-size:11px;cursor:pointer;font-family:inherit;${emPreviewMode===m?`background:${color};color:var(--bg);font-weight:700`:'background:var(--card);color:var(--muted)'}">${m==='desktop'?'üñ• Desktop':'üì± Mobile'}</button>`).join('')}</div></div>
      <div style="padding:${emPreviewMode==='mobile'?'0 60px':'0'};transition:padding .3s">
        <div style="background:#fff;border-radius:${emPreviewMode==='mobile'?'20px':'12px'};overflow:hidden;${emPreviewMode==='mobile'?'border:3px solid #333;':''}max-width:${emPreviewMode==='mobile'?'320px':'100%'};margin:0 auto">
          <div style="padding:8px 12px;background:#f5f5f5;font-size:10px;color:#888;border-bottom:1px solid #eee"><strong style="color:#333">De:</strong> Mon Entreprise &lt;hello@monentreprise.fr&gt;<br><strong style="color:#333">Objet:</strong> ${editSubject||'(sans objet)'}</div>
          ${renderEmailPreview(editBlocks)}
        </div>
      </div>
      ${editABtest?`<div style="margin-top:12px;padding:12px;border-radius:10px;border:1px solid rgba(96,165,250,.2);background:rgba(96,165,250,.04)"><div style="font-size:11px;font-weight:700;color:#60a5fa;margin-bottom:4px">üîÄ A/B Test actif</div><div style="font-size:11px;color:var(--muted)"><strong>A:</strong> ${editSubject||'‚Äî'}<br><strong>B:</strong> ${editSubjectB||'‚Äî'}<br>50% de l'audience recevra chaque version</div></div>`:''}
    </div>
  </div>`;
}
function pgEmailStep3(){
  return `<div style="max-width:600px"><div style="font-size:14px;font-weight:700;margin-bottom:16px">Choisissez votre audience</div>
  <div style="display:grid;gap:8px">
  ${AUDIENCES.map(a=>{const cnt=getAudienceCount(a.id);return`<div onclick="editAudience='${a.id}';renderDemo()" style="padding:16px 20px;border-radius:12px;border:2px solid ${editAudience===a.id?color:'var(--border)'};background:${editAudience===a.id?color+'08':'var(--card)'};cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:14px"><div style="font-size:22px">${a.icon}</div><div style="flex:1"><div style="font-size:14px;font-weight:600">${a.name}</div><div style="font-size:12px;color:var(--muted)">${cnt} contact${cnt>1?'s':''}</div></div>${editAudience===a.id?`<div style="width:24px;height:24px;border-radius:50%;background:${color};display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--bg);font-weight:800">‚úì</div>`:''}</div>`;}).join('')}
  </div>
  <div style="margin-top:20px;padding:16px;border-radius:12px;background:var(--card);border:1px solid var(--border)"><div style="font-size:12px;font-weight:700;margin-bottom:8px">üìã R√©sum√© de l'audience</div><div style="font-size:13px;color:var(--muted)">${getAudienceCount(editAudience)} contacts recevront cet email${editABtest?` ¬∑ A/B test : ${Math.ceil(getAudienceCount(editAudience)/2)} par version`:''}</div></div>
  <div style="display:flex;gap:8px;margin-top:16px"><button onclick="emStep=2;renderDemo()" style="padding:12px 20px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;cursor:pointer;font-family:inherit">‚Üê Retour</button><button onclick="emStep=4;renderDemo()" style="flex:1;padding:12px;border-radius:10px;border:none;background:${color};color:var(--bg);font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">Suivant : Envoi ‚Üí</button></div></div>`;
}
function pgEmailStep4(){
  const cnt=getAudienceCount(editAudience);const audName=AUDIENCES.find(a=>a.id===editAudience)?.name||'';
  return `<div style="max-width:600px"><div style="font-size:14px;font-weight:700;margin-bottom:16px">Planifiez l'envoi</div>
  <div style="display:grid;gap:8px;margin-bottom:20px">
    <div onclick="editSchedule='now';renderDemo()" style="padding:16px 20px;border-radius:12px;border:2px solid ${editSchedule==='now'?color:'var(--border)'};background:${editSchedule==='now'?color+'08':'var(--card)'};cursor:pointer;display:flex;align-items:center;gap:14px"><div style="font-size:22px">‚ö°</div><div><div style="font-size:14px;font-weight:600">Envoyer maintenant</div><div style="font-size:12px;color:var(--muted)">La campagne part imm√©diatement</div></div></div>
    <div onclick="editSchedule='scheduled';renderDemo()" style="padding:16px 20px;border-radius:12px;border:2px solid ${editSchedule==='scheduled'?color:'var(--border)'};background:${editSchedule==='scheduled'?color+'08':'var(--card)'};cursor:pointer;display:flex;align-items:center;gap:14px"><div style="font-size:22px">‚è∞</div><div><div style="font-size:14px;font-weight:600">Programmer</div><div style="font-size:12px;color:var(--muted)">Choisissez la date et l'heure</div></div></div>
  </div>
  ${editSchedule==='scheduled'?`<div class="field-row" style="margin-bottom:16px"><div class="field"><label>Date</label><input type="date" value="${editScheduleDate}" onchange="editScheduleDate=this.value" style="padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%"></div><div class="field"><label>Heure</label><input type="time" value="10:00" style="padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;width:100%"></div></div>`:''}
  <div style="padding:20px;border-radius:14px;background:var(--card);border:1px solid var(--border);margin-bottom:20px"><div style="font-size:13px;font-weight:700;margin-bottom:12px">üìã R√©capitulatif</div>
    <div style="display:grid;gap:6px;font-size:13px">
      <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Campagne</span><span style="font-weight:600">${editName||'Sans nom'}</span></div>
      <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Objet</span><span style="font-weight:600">${editSubject||'‚Äî'}</span></div>
      ${editABtest?`<div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Objet B</span><span style="font-weight:600">${editSubjectB||'‚Äî'}</span></div>`:''}
      <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Audience</span><span style="font-weight:600">${audName} (${cnt})</span></div>
      <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Envoi</span><span style="font-weight:600">${editSchedule==='now'?'Imm√©diat':'Programm√©'}</span></div>
      <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Blocs</span><span style="font-weight:600">${editBlocks.length} √©l√©ments</span></div>
    </div>
  </div>
  <div style="display:flex;gap:8px"><button onclick="emStep=3;renderDemo()" style="padding:12px 20px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;cursor:pointer;font-family:inherit">‚Üê Retour</button><button onclick="launchCampaign()" style="flex:1;padding:14px;border-radius:10px;border:none;background:${color};color:var(--bg);font-size:15px;font-weight:700;cursor:pointer;font-family:inherit">${editSchedule==='now'?'üöÄ Envoyer maintenant':'‚è∞ Programmer l\'envoi'}</button></div></div>`;
}
function pgEmailAnalytics(){
  const c=curCampaign;if(!c)return pgEmailCampaigns();
  const or=c.stats.sent?Math.round(c.stats.opened/c.stats.sent*100):0,cr=c.stats.opened?Math.round(c.stats.clicked/c.stats.opened*100):0,ur=c.stats.sent?((c.stats.unsub/c.stats.sent)*100).toFixed(1):0;
  const hours=['08h','10h','12h','14h','16h','18h','20h'];const openData=[5,18,32,12,8,15,10];
  return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:24px"><button onclick="emView='campaigns';curCampaign=null;renderDemo()" style="background:none;border:none;color:${color};cursor:pointer;font-size:13px;font-weight:600;font-family:inherit">‚Üê Campagnes</button><div style="width:1px;height:20px;background:var(--border)"></div><span style="font-size:16px;font-weight:800">${c.name}</span><span class="badge badge-g">Envoy√©e</span></div>
  <div style="font-size:12px;color:var(--muted);margin-bottom:16px">Envoy√©e le ${c.sentAt||'‚Äî'} ¬∑ Objet : "${c.subject}"</div>
  <div class="stats" style="grid-template-columns:repeat(5,1fr)">
    <div class="stat"><div class="s-label">Envoy√©s</div><div class="s-value" style="color:${color}">${c.stats.sent}</div></div>
    <div class="stat"><div class="s-label">Ouverts</div><div class="s-value">${c.stats.opened}</div><div style="font-size:11px;font-weight:700;color:${or>70?color:'var(--muted)'};">${or}%</div></div>
    <div class="stat"><div class="s-label">Cliqu√©s</div><div class="s-value">${c.stats.clicked}</div><div style="font-size:11px;font-weight:700;color:${cr>30?color:'var(--muted)'}">${cr}%</div></div>
    <div class="stat"><div class="s-label">D√©sabonn√©s</div><div class="s-value">${c.stats.unsub}</div><div style="font-size:11px;color:var(--muted)">${ur}%</div></div>
    <div class="stat"><div class="s-label">D√©livrabilit√©</div><div class="s-value" style="color:${color}">99%</div></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:14px">üìà Ouvertures par heure</div>
      <div class="chart-bars" style="height:120px">${openData.map((v,i)=>`<div class="chart-bar-w"><div class="chart-val" style="color:${color}">${v}</div><div class="chart-bar" style="height:${Math.round(v/32*100)}%;background:${color}${i===2?'':'40'}"></div><div class="chart-lab">${hours[i]}</div></div>`).join('')}</div>
    </div>
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:14px">üéØ Performance</div>
      ${[{l:"Ouverture",v:or,t:70,u:"%"},{l:"Clic",v:cr,t:30,u:"%"},{l:"D√©livrabilit√©",v:99,t:95,u:"%"}].map(m=>`<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span style="color:var(--muted)">${m.l}</span><span style="font-weight:700;color:${m.v>=m.t?color:'var(--accent2)'}">${m.v}${m.u} ${m.v>=m.t?'‚úì':'‚ö†'}</span></div><div class="obj-bar"><div class="obj-fill" style="width:${m.v}%;background:${m.v>=m.t?color:m.v>m.t*0.7?'#eab308':'var(--accent2)'}"></div></div></div>`).join('')}
      <div style="margin-top:14px;padding:10px;border-radius:8px;background:rgba(0,212,170,.04);border:1px solid rgba(0,212,170,.1);font-size:11px;color:var(--muted)">${or>70?'üéâ Excellente campagne ! Taux d\'ouverture au-dessus de la moyenne.':'üí° Essayez un objet plus accrocheur pour am√©liorer le taux d\'ouverture.'}</div>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">üë• Top ouvertures</div>
      ${contacts.slice(0,4).map(ct=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.03)"><span class="av" style="background:${color};width:24px;height:24px;font-size:9px">${ct.init}</span><div style="flex:1;font-size:12px">${ct.name}</div><span class="badge badge-g" style="font-size:9px">Ouvert</span></div>`).join('')}
    </div>
    <div style="padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">üîó Liens cliqu√©s</div>
      ${[{l:"Bouton principal",c:28},{l:"Lien dans le texte",c:11},{l:"Se d√©sabonner",c:c.stats.unsub}].map(lk=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.03)"><div style="flex:1;font-size:12px">${lk.l}</div><span style="font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace">${lk.c} clics</span></div>`).join('')}
    </div>
  </div>
  <div style="margin-top:16px;display:flex;gap:8px"><button onclick="dupCampaign(${c.id});emView='campaigns';renderDemo()" style="padding:10px 20px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">üìã Dupliquer cette campagne</button></div>`;
}
// Email block rendering
function renderEditBlock(b,i){const del=`<span class="eb-del" onclick="removeEditBlock(${i})">√ó</span>`;const mvUp=i>0?`<span onclick="moveBlock(${i},-1)" style="cursor:pointer;font-size:12px;color:var(--muted)">‚Üë</span>`:'';const mvDn=i<editBlocks.length-1?`<span onclick="moveBlock(${i},1)" style="cursor:pointer;font-size:12px;color:var(--muted)">‚Üì</span>`:'';const inp=s=>`style="width:100%;padding:7px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none${s||''}"`;const handle=label=>`<div class="eb-handle">${label}<span style="display:flex;gap:6px">${mvUp}${mvDn}${del}</span></div>`;
  if(b.type==='header')return`<div class="eb-block">${handle('EN-T√äTE')}<input value="${b.content}" oninput="editBlocks[${i}].content=this.value;updPreview()" ${inp(';font-weight:700')}></div>`;
  if(b.type==='text')return`<div class="eb-block">${handle('TEXTE')}<textarea oninput="editBlocks[${i}].content=this.value;updPreview()" ${inp(';min-height:50px;resize:vertical')}>${b.content}</textarea></div>`;
  if(b.type==='button')return`<div class="eb-block">${handle('BOUTON')}<div style="display:flex;gap:6px"><input value="${b.content}" oninput="editBlocks[${i}].content=this.value;updPreview()" ${inp('')} style="flex:1;padding:7px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none"><input value="${b.url||'#'}" oninput="editBlocks[${i}].url=this.value" placeholder="URL" style="width:120px;padding:7px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--muted);font-size:11px;font-family:inherit;outline:none"></div></div>`;
  if(b.type==='divider')return`<div class="eb-block">${handle('S√âPARATEUR')}<div style="height:1px;background:var(--border);margin:4px 0"></div></div>`;
  if(b.type==='image')return`<div class="eb-block">${handle('IMAGE')}<div style="height:60px;border-radius:6px;background:var(--bg);border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:11px;cursor:pointer" onclick="toast('üì∑ Upload image','info')">üì∑ Cliquer pour ajouter</div></div>`;
  if(b.type==='spacer')return`<div class="eb-block">${handle('ESPACE')}<div style="height:20px"></div></div>`;
  if(b.type==='social')return`<div class="eb-block">${handle('R√âSEAUX')}<div style="display:flex;gap:8px;justify-content:center;padding:6px 0;font-size:16px">üîµ üì∏ üíº üê¶</div></div>`;
  if(b.type==='footer')return`<div class="eb-block">${handle('PIED DE PAGE')}<input value="${b.content}" oninput="editBlocks[${i}].content=this.value;updPreview()" ${inp(';color:var(--muted)')}></div>`;return '';
}
function renderEmailPreview(blocks){return (blocks||editBlocks).map(b=>{
  if(b.type==='header')return`<div style="padding:20px 20px 4px;text-align:center"><div style="font-size:20px;font-weight:800;color:${color}">${b.content}</div></div>`;
  if(b.type==='text')return`<div style="padding:10px 20px;font-size:13px;line-height:1.7;color:#555;white-space:pre-line">${b.content.replace(/\{\{prenom\}\}/g,'Sophie').replace(/\{\{nom\}\}/g,'Laurent').replace(/\{\{email\}\}/g,'sophie@email.com')}</div>`;
  if(b.type==='button')return`<div style="padding:8px 20px;text-align:center"><button style="padding:11px 32px;border-radius:8px;border:none;font-size:14px;font-weight:700;color:#fff;background:${color};font-family:inherit;cursor:pointer">${b.content}</button></div>`;
  if(b.type==='divider')return`<div style="padding:0 20px"><div style="height:1px;background:#eee;margin:8px 0"></div></div>`;
  if(b.type==='image')return`<div style="padding:8px 20px"><div style="height:120px;border-radius:8px;background:linear-gradient(135deg,#f0f0f0,#e0e0e0);display:flex;align-items:center;justify-content:center;color:#bbb;font-size:13px">üì∑ Image</div></div>`;
  if(b.type==='spacer')return`<div style="height:24px"></div>`;
  if(b.type==='social')return`<div style="padding:10px 20px;text-align:center;font-size:18px;letter-spacing:8px">üîµ üì∏ üíº üê¶</div>`;
  if(b.type==='footer')return`<div style="padding:12px 20px;font-size:10px;color:#bbb;text-align:center;border-top:1px solid #f0f0f0;margin-top:8px">${b.content}</div>`;return '';
}).join('');}
function updPreview(){const p=document.querySelector('.email-card');if(p)p.querySelector('div:last-child')&&(p.innerHTML=`<div style="padding:8px 12px;background:#f5f5f5;font-size:10px;color:#888;border-bottom:1px solid #eee"><strong style="color:#333">De:</strong> Mon Entreprise<br><strong style="color:#333">Objet:</strong> ${editSubject||'(sans objet)'}</div>${renderEmailPreview(editBlocks)}`);}
function addEditBlock(t){const d={text:{type:'text',content:'Votre texte ici...'},button:{type:'button',content:'En savoir plus ‚Üí',url:'#'},image:{type:'image',content:''},divider:{type:'divider',content:''},spacer:{type:'spacer',content:''},social:{type:'social',content:''}};const idx=editBlocks.length>1?editBlocks.length-1:editBlocks.length;editBlocks.splice(idx,0,d[t]);renderDemo();}
function removeEditBlock(i){if(editBlocks.length<=1)return;editBlocks.splice(i,1);renderDemo();}
function moveBlock(i,dir){const j=i+dir;if(j<0||j>=editBlocks.length)return;[editBlocks[i],editBlocks[j]]=[editBlocks[j],editBlocks[i]];renderDemo();}
function saveDraft(){const name=editName||'Sans titre';if(curCampaign){Object.assign(curCampaign,{name,subject:editSubject,blocks:JSON.parse(JSON.stringify(editBlocks)),audience:editAudience,audienceCount:getAudienceCount(editAudience)});}else{campaigns.unshift({id:Date.now(),name,subject:editSubject,status:'draft',audience:editAudience,audienceCount:getAudienceCount(editAudience),stats:{sent:0,opened:0,clicked:0,unsub:0},blocks:JSON.parse(JSON.stringify(editBlocks))});}emView='campaigns';curCampaign=null;renderDemo();toast('üìù Brouillon sauvegard√©');}
function launchCampaign(){const cnt=getAudienceCount(editAudience);const name=editName||'Sans titre';const status=editSchedule==='now'?'sent':'scheduled';const newC={id:Date.now(),name,subject:editSubject,status,audience:editAudience,audienceCount:cnt,blocks:JSON.parse(JSON.stringify(editBlocks)),stats:status==='sent'?{sent:cnt,opened:Math.round(cnt*(.82+Math.random()*.12)),clicked:Math.round(cnt*(.25+Math.random()*.15)),unsub:Math.random()>.7?1:0}:{sent:0,opened:0,clicked:0,unsub:0}};
  if(status==='sent')newC.sentAt=new Date().toLocaleString('fr-FR',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
  if(status==='scheduled')newC.scheduledAt=editScheduleDate||'√Ä programmer';
  if(curCampaign){const idx=campaigns.findIndex(c=>c.id===curCampaign.id);if(idx>=0)campaigns[idx]=newC;}else campaigns.unshift(newC);
  emView='campaigns';curCampaign=null;renderDemo();toast(status==='sent'?`üöÄ Campagne envoy√©e √† ${cnt} contacts !`:'‚è∞ Campagne programm√©e !');}
// ===== E-LEARNING =====
function pgLearn(){
  if(learnView==='course'&&editCourseId)return pgCourseBuilder();
  if(learnView==='preview'&&editCourseId)return pgStudentView();
  if(learnView==='quality'&&editCourseId)return pgQualityDashboard();
  return pgCourseList();
}
function pgCourseList(){
  const totalStudents=formations.reduce((a,f)=>a+f.students,0);
  const published=formations.filter(f=>f.status==='Publi√©');
  const totalRevenue=formations.reduce((a,f)=>a+f.price*f.students,0);
  return `<div class="page-head"><h1>E-learning</h1><p>${formations.length} formations ¬∑ ${totalStudents} apprenants</p></div>
  <div class="stats" style="grid-template-columns:repeat(4,1fr)">
    <div class="stat"><div class="s-label">Formations</div><div class="s-value" style="color:${color}">${formations.length}</div><div class="s-change">${published.length} publi√©es</div></div>
    <div class="stat"><div class="s-label">Apprenants</div><div class="s-value">${totalStudents}</div><div class="s-change up">+8 ce mois</div></div>
    <div class="stat"><div class="s-label">Taux compl√©tion</div><div class="s-value">72%</div><div class="s-change up">+5%</div></div>
    <div class="stat"><div class="s-label">Revenus formations</div><div class="s-value" style="color:${color}">${totalRevenue.toLocaleString()}‚Ç¨</div></div>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center">
    <button onclick="modalNewFormation()" style="padding:9px 18px;border-radius:10px;border:none;background:${color};color:var(--bg);font-weight:700;font-size:13px;cursor:pointer;font-family:inherit">+ Nouvelle formation</button>
    <div style="margin-left:auto;font-size:11px;color:var(--muted)">Glisser pour r√©organiser (bient√¥t)</div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
  ${formations.map(f=>{
    const totalSteps=f.modules.reduce((a,m)=>a+m.steps.length,0);
    const doneSteps=f.modules.reduce((a,m)=>a+m.steps.filter(s=>s.done).length,0);
    const pct=totalSteps?Math.round(doneSteps/totalSteps*100):0;
    const hasQuiz=f.modules.some(m=>m.steps.some(s=>s.type==='quiz'));
    const hasVideo=f.modules.some(m=>m.steps.some(s=>s.type==='video'));
    const hasPdf=f.modules.some(m=>m.steps.some(s=>s.type==='pdf'));
    return `<div style="border-radius:16px;background:var(--card);border:1px solid var(--border);overflow:hidden;transition:all .2s;cursor:pointer" onmouseover="this.style.borderColor='${color}40'" onmouseout="this.style.borderColor='var(--border)'" onclick="editCourseId=${f.id};learnView='course';renderDemo()">
      <div style="height:100px;background:linear-gradient(135deg,${color}15,${color}05);display:flex;align-items:center;justify-content:center;position:relative">
        <span style="font-size:40px">${f.thumb}</span>
        <span class="badge badge-${f.status==='Publi√©'?'g':'m'}" style="position:absolute;top:10px;right:10px">${f.status}</span>
        ${qualiopiConfig[f.id]?.enabled?'<span style="position:absolute;top:10px;left:10px;background:#eab30820;color:#eab308;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700">üèÖ Qualiopi</span>':''}
        ${f.price?`<span style="position:absolute;bottom:10px;right:10px;background:var(--bg);padding:3px 8px;border-radius:6px;font-size:12px;font-weight:800;font-family:'JetBrains Mono',monospace;color:${color}">${f.price}‚Ç¨</span>`:'<span style="position:absolute;bottom:10px;right:10px;background:var(--bg);padding:3px 8px;border-radius:6px;font-size:11px;color:var(--muted)">Gratuit</span>'}
      </div>
      <div style="padding:16px">
        <div style="font-size:15px;font-weight:700;margin-bottom:4px">${f.title}</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${f.desc}</div>
        <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
          <span style="font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg);color:var(--muted)">${f.modules.length} modules</span>
          <span style="font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg);color:var(--muted)">${totalSteps} √©tapes</span>
          ${hasVideo?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg);color:var(--muted)">üé¨ Vid√©o</span>':''}
          ${hasPdf?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg);color:var(--muted)">üìÑ PDF</span>':''}
          ${hasQuiz?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg);color:var(--muted)">üß† Quiz</span>':''}
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
          <div style="flex:1;height:5px;border-radius:3px;background:var(--border)"><div style="height:100%;width:${pct}%;border-radius:3px;background:${color};transition:width .3s"></div></div>
          <span style="font-size:11px;font-weight:700;color:${color};font-family:'JetBrains Mono',monospace">${pct}%</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px">üë•</span><span style="font-size:12px;color:var(--muted)">${f.students} apprenants</span></div>
          ${f.rating?`<div style="font-size:11px;color:#eab308">‚òÖ ${f.rating}</div>`:''}
        </div>
      </div>
    </div>`;}).join('')}
  </div>`;
}
function pgCourseBuilder(){
  const f=formations.find(c=>c.id===editCourseId);if(!f)return pgCourseList();
  const totalSteps=f.modules.reduce((a,m)=>a+m.steps.length,0);
  const doneSteps=f.modules.reduce((a,m)=>a+m.steps.filter(s=>s.done).length,0);
  const vids=f.modules.reduce((a,m)=>a+m.steps.filter(s=>s.type==='video').length,0);
  const quizzes=f.modules.reduce((a,m)=>a+m.steps.filter(s=>s.type==='quiz').length,0);
  return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
    <button onclick="learnView='list';editCourseId=null;renderDemo()" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;cursor:pointer;font-family:inherit">‚Üê Retour</button>
    <div style="flex:1"><h1 style="font-size:18px;font-weight:800;margin:0">${f.thumb} ${f.title}</h1><div style="font-size:12px;color:var(--muted)">${f.modules.length} modules ¬∑ ${totalSteps} √©tapes ¬∑ ${vids} vid√©os ¬∑ ${quizzes} quiz</div></div>
    <span class="badge badge-${f.status==='Publi√©'?'g':'m'}" onclick="f.status=f.status==='Publi√©'?'Brouillon':'Publi√©';renderDemo();toast('üìã '+f.status)" style="cursor:pointer">${f.status}</span>
    <button onclick="previewStepIdx=0;previewModIdx=0;learnView='preview';renderDemo()" style="padding:8px 16px;border-radius:8px;border:1px solid ${color};background:transparent;color:${color};font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">üëÅ Aper√ßu √©l√®ve</button>
    <button onclick="learnView='quality';renderDemo()" style="padding:8px 16px;border-radius:8px;border:1px solid #eab308;background:#eab30810;color:#eab308;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">üèÖ Qualit√©</button>
    <button onclick="modalEditFormation(${f.id})" style="padding:8px 16px;border-radius:8px;border:none;background:${color}20;color:${color};font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">‚öô Param√®tres</button>
  </div>
  <div style="display:grid;grid-template-columns:5fr 2fr;gap:16px">
    <div>
      ${f.modules.map((m,mi)=>{
        return `<div style="margin-bottom:16px;border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:hidden">
          <div style="padding:14px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)">
            <div style="width:28px;height:28px;border-radius:8px;background:${color}20;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:${color}">${mi+1}</div>
            <div style="flex:1"><div style="font-size:14px;font-weight:700">${m.title}</div><div style="font-size:11px;color:var(--muted)">${m.steps.length} √©tapes</div></div>
            <button onclick="modalEditModule(${f.id},${m.id})" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--muted);font-size:11px;cursor:pointer;font-family:inherit">‚úèÔ∏è</button>
            <button onclick="modalAddStep(${f.id},${m.id})" style="padding:5px 10px;border-radius:6px;border:none;background:${color}20;color:${color};font-size:11px;font-weight:600;cursor:pointer;font-family:inherit">+ √âtape</button>
          </div>
          ${m.steps.map((s,si)=>{
            const ico=STEP_TYPES.find(t=>t.v===s.type)?.icon||'üìé';
            return `<div style="padding:10px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.03);transition:background .15s" onmouseover="this.style.background='rgba(255,255,255,.02)'" onmouseout="this.style.background=''">
              <div style="width:24px;height:24px;border-radius:6px;background:${s.done?color+'20':'var(--bg)'};border:1px solid ${s.done?color:'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:11px;color:${s.done?color:'var(--muted)'}">${s.done?'‚úì':si+1}</div>
              <span style="font-size:14px">${ico}</span>
              <div style="flex:1"><div style="font-size:13px;font-weight:500">${s.title}</div><div style="font-size:11px;color:var(--muted)">${s.type==='video'?'Vid√©o ¬∑ '+s.duration:s.type==='pdf'?'PDF'+(s.size?' ¬∑ '+s.size:''):s.type==='quiz'?(s.questions?.length||0)+' questions':'Texte'}</div></div>
              <div style="display:flex;gap:4px">
                <button onclick="modalEditStep(${f.id},${m.id},${s.id})" style="width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--muted);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="Modifier">‚úèÔ∏è</button>
                <button onclick="deleteStep(${f.id},${m.id},${s.id})" style="width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--accent2);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center" title="Supprimer">üóë</button>
              </div>
            </div>`;
          }).join('')}
          ${m.steps.length===0?'<div style="padding:24px;text-align:center;color:var(--muted);font-size:12px">Aucune √©tape ‚Äî cliquez sur "+ √âtape" pour commencer</div>':''}
        </div>`;
      }).join('')}
      <button onclick="addModule(${f.id})" style="width:100%;padding:14px;border-radius:14px;border:2px dashed var(--border);background:transparent;color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s" onmouseover="this.style.borderColor='${color}';this.style.color='${color}'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">+ Ajouter un module</button>
    </div>
    <div>
      <div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border);margin-bottom:16px">
        <div style="font-size:13px;font-weight:700;margin-bottom:12px">üìä Statistiques</div>
        <div style="display:grid;gap:10px">
          <div style="display:flex;justify-content:space-between;font-size:12px"><span style="color:var(--muted)">Apprenants</span><span style="font-weight:700">${f.students}</span></div>
          <div style="display:flex;justify-content:space-between;font-size:12px"><span style="color:var(--muted)">Compl√©tion moy.</span><span style="font-weight:700">${totalSteps?Math.round(doneSteps/totalSteps*100):0}%</span></div>
          <div style="display:flex;justify-content:space-between;font-size:12px"><span style="color:var(--muted)">Note moyenne</span><span style="font-weight:700;color:#eab308">${f.rating?'‚òÖ '+f.rating:'‚Äî'}</span></div>
          <div style="display:flex;justify-content:space-between;font-size:12px"><span style="color:var(--muted)">Revenus</span><span style="font-weight:700;color:${color}">${(f.price*f.students).toLocaleString()}‚Ç¨</span></div>
        </div>
      </div>
      <div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border);margin-bottom:16px">
        <div style="font-size:13px;font-weight:700;margin-bottom:12px">üìã Contenu</div>
        <div style="display:grid;gap:6px">
          ${STEP_TYPES.map(t=>{const c=f.modules.reduce((a,m)=>a+m.steps.filter(s=>s.type===t.v).length,0);return `<div style="display:flex;align-items:center;gap:8px;font-size:12px"><span>${t.icon}</span><span style="flex:1;color:var(--muted)">${t.l.split(' ')[1]||t.l}</span><span style="font-weight:600">${c}</span></div>`;}).join('')}
        </div>
      </div>
      ${(()=>{const qc=qualiopiConfig[f.id]||{};if(!qc.enabled)return `<div style="padding:14px;border-radius:14px;border:1px dashed #eab30830;background:#eab30808;margin-bottom:16px;text-align:center"><div style="font-size:11px;color:#eab308;font-weight:600;margin-bottom:4px">üèÖ Qualiopi d√©sactiv√©</div><button onclick="modalQualiopiSettings(${f.id})" style="padding:4px 12px;border-radius:5px;border:1px solid #eab30830;background:transparent;color:#eab308;font-size:10px;cursor:pointer;font-family:inherit">Activer ‚Üí</button></div>`;const qt=qualiopiTracking[f.id]||[];const cr=[{l:'Info public',ok:!!f.desc&&qc.objectifs?.length>=2},{l:'Positionnement',ok:qc.posQuiz&&qt.some(t=>t.posScore)},{l:'√âmargement',ok:qc.emargement&&qt.some(t=>t.emargements?.length)},{l:'Quiz modules',ok:f.modules.some(m=>m.steps.some(s=>s.type==='quiz'))},{l:'√âval. finale',ok:qt.some(t=>t.finalScore!==null)},{l:'Satisfaction',ok:qt.some(t=>t.satisfaction!==null)},{l:'Am√©lioration',ok:true}];const pct=Math.round(cr.filter(c=>c.ok).length/cr.length*100);return `<div style="padding:14px;border-radius:14px;background:var(--card);border:1px solid #eab30830;margin-bottom:16px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><span style="font-size:13px;font-weight:700">üèÖ Qualiopi</span><span style="margin-left:auto;font-size:11px;font-weight:700;color:${pct>=80?'#22c55e':pct>=50?'#eab308':'#ef4444'}">${pct}%</span></div><div style="height:4px;border-radius:2px;background:var(--border);margin-bottom:8px"><div style="height:100%;width:${pct}%;border-radius:2px;background:${pct>=80?'#22c55e':pct>=50?'#eab308':'#ef4444'};transition:width .3s"></div></div><div style="display:grid;gap:3px">${cr.map(c=>`<div style="display:flex;align-items:center;gap:6px;font-size:10px"><span>${c.ok?'‚úÖ':'‚ùå'}</span><span style="color:${c.ok?'var(--muted)':'#ef4444'}">${c.l}</span></div>`).join('')}</div><button onclick="learnView='quality';renderDemo()" style="width:100%;margin-top:8px;padding:6px;border-radius:6px;border:1px solid #eab30830;background:#eab30808;color:#eab308;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit">Voir le dashboard qualit√© ‚Üí</button></div>`;})()}
      <div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
        <div style="font-size:13px;font-weight:700;margin-bottom:12px">üéØ Actions rapides</div>
        <div style="display:grid;gap:6px">
          <button onclick="previewStepIdx=0;previewModIdx=0;learnView='preview';renderDemo()" style="width:100%;padding:9px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;cursor:pointer;font-family:inherit;text-align:left">üëÅ Voir comme un √©l√®ve</button>
          <button onclick="dupFormation(${f.id})" style="width:100%;padding:9px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;cursor:pointer;font-family:inherit;text-align:left">üìã Dupliquer la formation</button>
          <button onclick="if(confirm('Supprimer cette formation ?')){formations=formations.filter(c=>c.id!==${f.id});learnView='list';editCourseId=null;renderDemo();toast('üóë Formation supprim√©e')}" style="width:100%;padding:9px;border-radius:8px;border:1px solid rgba(239,68,68,.2);background:var(--bg);color:var(--accent2);font-size:12px;cursor:pointer;font-family:inherit;text-align:left">üóë Supprimer</button>
        </div>
      </div>
    </div>
  </div>
  ${renderLearnersPanel(f)}`;
}
function renderLearnersPanel(f){
  const learners=formLearners.filter(l=>l.fid===f.id);
  if(!learners.length)return '';
  const active=learners.filter(l=>l.status==='active').length;
  const completed=learners.filter(l=>l.status==='completed').length;
  const inactive=learners.filter(l=>l.status==='inactive').length;
  const relanced=learners.filter(l=>l.status==='relanced').length;
  const avgProg=Math.round(learners.reduce((a,l)=>a+l.progress,0)/learners.length);
  return `<div style="margin-top:16px;border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:hidden">
    <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-size:14px;font-weight:700;flex:1">üë• Apprenants <span style="font-size:12px;font-weight:400;color:var(--muted)">(${learners.length})</span></div>
      <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:#22c55e20;color:#22c55e">${active} actifs</span>
      <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:${color}20;color:${color}">${completed} termin√©s</span>
      ${relanced?`<span style="font-size:11px;padding:3px 8px;border-radius:6px;background:#eab30820;color:#eab308">${relanced} relanc√©s</span>`:''}
      ${inactive?`<span style="font-size:11px;padding:3px 8px;border-radius:6px;background:#ef444420;color:#ef4444">${inactive} inactifs</span>`:''}
      <span style="font-size:11px;color:var(--muted)">Moy. ${avgProg}%</span>
      <button onclick="relanceInactiveLearners(${f.id})" style="padding:5px 12px;border-radius:6px;border:none;background:#ef444420;color:#ef4444;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit" title="Relancer les inactifs">üìß Relancer inactifs</button>
    </div>
    <table class="dt" style="font-size:12px"><thead><tr><th style="width:30%">Apprenant</th><th style="width:20%">Module actuel</th><th style="width:15%">Progression</th><th style="width:10%">Quiz</th><th style="width:12%">Derni√®re activit√©</th><th style="width:13%">Actions</th></tr></thead><tbody>
    ${learners.sort((a,b)=>b.progress-a.progress).map(l=>{
      const isInactive=l.status==='inactive';
      const isRelanced=l.status==='relanced';
      const isCompleted=l.status==='completed';
      const daysSince=Math.floor((new Date()-new Date(l.lastActive.split('/').reverse().join('-')))/(1000*60*60*24));
      const staleClass=daysSince>10?'color:#ef4444;font-weight:600':daysSince>5?'color:#eab308':'color:var(--muted)';
      return `<tr style="${isInactive?'background:rgba(239,68,68,.03)':''}${isRelanced?'background:rgba(234,179,8,.03)':''}${isCompleted?'background:rgba(0,212,170,.03)':''}">
        <td><div style="display:flex;align-items:center;gap:8px"><div style="width:28px;height:28px;border-radius:8px;background:${isCompleted?color+'20':isInactive||isRelanced?'#ef444420':'var(--bg)'};border:1px solid ${isCompleted?color:isInactive?'#ef4444':isRelanced?'#eab308':'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:${isCompleted?color:isInactive?'#ef4444':isRelanced?'#eab308':'var(--muted)'};flex-shrink:0">${l.avatar}</div><div><div style="font-weight:600">${l.name}</div><div style="font-size:10px;color:var(--muted)">${l.email}</div>${isRelanced?`<div style="font-size:9px;color:#eab308;margin-top:1px">üìß Relanc√© le ${l.relanceDate}</div>`:''}</div></div></td>
        <td><div style="font-size:11px">${l.currentModule}</div><div style="font-size:10px;color:var(--muted)">${l.currentStep}</div></td>
        <td><div style="display:flex;align-items:center;gap:6px"><div style="flex:1;height:4px;border-radius:2px;background:var(--border)"><div style="height:100%;width:${l.progress}%;border-radius:2px;background:${l.progress===100?'#22c55e':l.progress>=50?color:'#eab308'}"></div></div><span style="font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace">${l.progress}%</span></div></td>
        <td>${l.quizScore!==null?`<span style="font-size:11px;font-weight:600;color:${l.quizScore>=70?'#22c55e':'#ef4444'}">${l.quizScore}%</span>`:'<span style="font-size:10px;color:var(--muted)">‚Äî</span>'}</td>
        <td><span style="font-size:11px;${staleClass}">${l.lastActive}</span>${daysSince>10?'<div style="font-size:9px;color:#ef4444">'+daysSince+'j sans activit√©</div>':''}</td>
        <td><div style="display:flex;gap:4px">
          <button onclick="modalSendLearnerMsg('${l.name.replace(/'/g,"\\'")}',${l.progress},'${l.currentModule.replace(/'/g,"\\'")}',${f.id})" style="padding:4px 8px;border-radius:5px;border:1px solid var(--border);background:var(--bg);color:${color};font-size:10px;cursor:pointer;font-family:inherit" title="Envoyer un message">üí¨</button>
          ${isInactive?`<button onclick="modalNudgeLearner('${l.name.replace(/'/g,"\\'")}',${f.id})" style="padding:4px 8px;border-radius:5px;border:1px solid #ef444430;background:#ef444410;color:#ef4444;font-size:10px;cursor:pointer;font-family:inherit" title="Relancer">üìß</button>`:''}
          ${isRelanced?`<span style="padding:4px 8px;border-radius:5px;border:1px solid #eab30830;background:#eab30810;color:#eab308;font-size:10px;font-family:inherit" title="Relanc√© le ${l.relanceDate}">üìß ‚úì</span>`:''}
          ${isCompleted?`<button onclick="modalCertificate(${f.id})" style="padding:4px 8px;border-radius:5px;border:1px solid ${color}30;background:${color}10;color:${color};font-size:10px;cursor:pointer;font-family:inherit" title="Certificat">üèÜ</button>`:''}
        </div></td>
      </tr>`;}).join('')}
    </tbody></table>
  </div>`;
}
function modalSendLearnerMsg(name,progress,currentMod,fid){
  const f=formations.find(c=>c.id===fid);
  const suggestions=progress<30?[
    `Bonjour ${name.split(' ')[0]} ! üëã J'ai vu que vous avez commenc√© "${f?.title}". N'h√©sitez pas √† me contacter si vous avez des questions pour avancer. Je suis l√† pour vous accompagner !`,
    `${name.split(' ')[0]}, comment √ßa se passe avec la formation ? Si certains points vous bloquent, on peut en discuter. Votre progression est importante pour moi !`
  ]:progress>=100?[
    `F√©licitations ${name.split(' ')[0]} ! üéâ Vous avez termin√© "${f?.title}" avec brio. Votre certificat est disponible. Pensez √† d√©couvrir nos formations avanc√©es !`,
    `Bravo ${name.split(' ')[0]} ! Quel parcours ! J'aimerais beaucoup avoir votre retour sur la formation. Votre avis m'aiderait √† l'am√©liorer.`
  ]:[
    `${name.split(' ')[0]}, super progression sur "${currentMod}" ! üí™ Continuez comme √ßa, vous √™tes √† ${progress}% de la formation. Le meilleur reste √† venir !`,
    `Bonjour ${name.split(' ')[0]} ! Petit check-in : o√π en √™tes-vous sur "${currentMod}" ? N'h√©sitez pas si vous avez besoin d'un coup de pouce.`
  ];
  showModal(`<h2>üí¨ Message √† ${name}<button class="modal-close" onclick="closeModal()">√ó</button></h2>
  <div style="font-size:11px;color:var(--muted);margin-bottom:10px">Ce message appara√Ætra dans l'espace de ${name.split(' ')[0]} √† sa prochaine connexion, et sera aussi envoy√© par email.</div>
  <div style="font-size:12px;font-weight:600;margin-bottom:8px">üí° Suggestions personnalis√©es</div>
  <div style="display:grid;gap:6px;margin-bottom:12px">${suggestions.map((s,i)=>`<div onclick="document.getElementById('lmMsg').value=this.innerText" style="padding:10px;border-radius:8px;border:1px solid var(--border);font-size:12px;color:var(--muted);cursor:pointer;transition:all .15s;line-height:1.5" onmouseover="this.style.borderColor='${color}';this.style.color='var(--text)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">${s}</div>`).join('')}</div>
  <div class="field"><label>Votre message</label><textarea id="lmMsg" rows="4" placeholder="√âcrivez votre message personnalis√©...">${suggestions[0]}</textarea></div>
  <div class="field-row"><label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" checked style="accent-color:${color}"> Envoyer aussi par email</label><label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" checked style="accent-color:${color}"> Afficher dans son espace</label></div>
  <button class="btn-full" style="background:${color};color:var(--bg)" onclick="closeModal();toast('üí¨ Message envoy√© √† ${name.split(' ')[0]} !')">Envoyer le message ‚Üí</button>`,true);
}
function modalNudgeLearner(name,fid){
  const f=formations.find(c=>c.id===fid);
  const msg=`Bonjour ${name.split(' ')[0]} ! üëã √áa fait un moment qu'on ne vous a pas vu sur "${f?.title}". La formation vous attend toujours, et votre progression est sauvegard√©e. Un petit pas aujourd'hui peut faire une grande diff√©rence. On s'y remet ?`;
  showModal(`<h2>üìß Relancer ${name}<button class="modal-close" onclick="closeModal()">√ó</button></h2>
  <div style="font-size:11px;color:var(--muted);margin-bottom:12px">Cet apprenant est inactif depuis plus de 10 jours.</div>
  <div class="field"><label>Message de relance</label><textarea id="nudgeMsg" rows="4">${msg}</textarea></div>
  <button class="btn-full" style="background:#ef4444;color:#fff" onclick="nudgeSingleLearner('${name.replace(/'/g,"\\'")}',${fid});closeModal()">Envoyer la relance ‚Üí</button>`);
}
function nudgeSingleLearner(name,fid){const l=formLearners.find(x=>x.fid===fid&&x.name===name);if(l){l.status='relanced';l.relanceDate=new Date().toLocaleDateString('fr-FR');}renderDemo();toast('üìß Relance envoy√©e √† '+name.split(' ')[0]+' !');}
function relanceInactiveLearners(fid){
  const inactive=formLearners.filter(l=>l.fid===fid&&l.status==='inactive');
  if(!inactive.length)return toast('‚úÖ Aucun apprenant inactif');
  const today=new Date().toLocaleDateString('fr-FR');
  inactive.forEach(l=>{l.status='relanced';l.relanceDate=today;});
  renderDemo();
  toast('üìß '+inactive.length+' relance(s) envoy√©e(s) !');
}
const PDF_PAGES=[
  `<div style="text-align:center;margin-bottom:24px"><div style="font-size:11px;letter-spacing:3px;text-transform:uppercase;color:#00d4aa;margin-bottom:8px">FORMATION</div><div style="font-size:22px;font-weight:700;color:#1a1a2e">Document p√©dagogique</div><div style="width:40px;height:2px;background:#00d4aa;margin:12px auto 0"></div></div><div style="font-size:12px;color:#666;text-align:center;margin-top:20px">Ressources et fiches pratiques</div><div style="font-size:11px;color:#999;text-align:center;margin-top:30px">Document confidentiel ¬∑ 2026</div>`,
  `<div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-bottom:16px">Sommaire</div><div style="font-size:13px;line-height:2.2;color:#444">1. Introduction et objectifs ...... 3<br>2. Concepts fondamentaux ...... 5<br>3. Fiches pratiques ...... 8<br>4. Exercices d'application ...... 11<br>5. Mod√®les √† personnaliser ...... 14<br>6. Ressources compl√©mentaires ...... 16</div>`,
  `<div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-bottom:12px">1. Introduction</div><div style="font-size:12px;line-height:1.8;color:#444;margin-bottom:12px">Ce document accompagne votre formation. Il a √©t√© con√ßu pour vous fournir les ressources n√©cessaires √† la mise en pratique des concepts abord√©s en vid√©o.</div><div style="font-size:12px;line-height:1.8;color:#444"><strong>Objectifs p√©dagogiques :</strong><br>‚Ä¢ Ma√Ætriser les concepts fondamentaux<br>‚Ä¢ Appliquer les techniques en situation r√©elle<br>‚Ä¢ D√©velopper votre posture professionnelle<br>‚Ä¢ √âvaluer vos progr√®s √† chaque √©tape</div>`,
  `<div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-bottom:12px">3. Fiches pratiques</div><div style="padding:12px;border-radius:8px;border:1px solid #ddd;margin-bottom:12px"><div style="font-size:11px;font-weight:700;color:#00d4aa;margin-bottom:6px">FICHE N¬∞1 ‚Äî Grille d'observation</div><div style="font-size:12px;line-height:1.7;color:#444">Utilisez cette grille lors de vos premi√®res s√©ances pour structurer vos observations et prises de notes.</div></div><div style="padding:12px;border-radius:8px;border:1px solid #ddd"><div style="font-size:11px;font-weight:700;color:#00d4aa;margin-bottom:6px">FICHE N¬∞2 ‚Äî Auto-√©valuation</div><div style="font-size:12px;line-height:1.7;color:#444">Apr√®s chaque s√©ance, remplissez cette fiche pour mesurer votre progression sur les comp√©tences cl√©s.</div></div>`
];
function pdfNav(pid,dir){const el=document.getElementById(pid);if(!el)return;let pg=parseInt(el.dataset.page)||0;pg+=dir;if(pg<0)pg=PDF_PAGES.length-1;if(pg>=PDF_PAGES.length)pg=0;el.dataset.page=pg;el.innerHTML=PDF_PAGES[pg];const lbl=document.getElementById(pid+'_pg');if(lbl)lbl.textContent='Page '+(pg+1)+' / '+PDF_PAGES.length;}
function downloadPdf(name){const content='%PDF-1.4 Demo file - '+name;const blob=new Blob([content],{type:'application/pdf'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);toast('üì• '+name+' t√©l√©charg√© !');}
function pgQualityDashboard(){
  const f=formations.find(c=>c.id===editCourseId);if(!f)return pgCourseList();
  const qc=qualiopiConfig[f.id]||{enabled:false};
  const qt=qualiopiTracking[f.id]||[];
  const learners=formLearners.filter(l=>l.fid===f.id);
  const completed=qt.filter(t=>t.completedAt);
  const withFinal=qt.filter(t=>t.finalScore!==null);
  const passed=withFinal.filter(t=>t.finalScore>=qc.minScore);
  const satScores=qt.filter(t=>t.satisfaction!==null).map(t=>t.satisfaction);
  const avgSat=satScores.length?Math.round(satScores.reduce((a,b)=>a+b,0)/satScores.length*10)/10:0;
  const nps=satScores.length?Math.round(satScores.filter(s=>s>=9).length/satScores.length*100):0;
  const avgPos=qt.length?Math.round(qt.reduce((a,t)=>a+(t.posScore||0),0)/qt.length):0;
  const avgFinal=withFinal.length?Math.round(withFinal.reduce((a,t)=>a+t.finalScore,0)/withFinal.length):0;
  const progression=avgFinal-avgPos;
  const abandonRate=learners.length?Math.round(learners.filter(l=>l.status==='inactive').length/learners.length*100):0;
  const totalEmarg=qt.reduce((a,t)=>a+(t.emargements?.length||0),0);
  const cr7=qc.enabled?[
    {c:'C1',l:'Information public',items:[{l:'Fiche formation compl√®te',ok:!!f.desc&&f.price!==undefined},{l:'Objectifs p√©dagogiques',ok:qc.objectifs?.length>=2},{l:'Pr√©requis document√©s',ok:!!qc.prerequis},{l:'Taux r√©sultats publi√©s',ok:withFinal.length>0}]},
    {c:'C2',l:'Objectifs & adaptation',items:[{l:'Positionnement entr√©e',ok:qc.posQuiz&&qt.filter(t=>t.posScore).length>0},{l:'Objectifs mesurables',ok:qc.objectifs?.length>=2},{l:'Score minimum d√©fini',ok:qc.minScore>0},{l:'Modalit√©s document√©es',ok:!!qc.modalites}]},
    {c:'C3',l:'Suivi & √©valuation',items:[{l:'√âmargement num√©rique',ok:qc.emargement&&totalEmarg>0},{l:'√âvaluation par module (quiz)',ok:f.modules.some(m=>m.steps.some(s=>s.type==='quiz'))},{l:'√âvaluation finale',ok:withFinal.length>0},{l:'Questionnaire satisfaction',ok:qc.satisfactionSurvey&&satScores.length>0}]},
    {c:'C4',l:'Moyens p√©dagogiques',items:[{l:'Vid√©os de formation',ok:f.modules.some(m=>m.steps.some(s=>s.type==='video'))},{l:'Supports PDF',ok:f.modules.some(m=>m.steps.some(s=>s.type==='pdf'))},{l:'Contenus texte',ok:f.modules.some(m=>m.steps.some(s=>s.type==='text'))},{l:'Diversit√© p√©dagogique',ok:new Set(f.modules.flatMap(m=>m.steps.map(s=>s.type))).size>=3}]},
    {c:'C5',l:'Formateurs',items:[{l:'Profil formateur',ok:true},{l:'Qualifications document√©es',ok:true}]},
    {c:'C6',l:'Environnement pro',items:[{l:'Veille sectorielle',ok:true}]},
    {c:'C7',l:'Am√©lioration continue',items:[{l:'Collecte feedbacks',ok:satScores.length>0},{l:'Analyse r√©sultats',ok:withFinal.length>0},{l:'Taux abandon suivi',ok:true},{l:'Plan actions qualit√©',ok:completed.length>0||satScores.length>0}]}
  ]:[];
  const totalItems=cr7.reduce((a,c)=>a+c.items.length,0);
  const okItems=cr7.reduce((a,c)=>a+c.items.filter(i=>i.ok).length,0);
  const compliancePct=totalItems?Math.round(okItems/totalItems*100):0;
  return `<div class="page-head"><div style="display:flex;align-items:center;gap:10px"><button onclick="learnView='course';renderDemo()" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;cursor:pointer;font-family:inherit">‚Üê Retour</button><div><h1 style="font-size:18px;margin:0">üèÖ Tableau de bord Qualit√© ‚Äî ${f.title}</h1><p style="font-size:12px;color:var(--muted);margin:2px 0 0">Conformit√© Qualiopi ¬∑ R√©f√©rentiel National Qualit√© (RNQ)</p></div></div>
  <div style="display:flex;gap:8px;margin-top:8px">
    <button onclick="modalQualiopiSettings(${f.id})" style="padding:6px 14px;border-radius:6px;border:1px solid #eab308;background:#eab30810;color:#eab308;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit">‚öô Configurer Qualiopi</button>
    <button onclick="exportQualiopiProof(${f.id})" style="padding:6px 14px;border-radius:6px;border:1px solid ${color};background:${color}10;color:${color};font-size:11px;font-weight:600;cursor:pointer;font-family:inherit">üìã Exporter preuves d'audit</button>
  </div></div>
  ${!qc.enabled?`<div style="padding:20px;border-radius:14px;border:2px dashed #eab30840;background:#eab30808;text-align:center;margin-bottom:16px"><span style="font-size:32px">üèÖ</span><div style="font-size:14px;font-weight:700;margin:8px 0 4px">Qualiopi n'est pas activ√© pour cette formation</div><div style="font-size:12px;color:var(--muted);margin-bottom:12px">Activez la conformit√© Qualiopi pour suivre les 7 crit√®res du RNQ et pr√©parer vos audits.</div><button onclick="modalQualiopiSettings(${f.id})" style="padding:8px 20px;border-radius:8px;border:none;background:#eab308;color:#000;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">Activer Qualiopi ‚Üí</button></div>`:''}
  ${qc.enabled?`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px">
    <div style="padding:14px;border-radius:12px;background:var(--card);border:1px solid var(--border);text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:4px">Conformit√© RNQ</div><div style="font-size:24px;font-weight:800;color:${compliancePct>=80?'#22c55e':compliancePct>=50?'#eab308':'#ef4444'}">${compliancePct}%</div><div style="font-size:10px;color:var(--muted)">${okItems}/${totalItems} indicateurs</div></div>
    <div style="padding:14px;border-radius:12px;background:var(--card);border:1px solid var(--border);text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:4px">Taux r√©ussite</div><div style="font-size:24px;font-weight:800;color:${color}">${withFinal.length?Math.round(passed.length/withFinal.length*100):0}%</div><div style="font-size:10px;color:var(--muted)">${passed.length}/${withFinal.length} certifi√©s</div></div>
    <div style="padding:14px;border-radius:12px;background:var(--card);border:1px solid var(--border);text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:4px">Satisfaction</div><div style="font-size:24px;font-weight:800;color:#eab308">${avgSat}/10</div><div style="font-size:10px;color:var(--muted)">NPS ${nps}% ¬∑ ${satScores.length} avis</div></div>
    <div style="padding:14px;border-radius:12px;background:var(--card);border:1px solid var(--border);text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:4px">Progression</div><div style="font-size:24px;font-weight:800;color:${progression>0?'#22c55e':'#ef4444'}">+${progression}pts</div><div style="font-size:10px;color:var(--muted)">${avgPos}‚Üí${avgFinal} moy.</div></div>
    <div style="padding:14px;border-radius:12px;background:var(--card);border:1px solid var(--border);text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:4px">Abandon</div><div style="font-size:24px;font-weight:800;color:${abandonRate>20?'#ef4444':'#22c55e'}">${abandonRate}%</div><div style="font-size:10px;color:var(--muted)">${learners.filter(l=>l.status==='inactive').length}/${learners.length}</div></div>
    <div style="padding:14px;border-radius:12px;background:var(--card);border:1px solid var(--border);text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:4px">√âmargements</div><div style="font-size:24px;font-weight:800;color:var(--text)">${totalEmarg}</div><div style="font-size:10px;color:var(--muted)">${qt.length} apprenants suivis</div></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
    <div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">üìä 7 Crit√®res du RNQ</div>
      ${cr7.map(c=>{const pct=c.items.length?Math.round(c.items.filter(i=>i.ok).length/c.items.length*100):0;return `<div style="margin-bottom:10px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:10px;font-weight:800;color:${pct===100?'#22c55e':pct>=50?'#eab308':'#ef4444'};min-width:24px">${c.c}</span><span style="font-size:12px;font-weight:600;flex:1">${c.l}</span><span style="font-size:10px;font-weight:700;color:${pct===100?'#22c55e':pct>=50?'#eab308':'#ef4444'}">${pct}%</span></div><div style="display:flex;gap:3px">${c.items.map(i=>`<div title="${i.l}" style="flex:1;height:4px;border-radius:2px;background:${i.ok?'#22c55e':'#ef444440'}"></div>`).join('')}</div></div>`;}).join('')}
    </div>
    <div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">üìà Progression des apprenants</div>
      ${qt.map(t=>{const l=learners.find(x=>x.name===t.name);const prog=l?.progress||0;return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:12px"><span style="min-width:100px;font-weight:600">${t.name.split(' ')[0]}</span><div style="flex:1;display:flex;align-items:center;gap:4px"><span style="font-size:10px;color:var(--muted);min-width:28px">${t.posScore||0}</span><div style="flex:1;height:6px;border-radius:3px;background:var(--border);position:relative"><div style="position:absolute;left:0;height:100%;width:${prog}%;border-radius:3px;background:linear-gradient(90deg,#eab308,${color})"></div></div><span style="font-size:10px;font-weight:700;min-width:28px;text-align:right;color:${t.finalScore?color:'var(--muted)'}">${t.finalScore||'...'}</span></div><div style="width:20px;text-align:center">${t.finalScore&&t.finalScore>=qc.minScore?'‚úÖ':t.finalScore?'‚ùå':'‚è≥'}</div></div>`;}).join('')}
      <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);display:flex;justify-content:space-between"><span>Score positionnement ‚Üí Score final</span><span>Seuil : ${qc.minScore}%</span></div>
    </div>
  </div>
  <div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border);margin-bottom:16px">
    <div style="font-size:13px;font-weight:700;margin-bottom:12px">üìù Registre d'√©margement num√©rique</div>
    <table class="dt" style="font-size:12px"><thead><tr><th>Apprenant</th><th>Connexions</th><th>Derni√®re</th><th>Total √©margements</th><th>Preuves</th></tr></thead><tbody>
    ${qt.map(t=>`<tr><td style="font-weight:600">${t.name}</td><td><div style="display:flex;gap:2px;flex-wrap:wrap">${(t.emargements||[]).slice(-6).map(e=>`<span style="padding:2px 5px;border-radius:3px;background:${color}15;color:${color};font-size:9px;font-family:'JetBrains Mono',monospace">${e}</span>`).join('')}</div></td><td style="font-size:11px;color:var(--muted)">${(t.emargements||[]).slice(-1)[0]||'‚Äî'}</td><td style="font-weight:700">${(t.emargements||[]).length}</td><td><span style="color:${(t.emargements||[]).length>=3?'#22c55e':'#eab308'};font-size:10px;font-weight:600">${(t.emargements||[]).length>=3?'‚úÖ Conforme':'‚ö† Insuffisant'}</span></td></tr>`).join('')}
    </tbody></table>
  </div>
  ${satScores.length?`<div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border);margin-bottom:16px">
    <div style="font-size:13px;font-weight:700;margin-bottom:12px">‚≠ê Satisfaction apprenants</div>
    <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px">
      <div style="text-align:center"><div style="font-size:32px;font-weight:800;color:#eab308">${avgSat}</div><div style="font-size:10px;color:var(--muted)">/10</div></div>
      <div style="flex:1;display:flex;align-items:end;gap:3px;height:40px">${[...Array(10)].map((_,i)=>{const count=satScores.filter(s=>s===i+1).length;const h=count?Math.max(10,count/satScores.length*100):3;return `<div style="flex:1;height:${h}%;border-radius:2px;background:${i>=8?'#22c55e':i>=6?'#eab308':'#ef4444'}40" title="${i+1}/10 : ${count} avis"></div>`;}).join('')}</div>
      <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:${nps>=50?'#22c55e':'#eab308'}">${nps}%</div><div style="font-size:10px;color:var(--muted)">NPS</div></div>
    </div>
  </div>`:''}
  `:''}`;
}
function modalQualiopiSettings(fid){
  const qc=qualiopiConfig[fid]||{enabled:false,posQuiz:false,minScore:70,satisfactionSurvey:false,emargement:false,prerequis:'',objectifs:[],modalites:''};
  showModal(`<h2>üèÖ Configuration Qualiopi<button class="modal-close" onclick="closeModal()">√ó</button></h2>
  <div style="font-size:11px;color:var(--muted);margin-bottom:12px">Configurez les param√®tres de conformit√© Qualiopi pour cette formation.</div>
  <div style="display:grid;gap:8px;margin-bottom:12px">
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer;padding:8px;border-radius:8px;border:1px solid var(--border)"><input type="checkbox" id="qcEnabled" ${qc.enabled?'checked':''} style="accent-color:#eab308"> <div><div style="font-weight:600">Activer Qualiopi</div><div style="font-size:10px;color:var(--muted)">Active le suivi qualit√© RNQ</div></div></label>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer;padding:8px;border-radius:8px;border:1px solid var(--border)"><input type="checkbox" id="qcPos" ${qc.posQuiz?'checked':''} style="accent-color:#eab308"> <div><div style="font-weight:600">Quiz de positionnement</div><div style="font-size:10px;color:var(--muted)">√âvaluation avant le d√©marrage (C2)</div></div></label>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer;padding:8px;border-radius:8px;border:1px solid var(--border)"><input type="checkbox" id="qcEmarg" ${qc.emargement?'checked':''} style="accent-color:#eab308"> <div><div style="font-weight:600">√âmargement num√©rique</div><div style="font-size:10px;color:var(--muted)">Trace horodat√©e √† chaque connexion (C3)</div></div></label>
    <label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer;padding:8px;border-radius:8px;border:1px solid var(--border)"><input type="checkbox" id="qcSat" ${qc.satisfactionSurvey?'checked':''} style="accent-color:#eab308"> <div><div style="font-weight:600">Questionnaire satisfaction</div><div style="font-size:10px;color:var(--muted)">Enqu√™te NPS automatique post-formation (C7)</div></div></label>
  </div>
  <div class="field"><label>Score minimum certification (%)</label><input id="qcMin" type="number" value="${qc.minScore}" min="0" max="100"></div>
  <div class="field"><label>Pr√©requis (C2)</label><textarea id="qcPre" rows="2">${qc.prerequis}</textarea></div>
  <div class="field"><label>Objectifs p√©dagogiques (C2) ‚Äî un par ligne</label><textarea id="qcObj" rows="3">${(qc.objectifs||[]).join('\\n')}</textarea></div>
  <div class="field"><label>Modalit√©s de la formation (C2)</label><textarea id="qcMod" rows="2">${qc.modalites||''}</textarea></div>
  <button class="btn-full" style="background:#eab308;color:#000" onclick="saveQualiopiSettings(${fid})">Sauvegarder la configuration ‚Üí</button>`,true);
}
function saveQualiopiSettings(fid){
  qualiopiConfig[fid]={
    enabled:document.getElementById('qcEnabled').checked,
    posQuiz:document.getElementById('qcPos').checked,
    emargement:document.getElementById('qcEmarg').checked,
    satisfactionSurvey:document.getElementById('qcSat').checked,
    minScore:parseInt(document.getElementById('qcMin').value)||70,
    prerequis:document.getElementById('qcPre').value,
    objectifs:document.getElementById('qcObj').value.split('\\n').filter(x=>x.trim()),
    modalites:document.getElementById('qcMod').value
  };
  closeModal();renderDemo();toast('üèÖ Configuration Qualiopi sauvegard√©e');
}
function exportQualiopiProof(fid){
  const f=formations.find(c=>c.id===fid);if(!f)return;
  const qc=qualiopiConfig[fid]||{};
  const qt=qualiopiTracking[fid]||[];
  const learners=formLearners.filter(l=>l.fid===fid);
  const withFinal=qt.filter(t=>t.finalScore!==null);
  const passed=withFinal.filter(t=>t.finalScore>=(qc.minScore||70));
  const satScores=qt.filter(t=>t.satisfaction!==null).map(t=>t.satisfaction);
  const avgSat=satScores.length?(satScores.reduce((a,b)=>a+b,0)/satScores.length).toFixed(1):'N/A';
  const nps=satScores.length?Math.round(satScores.filter(s=>s>=9).length/satScores.length*100):0;
  const avgPos=qt.length?Math.round(qt.reduce((a,t)=>a+(t.posScore||0),0)/qt.length):0;
  const avgFin=withFinal.length?Math.round(withFinal.reduce((a,t)=>a+t.finalScore,0)/withFinal.length):0;
  const totalEmarg=qt.reduce((a,t)=>a+(t.emargements?.length||0),0);
  const txReussite=withFinal.length?Math.round(passed.length/withFinal.length*100):0;
  const txAbandon=learners.length?Math.round(learners.filter(l=>l.status==='inactive').length/learners.length*100):0;
  const today=new Date().toLocaleDateString('fr-FR');
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,H=297,ML=20,MR=20,MT=20,PW=W-ML-MR;
  let y=MT;
  const brandPrimary=brand.colors.primary||'#00d4aa';const bRgb=hexToRgb(brandPrimary);
  const green='#22c55e',red='#ef4444';
  function addPage(){pdf.addPage();y=MT+4;pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(0,0,W,3,'F');drawFooter();}
  function checkPage(need){if(y+need>H-25){addPage();return true;}return false;}
  function drawFooter(){
    const pg=pdf.getNumberOfPages();
    pdf.setDrawColor(220);pdf.line(ML,H-15,W-MR,H-15);
    pdf.setFontSize(7);pdf.setTextColor(160);
    pdf.text((brand.name||'workAI')+' \u2014 Preuves d\'audit Qualiopi',ML,H-10);
    pdf.text('Page '+pg,W-MR,H-10,{align:'right'});
    pdf.text(f.title+' \u2014 '+today,W/2,H-10,{align:'center'});
  }
  // === PAGE 1 : COUVERTURE ===
  // Bande couleur en haut
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(0,0,W,8,'F');
  // Logo
  if(brand.logo){try{pdf.addImage(brand.logo,'PNG',W/2-18,20,36,27,'','FAST');}catch(e){}}
  const coverY=brand.logo?58:40;
  // Titre
  pdf.setFontSize(10);pdf.setTextColor(bRgb.r,bRgb.g,bRgb.b);pdf.setFont('helvetica','bold');
  pdf.text('DOSSIER DE PREUVES D\'AUDIT',W/2,coverY,{align:'center'});
  pdf.setFontSize(28);pdf.setTextColor(40,40,40);
  pdf.text('Certification Qualiopi',W/2,coverY+14,{align:'center'});
  pdf.setDrawColor(bRgb.r,bRgb.g,bRgb.b);pdf.setLineWidth(0.8);pdf.line(W/2-35,coverY+18,W/2+35,coverY+18);
  pdf.setFontSize(10);pdf.setTextColor(120);pdf.setFont('helvetica','normal');
  pdf.text('R\u00e9f\u00e9rentiel National Qualit\u00e9 (RNQ) \u2014 D\u00e9cret n\u00b02019-565',W/2,coverY+26,{align:'center'});
  // Formation title
  pdf.setFontSize(16);pdf.setTextColor(50);pdf.setFont('helvetica','bold');
  pdf.text(f.title,W/2,coverY+44,{align:'center'});
  pdf.setFontSize(10);pdf.setTextColor(130);pdf.setFont('helvetica','normal');
  const descLine=f.desc.length>80?f.desc.substring(0,80)+'...':f.desc;
  pdf.text(descLine,W/2,coverY+52,{align:'center'});
  // Metadata table
  const meta=[['Organisme',brand.name||bizConfig.name||'Mon organisme'],['SIRET',bizConfig.siret||'Non renseign\u00e9'],['N\u00b0 D\u00e9claration d\'activit\u00e9',bizConfig.nda||'En cours'],['Formation',f.title],['Statut',f.status],['Date d\'export',today],['P\u00e9riode couverte','Janvier 2026 \u2014 F\u00e9vrier 2026'],['Apprenants inscrits',''+learners.length],['Certification vis\u00e9e','Qualiopi \u2014 Actions de formation']];
  pdf.autoTable({startY:coverY+62,head:[['Information','D\u00e9tail']],body:meta.map(m=>[m[0],m[1]]),margin:{left:45,right:45},styles:{fontSize:9,cellPadding:4,font:'helvetica',textColor:[50,50,50]},headStyles:{fillColor:[bRgb.r,bRgb.g,bRgb.b],textColor:[255,255,255],fontStyle:'bold'},alternateRowStyles:{fillColor:[250,250,250]},theme:'grid'});
  // Footer legal
  pdf.setFontSize(8);pdf.setTextColor(150);
  pdf.text('Ce document a \u00e9t\u00e9 g\u00e9n\u00e9r\u00e9 automatiquement par la plateforme workAI.',W/2,H-35,{align:'center'});
  pdf.text('Il constitue un dossier de preuves dans le cadre de la certification Qualiopi.',W/2,H-30,{align:'center'});
  pdf.text('Conform\u00e9ment au d\u00e9cret n\u00b02019-565 du 6 juin 2019.',W/2,H-25,{align:'center'});
  // Bande couleur en bas
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(0,H-8,W,8,'F');
  // === PAGE 2 : SYNTH√àSE ===
  addPage();
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(0,0,W,8,'F');
  pdf.setFontSize(14);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('Synth\u00e8se des indicateurs qualit\u00e9',ML,y);y+=10;
  pdf.setFillColor(248,248,248);pdf.roundedRect(ML,y-2,PW,32,2,2,'F');
  pdf.setDrawColor(230);pdf.roundedRect(ML,y-2,PW,32,2,2,'S');
  const kpis=[
    {l:'Taux de r\u00e9ussite',v:txReussite+'%',c:txReussite>=70?green:red},
    {l:'Satisfaction',v:avgSat+'/10',c:parseFloat(avgSat)>=7?green:'#eab308'},
    {l:'NPS',v:nps+'%',c:nps>=50?green:'#eab308'},
    {l:'Progression',v:'+'+Math.max(0,avgFin-avgPos)+'pts',c:avgFin>avgPos?green:red},
    {l:'Taux abandon',v:txAbandon+'%',c:txAbandon<=20?green:red},
    {l:'\u00c9margements',v:''+totalEmarg,c:brandPrimary}
  ];
  const kw=PW/kpis.length;
  kpis.forEach((k,i)=>{
    const kx=ML+i*kw;
    pdf.setFontSize(7);pdf.setTextColor(130);pdf.text(k.l,kx+kw/2,y+5,{align:'center'});
    pdf.setFontSize(16);const rgb=hexToRgb(k.c);pdf.setTextColor(rgb.r,rgb.g,rgb.b);pdf.setFont('helvetica','bold');
    pdf.text(k.v,kx+kw/2,y+17,{align:'center'});
    pdf.setFont('helvetica','normal');
  });
  y+=38;
  // === CRIT√àRE 1 ===
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(ML,y,3,6,'F');
  pdf.setFontSize(11);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('Crit\u00e8re 1 ‚Äî Information du public',ML+6,y+5);y+=12;
  pdf.setFont('helvetica','normal');pdf.setFontSize(9);pdf.setTextColor(80);
  pdf.text('Indicateur 1 : Le prestataire diffuse une information accessible sur sa prestation.',ML,y);y+=6;
  const c1data=[['Description de la formation',f.desc?'Conforme':'Non renseign\u00e9'],['Objectifs p\u00e9dagogiques',(qc.objectifs?.length||0)+' objectifs d\u00e9finis'],['Pr\u00e9requis',qc.prerequis||'Non d\u00e9fini'],['Tarif',f.price?f.price+' EUR':'Gratuit'],['Dur\u00e9e / Modalit\u00e9s',qc.modalites||'Non d\u00e9fini'],['Taux de r\u00e9ussite publi\u00e9',withFinal.length?txReussite+'%':'Donn\u00e9es insuffisantes'],['Taux de satisfaction publi\u00e9',satScores.length?avgSat+'/10':'Donn\u00e9es insuffisantes']];
  pdf.autoTable({startY:y,head:[['Indicateur','Preuve / Valeur']],body:c1data,margin:{left:ML,right:MR},styles:{fontSize:8,cellPadding:3,font:'helvetica'},headStyles:{fillColor:[bRgb.r,bRgb.g,bRgb.b],textColor:[255,255,255],fontStyle:'bold'},alternateRowStyles:{fillColor:[248,248,248]},theme:'grid'});
  y=pdf.lastAutoTable.finalY+10;
  // === CRIT√àRE 2 ===
  checkPage(50);
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(ML,y,3,6,'F');
  pdf.setFontSize(11);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('Crit\u00e8re 2 ‚Äî Objectifs et adaptation des prestations',ML+6,y+5);y+=12;
  pdf.setFont('helvetica','normal');pdf.setFontSize(9);pdf.setTextColor(80);
  pdf.text('Indicateurs 5-8 : Positionnement, objectifs mesurables, contenus adapt\u00e9s.',ML,y);y+=6;
  const c2data=[];
  (qc.objectifs||[]).forEach((o,i)=>{c2data.push(['Objectif '+(i+1),o]);});
  c2data.push(['Quiz de positionnement',qc.posQuiz?'Activ\u00e9 - '+qt.filter(t=>t.posScore).length+' apprenants \u00e9valu\u00e9s':'D\u00e9sactiv\u00e9']);
  c2data.push(['Score moyen positionnement',avgPos+'%']);
  c2data.push(['Score minimum requis',qc.minScore+'%']);
  c2data.push(['Modalit\u00e9s p\u00e9dagogiques',qc.modalites||'Non d\u00e9fini']);
  c2data.push(['Nombre de modules',''+f.modules.length]);
  c2data.push(['Types de contenus',[...new Set(f.modules.flatMap(m=>m.steps.map(s=>s.type)))].join(', ')]);
  pdf.autoTable({startY:y,head:[['Indicateur','Preuve / Valeur']],body:c2data,margin:{left:ML,right:MR},styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[bRgb.r,bRgb.g,bRgb.b],textColor:[255,255,255],fontStyle:'bold'},alternateRowStyles:{fillColor:[248,248,248]},theme:'grid'});
  y=pdf.lastAutoTable.finalY+10;
  // === CRIT√àRE 3 ===
  checkPage(60);
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(ML,y,3,6,'F');
  pdf.setFontSize(11);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('Crit\u00e8re 3 ‚Äî Accueil, suivi et \u00e9valuation',ML+6,y+5);y+=12;
  pdf.setFont('helvetica','normal');pdf.setFontSize(9);pdf.setTextColor(80);
  pdf.text('Indicateurs 9-14 : \u00c9margement, suivi individualis\u00e9, \u00e9valuations.',ML,y);y+=8;
  // √âmargement table
  pdf.setFontSize(10);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('Registre d\'\u00e9margement num\u00e9rique',ML,y);y+=6;
  const emData=qt.map(t=>[t.name,(t.emargements||[]).length+' connexions',(t.emargements||[]).slice(-1)[0]||'-',(t.emargements||[]).join(' | ')]);
  pdf.autoTable({startY:y,head:[['Apprenant','Nb connexions','Derni\u00e8re activit\u00e9','D\u00e9tail horodat\u00e9']],body:emData,margin:{left:ML,right:MR},styles:{fontSize:7,cellPadding:2.5},headStyles:{fillColor:[bRgb.r,bRgb.g,bRgb.b],textColor:[255,255,255],fontStyle:'bold'},columnStyles:{3:{cellWidth:60}},alternateRowStyles:{fillColor:[248,248,248]},theme:'grid'});
  y=pdf.lastAutoTable.finalY+8;
  // R√©sultats √©valuations
  checkPage(50);
  pdf.setFontSize(10);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('R\u00e9sultats des \u00e9valuations',ML,y);y+=6;
  const evalData=qt.map(t=>[t.name,(t.posScore||'-')+'',(t.finalScore||'En cours')+'',(t.finalScore?(t.finalScore-t.posScore>0?'+':'')+Math.round(t.finalScore-t.posScore)+'pts':'‚Äî'),t.finalScore&&t.finalScore>=(qc.minScore||70)?'ACQUIS':t.finalScore?'NON ACQUIS':'En cours']);
  pdf.autoTable({startY:y,head:[['Apprenant','Posit. (%)','Final (%)','Progression','R\u00e9sultat']],body:evalData,margin:{left:ML,right:MR},styles:{fontSize:8,cellPadding:2.5},headStyles:{fillColor:[bRgb.r,bRgb.g,bRgb.b],textColor:[255,255,255],fontStyle:'bold'},alternateRowStyles:{fillColor:[248,248,248]},theme:'grid',didParseCell:function(data){if(data.column.index===4&&data.section==='body'){if(data.cell.raw==='ACQUIS'){data.cell.styles.textColor=[34,197,94];data.cell.styles.fontStyle='bold';}else if(data.cell.raw==='NON ACQUIS'){data.cell.styles.textColor=[239,68,68];data.cell.styles.fontStyle='bold';}}}});
  y=pdf.lastAutoTable.finalY+10;
  // === CRIT√àRE 4 ===
  checkPage(40);
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(ML,y,3,6,'F');
  pdf.setFontSize(11);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('Crit\u00e8re 4 ‚Äî Moyens p\u00e9dagogiques et techniques',ML+6,y+5);y+=12;
  const types={video:0,text:0,pdf:0,quiz:0};f.modules.forEach(m=>m.steps.forEach(s=>{if(types[s.type]!==undefined)types[s.type]++;}));
  const c4data=[['Vid\u00e9os',types.video+' contenus vid\u00e9o int\u00e9gr\u00e9s'],['Textes p\u00e9dagogiques',types.text+' le\u00e7ons r\u00e9dig\u00e9es'],['Documents PDF',types.pdf+' supports t\u00e9l\u00e9chargeables'],['Quiz interactifs',types.quiz+' \u00e9valuations formatives'],['Plateforme','workAI LMS - Acc\u00e8s 24h/24, suivi automatis\u00e9'],['Accessibilit\u00e9','Interface responsive, compatible mobile et desktop']];
  pdf.autoTable({startY:y,head:[['Moyen p\u00e9dagogique','D\u00e9tail']],body:c4data,margin:{left:ML,right:MR},styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[bRgb.r,bRgb.g,bRgb.b],textColor:[255,255,255],fontStyle:'bold'},alternateRowStyles:{fillColor:[248,248,248]},theme:'grid'});
  y=pdf.lastAutoTable.finalY+10;
  // === CRIT√àRES 5-6 ===
  checkPage(40);
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(ML,y,3,6,'F');
  pdf.setFontSize(11);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('Crit\u00e8res 5-6 ‚Äî Qualification et environnement professionnel',ML+6,y+5);y+=12;
  const c56data=[['Profil formateur','CV et qualifications disponibles sur demande'],['Comp\u00e9tences p\u00e9dagogiques','Formation de formateur valid\u00e9e'],['Veille p\u00e9dagogique','Participation r\u00e9guli\u00e8re \u00e0 des formations, s\u00e9minaires, conf\u00e9rences'],['Veille sectorielle','Suivi des \u00e9volutions du secteur et mise \u00e0 jour des contenus']];
  pdf.autoTable({startY:y,head:[['Indicateur','Preuve']],body:c56data,margin:{left:ML,right:MR},styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[bRgb.r,bRgb.g,bRgb.b],textColor:[255,255,255],fontStyle:'bold'},alternateRowStyles:{fillColor:[248,248,248]},theme:'grid'});
  y=pdf.lastAutoTable.finalY+10;
  // === CRIT√àRE 7 ===
  checkPage(50);
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(ML,y,3,6,'F');
  pdf.setFontSize(11);pdf.setTextColor(40,40,40);pdf.setFont('helvetica','bold');
  pdf.text('Crit\u00e8re 7 ‚Äî Am\u00e9lioration continue',ML+6,y+5);y+=12;
  pdf.setFont('helvetica','normal');pdf.setFontSize(9);pdf.setTextColor(80);
  pdf.text('Indicateurs 30-32 : Traitement des difficult\u00e9s, satisfaction, am\u00e9lioration.',ML,y);y+=6;
  const c7data=[['Satisfaction moyenne',avgSat+'/10'],['NPS (Net Promoter Score)',nps+'%'],['Taux de r\u00e9ussite global',txReussite+'%'],['Taux d\'abandon',txAbandon+'%'],['Progression moyenne','+'+Math.max(0,avgFin-avgPos)+' points (positionnement \u2192 final)'],['Nombre d\'\u00e9valuations r\u00e9alis\u00e9es',''+withFinal.length+'/'+qt.length+' apprenants'],['Actions correctives','Relance automatique des apprenants inactifs (>10j)'],['Analyse des r\u00e9sultats','Dashboard qualit\u00e9 en temps r\u00e9el sur la plateforme']];
  pdf.autoTable({startY:y,head:[['Indicateur','Donn\u00e9es / Preuves']],body:c7data,margin:{left:ML,right:MR},styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[bRgb.r,bRgb.g,bRgb.b],textColor:[255,255,255],fontStyle:'bold'},alternateRowStyles:{fillColor:[248,248,248]},theme:'grid'});
  y=pdf.lastAutoTable.finalY+12;
  // === ATTESTATION ===
  checkPage(45);
  pdf.setDrawColor(bRgb.r,bRgb.g,bRgb.b);pdf.setLineWidth(0.5);pdf.roundedRect(ML,y,PW,38,2,2,'S');
  pdf.setFillColor(bRgb.r,bRgb.g,bRgb.b);pdf.rect(ML,y,PW,8,'F');
  pdf.setFontSize(10);pdf.setTextColor(255);pdf.setFont('helvetica','bold');
  pdf.text('Attestation de conformit\u00e9',ML+PW/2,y+6,{align:'center'});
  pdf.setFont('helvetica','normal');pdf.setFontSize(8);pdf.setTextColor(80);
  const att='Je soussign\u00e9(e), en qualit\u00e9 de responsable de l\'organisme de formation, atteste que les informations contenues dans ce document sont exactes et conformes aux exigences du R\u00e9f\u00e9rentiel National Qualit\u00e9 (RNQ). Ce dossier est produit dans le cadre de la certification Qualiopi, conform\u00e9ment au d\u00e9cret n\u00b02019-565 du 6 juin 2019.';
  pdf.text(att,ML+5,y+14,{maxWidth:PW-10});
  pdf.text('Fait \u00e0 __________________, le '+today,ML+5,y+32);
  pdf.text('Signature :',ML+PW-50,y+32);
  // Footer on all pages
  const totalPages=pdf.getNumberOfPages();
  for(let i=1;i<=totalPages;i++){pdf.setPage(i);drawFooter();}
  pdf.save('Qualiopi-Preuves-'+f.title.replace(/[^a-zA-Z0-9]/g,'-')+'.pdf');
  toast('üìã Dossier Qualiopi PDF export\u00e9 !');
}
function hexToRgb(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return{r,g,b};}
function pgStudentView(){
  const f=formations.find(c=>c.id===editCourseId);if(!f)return pgCourseList();
  const m=f.modules[previewModIdx];if(!m)return pgCourseBuilder();
  const s=m.steps[previewStepIdx];
  const allSteps=f.modules.flatMap((mod,mi)=>mod.steps.map((st,si)=>({...st,mi,si,modTitle:mod.title})));
  const flatIdx=f.modules.slice(0,previewModIdx).reduce((a,mod)=>a+mod.steps.length,0)+previewStepIdx;
  const totalSteps=allSteps.length;
  const pct=totalSteps?Math.round((flatIdx+1)/totalSteps*100):0;
  return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
    <button onclick="learnView='course';renderDemo()" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;cursor:pointer;font-family:inherit">‚Üê Retour admin</button>
    <div style="flex:1;text-align:center"><span style="font-size:12px;padding:4px 12px;border-radius:6px;background:${color}20;color:${color};font-weight:600">üëÅ Mode aper√ßu √©l√®ve</span></div>
  </div>
  <div style="display:grid;grid-template-columns:260px 1fr;gap:16px">
    <div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:hidden;max-height:calc(100vh - 200px);overflow-y:auto">
      <div style="padding:14px 16px;border-bottom:1px solid var(--border)">
        <div style="font-size:14px;font-weight:700">${f.title}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${flatIdx+1}/${totalSteps} ¬∑ ${pct}%</div>
        <div style="height:4px;border-radius:2px;background:var(--border);margin-top:8px"><div style="height:100%;width:${pct}%;border-radius:2px;background:${color};transition:width .3s"></div></div>
      </div>
      ${f.modules.map((mod,mi)=>`<div>
        <div style="padding:10px 16px;font-size:12px;font-weight:700;color:var(--muted);background:var(--bg);letter-spacing:.5px">${mi+1}. ${mod.title}</div>
        ${mod.steps.map((st,si)=>{
          const isActive=mi===previewModIdx&&si===previewStepIdx;
          const ico=STEP_TYPES.find(t=>t.v===st.type)?.icon||'üìé';
          return `<div onclick="previewModIdx=${mi};previewStepIdx=${si};quizState={current:0,score:0,answered:[]};renderDemo()" style="padding:8px 16px;display:flex;align-items:center;gap:8px;cursor:pointer;background:${isActive?color+'15':'transparent'};border-left:3px solid ${isActive?color:'transparent'};transition:all .15s" onmouseover="if(!${isActive})this.style.background='rgba(255,255,255,.02)'" onmouseout="if(!${isActive})this.style.background=''">
            <div style="width:20px;height:20px;border-radius:5px;background:${st.done?color+'20':'var(--bg)'};border:1px solid ${st.done?color:'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:9px;color:${st.done?color:'var(--muted)'};flex-shrink:0">${st.done?'‚úì':ico}</div>
            <span style="font-size:12px;${isActive?'font-weight:600;color:var(--text)':'color:var(--muted)'}">${st.title}</span>
          </div>`;
        }).join('')}
      </div>`).join('')}
    </div>
    <div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:hidden">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
        <span style="font-size:18px">${s?STEP_TYPES.find(t=>t.v===s.type)?.icon||'üìé':''}</span>
        <div style="flex:1"><div style="font-size:15px;font-weight:700">${s?.title||''}</div><div style="font-size:11px;color:var(--muted)">${m.title} ¬∑ √âtape ${previewStepIdx+1}/${m.steps.length}</div></div>
      </div>
      <div style="padding:20px">
        ${s?renderStepContent(s,f):'<div style="text-align:center;color:var(--muted)">Aucun contenu</div>'}
      </div>
      <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <button onclick="prevStep()" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:12px;cursor:pointer;font-family:inherit;${flatIdx===0?'opacity:.3;pointer-events:none':''}">‚Üê Pr√©c√©dent</button>
        <button onclick="markStepDone()" style="padding:8px 16px;border-radius:8px;border:none;background:${s?.done?'var(--card)':color+'20'};color:${s?.done?'var(--muted)':color};font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;border:1px solid ${s?.done?'var(--border)':color}">${s?.done?'‚úì Termin√©':'Marquer comme termin√©'}</button>
        <button onclick="nextStep()" style="padding:8px 16px;border-radius:8px;border:none;background:${color};color:var(--bg);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;${flatIdx>=totalSteps-1?'opacity:.3;pointer-events:none':''}">Suivant ‚Üí</button>
      </div>
    </div>
  </div>`;
}
function renderStepContent(s,f){
  if(s.type==='video')return `<div style="position:relative;padding-bottom:56.25%;height:0;border-radius:10px;overflow:hidden;background:#000;margin-bottom:14px">${s.content?`<iframe src="${s.content}" style="position:absolute;top:0;left:0;width:100%;height:100%;border:none" allowfullscreen></iframe>`:'<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px"><span style="font-size:48px;opacity:.5">üé¨</span><span style="color:#888;font-size:13px">Vid√©o √† configurer</span></div>'}</div><div style="font-size:13px;color:var(--muted)">Dur√©e : ${s.duration||'‚Äî'}</div>`;
  if(s.type==='text')return `<div style="font-size:14px;line-height:1.8;white-space:pre-wrap;color:var(--text)">${s.content||'Aucun contenu texte.'}</div>`;
  if(s.type==='pdf'){
    const pid='pdf_'+s.id;
    return `<div style="border-radius:12px;border:1px solid var(--border);overflow:hidden;margin-bottom:14px">
    <div style="background:var(--bg);padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
      <span style="font-size:16px">üìÑ</span><span style="font-size:13px;font-weight:600;flex:1">${s.content||'document.pdf'}</span><span style="font-size:11px;color:var(--muted)">${s.size||''} ¬∑ 4 pages</span>
      <button onclick="downloadPdf('${(s.content||'document.pdf').replace(/'/g,"\\\\'")}')" style="padding:6px 14px;border-radius:6px;border:none;background:${color};color:var(--bg);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">üì• T√©l√©charger</button>
    </div>
    <div style="background:#1a1a2e;padding:24px;min-height:420px;display:flex;flex-direction:column;align-items:center">
      <div id="${pid}" data-page="0" style="width:100%;max-width:520px;background:#fff;border-radius:4px;padding:36px 40px;box-shadow:0 4px 20px rgba(0,0,0,.3);color:#1a1a2e;font-family:Georgia,serif;min-height:320px">
      </div>
      <div style="margin-top:14px;display:flex;align-items:center;gap:10px">
        <button onclick="pdfNav('${pid}',-1)" style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#ccc;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center">‚Äπ</button>
        <span style="font-size:12px;color:#aaa;min-width:80px;text-align:center" id="${pid}_pg">Page 1 / 4</span>
        <button onclick="pdfNav('${pid}',1)" style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#ccc;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center">‚Ä∫</button>
        <div style="width:1px;height:20px;background:rgba(255,255,255,.1);margin:0 4px"></div>
        <button onclick="downloadPdf('${(s.content||'document.pdf').replace(/'/g,"\\\\'")}')" style="padding:6px 16px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit">üì• T√©l√©charger le PDF</button>
      </div>
    </div>
  </div>`;
  }
  if(s.type==='quiz'){
    const qs=s.questions||[];if(!qs.length)return '<div style="text-align:center;color:var(--muted);padding:20px">Aucune question configur√©e</div>';
    const q=qs[quizState.current];
    if(!q)return `<div style="text-align:center;padding:24px"><div style="font-size:40px;margin-bottom:12px">üèÜ</div><div style="font-size:18px;font-weight:800;margin-bottom:6px">Quiz termin√© !</div><div style="font-size:16px;color:${color};font-weight:700;margin-bottom:8px">${quizState.score}/${qs.length} bonnes r√©ponses</div><div style="font-size:13px;color:var(--muted);margin-bottom:16px">${quizState.score===qs.length?'Score parfait ! üéâ':quizState.score>=qs.length*0.7?'Bien jou√© !':'Vous pouvez recommencer'}</div><button onclick="quizState={current:0,score:0,answered:[]};renderDemo()" style="padding:10px 24px;border-radius:10px;border:none;background:${color};color:var(--bg);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">Recommencer le quiz</button></div>`;
    const answered=quizState.answered[quizState.current];
    return `<div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;color:var(--muted)">Question ${quizState.current+1} / ${qs.length}</span><div style="height:4px;width:120px;border-radius:2px;background:var(--border)"><div style="height:100%;width:${Math.round((quizState.current+1)/qs.length*100)}%;border-radius:2px;background:${color}"></div></div></div><div style="font-size:16px;font-weight:700;margin-bottom:16px;line-height:1.4">${q.q}</div>${q.opts.map((o,i)=>{let bg='var(--bg)',brd='var(--border)',col='var(--text)';if(answered!==undefined){if(i===q.correct){bg=color+'15';brd=color;col=color;}if(answered===i&&i!==q.correct){bg='rgba(239,68,68,.1)';brd='var(--accent2)';col='var(--accent2)';}}return `<div onclick="answerQuiz(${i})" style="padding:12px 16px;border-radius:10px;border:1.5px solid ${brd};background:${bg};color:${col};font-size:14px;margin-bottom:8px;cursor:${answered!==undefined?'default':'pointer'};transition:all .2s;font-weight:${answered!==undefined&&i===q.correct?'600':'400'}" ${answered===undefined?`onmouseover="this.style.borderColor='${color}'" onmouseout="this.style.borderColor='var(--border)'"`:``}>${o}</div>`;}).join('')}${answered!==undefined?`<button onclick="quizState.current++;renderDemo()" style="margin-top:8px;padding:10px 24px;border-radius:10px;border:none;background:${color};color:var(--bg);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">${quizState.current<qs.length-1?'Question suivante ‚Üí':'Voir les r√©sultats ‚Üí'}</button>`:''}`;
  }
  return '';
}
function answerQuiz(i){if(quizState.answered[quizState.current]!==undefined)return;const f=formations.find(c=>c.id===editCourseId);if(!f)return;const m=f.modules[previewModIdx];if(!m)return;const s=m.steps[previewStepIdx];if(!s||s.type!=='quiz')return;const qs=s.questions||[];const q=qs[quizState.current];if(!q)return;quizState.answered[quizState.current]=i;if(i===q.correct){quizState.score++;toast('‚úÖ Bonne r√©ponse !');}else toast('‚ùå Mauvaise r√©ponse');renderDemo();}
function nextStep(){const f=formations.find(c=>c.id===editCourseId);if(!f)return;const m=f.modules[previewModIdx];if(previewStepIdx<m.steps.length-1){previewStepIdx++;quizState={current:0,score:0,answered:[]};}else if(previewModIdx<f.modules.length-1){previewModIdx++;previewStepIdx=0;quizState={current:0,score:0,answered:[]};}renderDemo();}
function prevStep(){if(previewStepIdx>0){previewStepIdx--;quizState={current:0,score:0,answered:[]};}else if(previewModIdx>0){const f=formations.find(c=>c.id===editCourseId);previewModIdx--;previewStepIdx=f.modules[previewModIdx].steps.length-1;quizState={current:0,score:0,answered:[]};}renderDemo();}
function markStepDone(){const f=formations.find(c=>c.id===editCourseId);if(!f)return;const m=f.modules[previewModIdx];const s=m.steps[previewStepIdx];s.done=!s.done;renderDemo();if(s.done)toast('‚úÖ √âtape valid√©e');}
function addModule(fid){const f=formations.find(c=>c.id===fid);if(!f)return;const id=Math.max(0,...f.modules.map(m=>m.id))+1;f.modules.push({id,title:'Nouveau module',order:f.modules.length+1,steps:[]});renderDemo();toast('üì¶ Module ajout√©');}
function deleteStep(fid,mid,sid){const f=formations.find(c=>c.id===fid);if(!f)return;const m=f.modules.find(x=>x.id===mid);if(!m)return;m.steps=m.steps.filter(s=>s.id!==sid);renderDemo();toast('üóë √âtape supprim√©e');}
function dupFormation(fid){const f=formations.find(c=>c.id===fid);if(!f)return;const nf=JSON.parse(JSON.stringify(f));nf.id=Date.now();nf.title=f.title+' (copie)';nf.students=0;nf.status='Brouillon';formations.push(nf);renderDemo();toast('üìã Formation dupliqu√©e');}
function modalNewFormation(){showModal(`<h2>üéì Nouvelle formation<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Titre</label><input id="nfT" placeholder="Ex: Les Bases du Coaching"></div><div class="field"><label>Description</label><textarea id="nfD" rows="3" placeholder="De quoi parle cette formation ?"></textarea></div><div class="field-row"><div class="field"><label>Prix (‚Ç¨)</label><input id="nfP" type="number" value="0" placeholder="0 = gratuit"></div><div class="field"><label>Statut</label><select id="nfS"><option value="Brouillon">Brouillon</option><option value="Publi√©">Publi√©</option></select></div></div><button class="btn-full" style="background:${color};color:var(--bg)" onclick="createFormation()">Cr√©er la formation ‚Üí</button>`);}
function createFormation(){const t=document.getElementById('nfT')?.value||'Sans titre';const d=document.getElementById('nfD')?.value||'';const p=parseInt(document.getElementById('nfP')?.value)||0;const s=document.getElementById('nfS')?.value||'Brouillon';const thumbs=['üéØ','üöÄ','üí°','üìö','üåü','üß†','üí™','üé®','üî•','‚ú®'];const f={id:Date.now(),title:t,desc:d,thumb:thumbs[Math.floor(Math.random()*thumbs.length)],status:s,price:p,students:0,rating:0,created:new Date().toLocaleDateString('fr-FR'),modules:[{id:1,title:'Module 1',order:1,steps:[]}]};formations.push(f);editCourseId=f.id;learnView='course';closeModal();renderDemo();toast('üéì Formation "'+t+'" cr√©√©e !');}
function modalEditFormation(fid){const f=formations.find(c=>c.id===fid);if(!f)return;showModal(`<h2>‚öô Param√®tres ‚Äî ${f.title}<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Titre</label><input id="efT" value="${f.title}"></div><div class="field"><label>Description</label><textarea id="efD" rows="3">${f.desc}</textarea></div><div class="field-row"><div class="field"><label>Prix (‚Ç¨)</label><input id="efP" type="number" value="${f.price}"></div><div class="field"><label>Statut</label><select id="efS"><option value="Brouillon" ${f.status==='Brouillon'?'selected':''}>Brouillon</option><option value="Publi√©" ${f.status==='Publi√©'?'selected':''}>Publi√©</option></select></div></div><button class="btn-full" style="background:${color};color:var(--bg)" onclick="saveFormation(${fid})">Sauvegarder ‚Üí</button>`);}
function saveFormation(fid){const f=formations.find(c=>c.id===fid);if(!f)return;f.title=document.getElementById('efT')?.value||f.title;f.desc=document.getElementById('efD')?.value||'';f.price=parseInt(document.getElementById('efP')?.value)||0;f.status=document.getElementById('efS')?.value||'Brouillon';closeModal();renderDemo();toast('‚úÖ Formation mise √† jour');}
function modalEditModule(fid,mid){const f=formations.find(c=>c.id===fid);const m=f?.modules.find(x=>x.id===mid);if(!m)return;showModal(`<h2>üì¶ Module ‚Äî ${m.title}<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Titre du module</label><input id="emT" value="${m.title}"></div><div style="display:flex;gap:8px;margin-top:12px"><button class="btn-full" style="background:${color};color:var(--bg);flex:1" onclick="const m=formations.find(c=>c.id===${fid})?.modules.find(x=>x.id===${mid});if(m)m.title=document.getElementById('emT').value;closeModal();renderDemo();toast('‚úÖ Module renomm√©')">Sauvegarder</button><button class="btn-full" style="background:var(--accent2);color:#fff;flex:0 0 auto;padding:10px 20px" onclick="const f=formations.find(c=>c.id===${fid});if(f)f.modules=f.modules.filter(x=>x.id!==${mid});closeModal();renderDemo();toast('üóë Module supprim√©')">üóë Supprimer</button></div>`);}
function modalAddStep(fid,mid){showModal(`<h2>+ Ajouter une √©tape<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Titre</label><input id="asT" placeholder="Titre de l'√©tape"></div><div class="field"><label>Type de contenu</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">${STEP_TYPES.map(t=>`<div onclick="document.querySelectorAll('.step-type-opt').forEach(e=>e.style.borderColor='var(--border)');this.style.borderColor='${color}';document.getElementById('asType').value='${t.v}'" class="step-type-opt" style="padding:14px;border-radius:10px;border:2px solid var(--border);text-align:center;cursor:pointer;transition:all .15s"><div style="font-size:24px;margin-bottom:4px">${t.icon}</div><div style="font-size:12px;font-weight:600">${t.l.split(' ').slice(1).join(' ')}</div></div>`).join('')}<input type="hidden" id="asType" value="video"></div></div><button class="btn-full" style="background:${color};color:var(--bg)" onclick="addStep(${fid},${mid})">Ajouter ‚Üí</button>`);}
function addStep(fid,mid){const f=formations.find(c=>c.id===fid);const m=f?.modules.find(x=>x.id===mid);if(!m)return;const title=document.getElementById('asT')?.value||'Sans titre';const type=document.getElementById('asType')?.value||'video';const id=Date.now();const step={id,type,title,done:false};if(type==='video'){step.content='';step.duration='0:00';}if(type==='text')step.content='';if(type==='pdf'){step.content='document.pdf';step.size='';}if(type==='quiz')step.questions=[];m.steps.push(step);closeModal();renderDemo();toast('‚úÖ √âtape "'+title+'" ajout√©e');}
function modalEditStep(fid,mid,sid){const f=formations.find(c=>c.id===fid);const m=f?.modules.find(x=>x.id===mid);const s=m?.steps.find(x=>x.id===sid);if(!s)return;let extra='';if(s.type==='video')extra=`<div class="field"><label>URL vid√©o (YouTube embed, Vimeo...)</label><input id="esUrl" value="${s.content||''}" placeholder="https://www.youtube.com/embed/..."></div><div class="field"><label>Dur√©e</label><input id="esDur" value="${s.duration||''}" placeholder="12:30"></div>`;
if(s.type==='text')extra=`<div class="field"><label>Contenu texte</label><textarea id="esTxt" rows="8" style="line-height:1.6">${s.content||''}</textarea></div>`;
if(s.type==='pdf')extra=`<div class="field"><label>Nom du fichier</label><input id="esPdf" value="${s.content||''}" placeholder="guide.pdf"></div><div class="field"><label>Taille</label><input id="esSize" value="${s.size||''}" placeholder="2.4 Mo"></div>`;
if(s.type==='quiz')extra=`<div style="font-size:12px;color:var(--muted);margin-bottom:8px">${(s.questions||[]).length} questions configur√©es</div><button onclick="closeModal();modalQuizEditor(${fid},${mid},${sid})" style="width:100%;padding:10px;border-radius:8px;border:1px solid ${color};background:${color}20;color:${color};font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">üß† Ouvrir l'√©diteur de quiz</button>`;
showModal(`<h2>‚úèÔ∏è ${STEP_TYPES.find(t=>t.v===s.type)?.icon||''} ${s.title}<button class="modal-close" onclick="closeModal()">√ó</button></h2><div class="field"><label>Titre</label><input id="esTitle" value="${s.title}"></div>${extra}<button class="btn-full" style="background:${color};color:var(--bg)" onclick="saveStep(${fid},${mid},${sid})">Sauvegarder ‚Üí</button>`);}
function saveStep(fid,mid,sid){const f=formations.find(c=>c.id===fid);const m=f?.modules.find(x=>x.id===mid);const s=m?.steps.find(x=>x.id===sid);if(!s)return;s.title=document.getElementById('esTitle')?.value||s.title;if(s.type==='video'){s.content=document.getElementById('esUrl')?.value||'';s.duration=document.getElementById('esDur')?.value||'';}if(s.type==='text')s.content=document.getElementById('esTxt')?.value||'';if(s.type==='pdf'){s.content=document.getElementById('esPdf')?.value||'';s.size=document.getElementById('esSize')?.value||'';}closeModal();renderDemo();toast('‚úÖ √âtape mise √† jour');}
function modalQuizEditor(fid,mid,sid){const f=formations.find(c=>c.id===fid);const m=f?.modules.find(x=>x.id===mid);const s=m?.steps.find(x=>x.id===sid);if(!s||s.type!=='quiz')return;const qs=s.questions||[];showModal(`<h2>üß† √âditeur de quiz ‚Äî ${s.title}<button class="modal-close" onclick="closeModal()">√ó</button></h2><div id="quizEd">${qs.map((q,qi)=>`<div style="padding:12px;border-radius:10px;border:1px solid var(--border);margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-size:12px;font-weight:700;color:${color}">Question ${qi+1}</span><span onclick="deleteQuizQuestion(${fid},${mid},${sid},${qi})" style="font-size:11px;color:var(--accent2);cursor:pointer">Supprimer</span></div><input class="qq" value="${q.q}" placeholder="Saisissez votre question..." style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:inherit;outline:none;margin-bottom:6px;box-sizing:border-box">${q.opts.map((o,oi)=>`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><input type="radio" name="qr${qi}" ${oi===q.correct?'checked':''} class="qc${qi}" value="${oi}" style="accent-color:${color}"><input class="qo${qi}" value="${o}" placeholder="R√©ponse ${oi+1}" style="flex:1;padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;font-family:inherit;outline:none"></div>`).join('')}</div>`).join('')}</div><button onclick="addQuizQuestion(${fid},${mid},${sid})" style="width:100%;padding:10px;border-radius:8px;border:2px dashed var(--border);background:transparent;color:var(--muted);font-size:12px;cursor:pointer;font-family:inherit;margin-bottom:12px">+ Ajouter une question</button><button class="btn-full" style="background:${color};color:var(--bg)" onclick="saveQuiz(${fid},${mid},${sid})">Sauvegarder le quiz ‚Üí</button>`,true);}
function addQuizQuestion(fid,mid,sid){const f=formations.find(c=>c.id===fid);const m=f?.modules.find(x=>x.id===mid);const s=m?.steps.find(x=>x.id===sid);if(!s)return;if(!s.questions)s.questions=[];const qqs=document.querySelectorAll('.qq');if(qqs.length){s.questions=Array.from(qqs).map((el,qi)=>{const opts=Array.from(document.querySelectorAll('.qo'+qi)).map(e=>e.value);const radios=document.querySelectorAll('.qc'+qi);let correct=0;radios.forEach(r=>{if(r.checked)correct=parseInt(r.value);});return{q:el.value,opts,correct};});}s.questions.push({q:'',opts:['','','',''],correct:0});closeModal();modalQuizEditor(fid,mid,sid);}
function deleteQuizQuestion(fid,mid,sid,qi){const f=formations.find(c=>c.id===fid);const m=f?.modules.find(x=>x.id===mid);const s=m?.steps.find(x=>x.id===sid);if(!s)return;const qqs=document.querySelectorAll('.qq');if(qqs.length){s.questions=Array.from(qqs).map((el,qidx)=>{const opts=Array.from(document.querySelectorAll('.qo'+qidx)).map(e=>e.value);const radios=document.querySelectorAll('.qc'+qidx);let correct=0;radios.forEach(r=>{if(r.checked)correct=parseInt(r.value);});return{q:el.value,opts,correct};});}s.questions.splice(qi,1);closeModal();modalQuizEditor(fid,mid,sid);}
function saveQuiz(fid,mid,sid){const f=formations.find(c=>c.id===fid);const m=f?.modules.find(x=>x.id===mid);const s=m?.steps.find(x=>x.id===sid);if(!s)return;const qqs=document.querySelectorAll('.qq');s.questions=Array.from(qqs).map((el,qi)=>{const opts=Array.from(document.querySelectorAll('.qo'+qi)).map(e=>e.value);const radios=document.querySelectorAll('.qc'+qi);let correct=0;radios.forEach(r=>{if(r.checked)correct=parseInt(r.value);});return{q:el.value,opts,correct};});closeModal();renderDemo();toast('‚úÖ Quiz sauvegard√© ‚Äî '+s.questions.length+' questions');}
function modalCertificate(fid){const f=formations.find(c=>c.id===fid)||formations[0];showModal(`<div style="text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:16px">üèÜ</div><div style="font-size:10px;letter-spacing:4px;text-transform:uppercase;color:${color};margin-bottom:12px">Certificat de r√©ussite</div><div style="font-size:22px;font-weight:800;margin-bottom:4px">${f.title}</div><div style="font-size:14px;color:var(--muted);margin-bottom:20px">D√©livr√© le ${new Date().toLocaleDateString('fr-FR')}</div><div style="width:80px;height:2px;background:${color};margin:0 auto 20px"></div><div style="font-size:16px;font-weight:600;margin-bottom:4px">Jean Dupont</div><div style="font-size:13px;color:var(--muted)">a compl√©t√© avec succ√®s l'ensemble des modules</div><button onclick="closeModal();toast('üì• Certificat t√©l√©charg√© !')" style="margin-top:20px;padding:12px 32px;border-radius:10px;border:none;background:${color};color:var(--bg);font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">T√©l√©charger PDF ‚Üí</button></div>`,true);}
// ===== E-COMMERCE =====
function pgShop(){
  const cartTotal=cart.reduce((a,c)=>a+c.price*c.qty,0);
  const discount=promoApplied?(PROMOS[promoCode]?.type==='pct'?Math.round(cartTotal*PROMOS[promoCode].val/100):PROMOS[promoCode]?.val||0):0;
  return `<div class="page-head"><h1>Boutique</h1><p>${PRODUCTS.length} produits ¬∑ 34 commandes</p></div>
  <div class="stats"><div class="stat"><div class="s-label">Ventes</div><div class="s-value" style="color:${color}">2 180‚Ç¨</div></div><div class="stat"><div class="s-label">Commandes</div><div class="s-value">34</div></div><div class="stat"><div class="s-label">Panier moyen</div><div class="s-value">64‚Ç¨</div></div><div class="stat"><div class="s-label">Conversion</div><div class="s-value">4.2%</div></div></div>
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px">
    <div>
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">Vos produits</div>
      <div class="cards" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
      ${PRODUCTS.map(p=>`<div class="fcard" style="text-align:center;position:relative">
        <div style="width:40px;height:40px;border-radius:10px;background:${color}15;border:1px solid ${color}30;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:18px">üõçÔ∏è</div>
        <h3 style="font-size:13px">${p.name}</h3>
        <div style="font-size:10px;color:var(--muted)">${p.cat} ¬∑ Stock: ${p.stock}</div>
        <div style="font-size:18px;font-weight:800;color:${color};font-family:'JetBrains Mono',monospace;margin:6px 0">${p.price}‚Ç¨</div>
        <div style="font-size:10px;color:var(--muted);margin-bottom:8px">${p.sold} vendus</div>
        <button onclick="addToCart(${p.id})" style="width:100%;padding:8px;border-radius:8px;border:none;background:${color}20;color:${color};font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s">+ Ajouter au panier</button>
      </div>`).join('')}
      </div>
    </div>
    <div>
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">üõí Panier <span class="cart-badge" style="font-size:12px">${cart.length?`(${cart.reduce((a,c)=>a+c.qty,0)})`:''}</span></div>
      <div style="padding:16px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
        ${cart.length?`${cart.map((c,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.03)">
          <div style="flex:1"><div style="font-size:13px;font-weight:600">${c.name}</div><div style="font-size:11px;color:var(--muted)">${c.price}‚Ç¨ √ó ${c.qty}</div></div>
          <div style="display:flex;align-items:center;gap:6px">
            <button onclick="changeQty(${i},-1)" style="width:24px;height:24px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);cursor:pointer;font-size:12px">-</button>
            <span style="font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace;min-width:20px;text-align:center">${c.qty}</span>
            <button onclick="changeQty(${i},1)" style="width:24px;height:24px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);cursor:pointer;font-size:12px">+</button>
          </div>
          <div style="font-size:13px;font-weight:700;min-width:50px;text-align:right">${c.price*c.qty}‚Ç¨</div>
          <button onclick="cart.splice(${i},1);renderDemo()" style="background:none;border:none;color:var(--accent2);cursor:pointer;font-size:12px">√ó</button>
        </div>`).join('')}
        <div class="promo-input"><input id="promoIn" placeholder="Code promo" value="${promoCode}" style="font-family:'JetBrains Mono',monospace"><button onclick="applyPromo()" style="background:${promoApplied?color:'var(--card)'};color:${promoApplied?'var(--bg)':'var(--text)'};border:1px solid ${promoApplied?color:'var(--border)'}">${promoApplied?'‚úì Appliqu√©':'Appliquer'}</button></div>
        ${promoApplied?`<div style="font-size:11px;color:${color};margin-top:4px">R√©duction : -${discount}‚Ç¨</div>`:''}
        <div style="display:flex;justify-content:space-between;padding-top:12px;margin-top:12px;border-top:1px solid var(--border)">
          <span style="font-size:14px;font-weight:700">Total</span>
          <span style="font-size:18px;font-weight:900;color:${color};font-family:'JetBrains Mono',monospace">${Math.max(0,cartTotal-discount)}‚Ç¨</span>
        </div>
        <button onclick="checkout()" style="width:100%;padding:12px;border-radius:10px;border:none;background:${color};color:var(--bg);font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:10px">Commander ‚Üí</button>`:'<div style="text-align:center;padding:24px;color:var(--muted);font-size:12px">Panier vide<br><span style="font-size:10px">Ajoutez des produits</span></div>'}
      </div>
    </div>
  </div>`;
}
function addToCart(pid){const p=PRODUCTS.find(x=>x.id===pid);if(!p)return;const ex=cart.find(c=>c.id===pid);if(ex)ex.qty++;else cart.push({...p,qty:1});renderDemo();toast('üõí '+p.name+' ajout√© !');}
function changeQty(i,d){cart[i].qty+=d;if(cart[i].qty<=0)cart.splice(i,1);renderDemo();}
function applyPromo(){const code=document.getElementById('promoIn')?.value?.toUpperCase()||'';if(PROMOS[code]){promoCode=code;promoApplied=true;renderDemo();toast('üéâ Code promo appliqu√© !');}else{toast('‚ö†Ô∏è Code invalide','info');}}
function checkout(){if(!cart.length)return;const total=cart.reduce((a,c)=>a+c.price*c.qty,0);cart=[];promoCode='';promoApplied=false;renderDemo();toast('‚úÖ Commande de '+total+'‚Ç¨ valid√©e !');}
// ===== FILES =====
function pgFiles(){const files=[{i:"üìÑ",n:"Contrat_Sophie.pdf",s:"245 Ko",d:"12 f√©v"},{i:"üìä",n:"Bilan_Jan.xlsx",s:"128 Ko",d:"1 f√©v"},{i:"üìù",n:"Programme_V3.docx",s:"89 Ko",d:"28 jan"},{i:"üñºÔ∏è",n:"Logo_HD.png",s:"1.2 Mo",d:"15 jan"}];return`<div class="page-head"><h1>Fichiers</h1><p>${files.length} documents</p></div><div style="display:flex;gap:8px;margin-bottom:12px"><input style="flex:1;padding:9px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;font-family:inherit;outline:none" placeholder="üîç Rechercher..."><button onclick="toast('üìÅ Fichier upload√© !','info')" style="padding:9px 18px;border-radius:10px;border:none;background:${color};color:var(--bg);font-weight:700;font-size:13px;cursor:pointer;font-family:inherit">+ Uploader</button></div><div style="border-radius:14px;background:var(--card);border:1px solid var(--border);overflow:hidden"><table class="dt"><thead><tr><th>Fichier</th><th>Taille</th><th>Date</th><th></th></tr></thead><tbody>${files.map(f=>`<tr><td><span style="font-size:16px;vertical-align:middle;margin-right:6px">${f.i}</span><strong>${f.n}</strong></td><td style="color:var(--muted);font-size:12px">${f.s}</td><td style="color:var(--muted);font-size:12px">${f.d}</td><td><span style="color:${color};cursor:pointer;font-size:11px;font-weight:600" onclick="toast('‚¨áÔ∏è T√©l√©charg√©')">‚Üì</span></td></tr>`).join('')}</tbody></table></div>`;}
// ===== SETTINGS =====
function pgSettings(){const BIZ_TYPES=[{v:'micro',l:'Micro-entreprise',d:'Auto-entrepreneur ¬∑ Comptabilit√© simplifi√©e'},{v:'ei_reel',l:'EI au r√©el',d:'Entreprise individuelle ¬∑ R√©gime r√©el simplifi√©'},{v:'eurl',l:'EURL / SARL',d:'Soci√©t√© ¬∑ R√©gime r√©el simplifi√© ou normal'},{v:'sasu',l:'SASU / SAS',d:'Soci√©t√© par actions ¬∑ R√©gime r√©el'}];return`<div class="page-head"><h1>Param√®tres</h1></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
    <div style="padding:20px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:14px;font-weight:700;margin-bottom:14px">üè¢ Type d'entreprise</div>
      <div style="display:flex;flex-direction:column;gap:6px">${BIZ_TYPES.map(t=>`<div onclick="setBizType('${t.v}')" style="padding:12px 16px;border-radius:10px;border:1px solid ${bizType===t.v?color:'var(--border)'};background:${bizType===t.v?color+'10':'var(--bg)'};cursor:pointer;transition:all .2s"><div style="font-size:13px;font-weight:${bizType===t.v?'700':'500'};color:${bizType===t.v?color:'var(--text)'}">${bizType===t.v?'‚óè ':'‚óã '}${t.l}</div><div style="font-size:11px;color:var(--muted);margin-top:2px">${t.d}</div></div>`).join('')}</div>
      <div style="margin-top:12px;padding:10px;border-radius:8px;background:var(--bg);font-size:11px;color:var(--muted)">
        ${bizType==='micro'?'‚úÖ Livre de recettes ¬∑ Pas de bilan ¬∑ TVA non applicable (franchise) ¬∑ Cotisations URSSAF '+bizConfig.urssafRate+'%':'‚úÖ Journal des op√©rations ¬∑ TVA collect√©e/d√©ductible ¬∑ Bilan simplifi√© (export pour expert-comptable) ¬∑ D√©claration de r√©sultat'}
      </div>
    </div>
    <div style="padding:20px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:14px;font-weight:700;margin-bottom:14px">üìã Informations l√©gales</div>
      <div class="field"><label>Raison sociale${bizType!=='micro'?'':' / Nom'}</label><input value="${bizConfig.name}" onchange="bizConfig.name=this.value"></div>
      <div class="field-row"><div class="field"><label>SIRET</label><input value="${bizConfig.siret}" onchange="bizConfig.siret=this.value"></div><div class="field"><label>N¬∞ TVA</label><input value="${bizConfig.tvaNum}" onchange="bizConfig.tvaNum=this.value" ${isMicro()&&bizConfig.tvaFranchise?'disabled':''}></div></div>
      <div class="field"><label>Adresse</label><input value="${bizConfig.addr}" onchange="bizConfig.addr=this.value"></div>
      <div class="field-row"><div class="field"><label>Email</label><input value="${bizConfig.email}" onchange="bizConfig.email=this.value"></div><div class="field"><label>T√©l√©phone</label><input value="${bizConfig.tel}" onchange="bizConfig.tel=this.value"></div></div>
      ${bizType!=='micro'?`<div class="field-row"><div class="field"><label>Code APE</label><input value="${bizConfig.ape}" onchange="bizConfig.ape=this.value"></div><div class="field"><label>RCS</label><input value="${bizConfig.rcs}" onchange="bizConfig.rcs=this.value" placeholder="RCS Paris B 123 456 789"></div></div>
      <div class="field-row"><div class="field"><label>Taux TVA par d√©faut</label><select onchange="bizConfig.tvaRate=parseInt(this.value)"><option ${bizConfig.tvaRate===20?'selected':''}>20</option><option ${bizConfig.tvaRate===10?'selected':''}>10</option><option ${bizConfig.tvaRate===5.5?'selected':''}>5.5</option></select></div><div class="field"><label style="display:flex;align-items:center;gap:8px;margin-top:18px"><input type="checkbox" ${bizConfig.tvaFranchise?'checked':''} onchange="bizConfig.tvaFranchise=this.checked;renderDemo()"> Franchise en base de TVA</label></div></div>`:`<div class="field-row"><div class="field"><label>Taux cotisations URSSAF</label><select onchange="bizConfig.urssafRate=parseFloat(this.value);renderDemo()"><option value="12.3" ${bizConfig.urssafRate===12.3?'selected':''}>12.3% ‚Äî Vente de marchandises</option><option value="21.2" ${bizConfig.urssafRate===21.2?'selected':''}>21.2% ‚Äî Prestations de services BIC</option><option value="25.6" ${bizConfig.urssafRate===25.6?'selected':''}>25.6% ‚Äî Prestations lib√©rales BNC</option><option value="23.2" ${bizConfig.urssafRate===23.2?'selected':''}>23.2% ‚Äî Activit√©s lib√©rales (CIPAV)</option></select></div><div class="field"><label style="display:flex;align-items:center;gap:8px;margin-top:18px"><input type="checkbox" ${bizConfig.tvaFranchise?'checked':''} onchange="bizConfig.tvaFranchise=this.checked;renderDemo()"> Franchise en base de TVA</label></div></div>`}
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px">
    <div style="padding:20px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:14px;font-weight:700;margin-bottom:14px">üé® Identit√© visuelle</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div>
          <div style="font-size:12px;font-weight:600;margin-bottom:8px">Logo</div>
          <div onclick="document.getElementById('logoInput').click()" style="width:100%;aspect-ratio:16/9;border-radius:10px;border:2px dashed ${brand.logo?color:'var(--border)'};background:${brand.logo?'var(--bg)':'var(--bg)'};display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;transition:all .2s;position:relative" onmouseover="this.style.borderColor='${color}'" onmouseout="this.style.borderColor='${brand.logo?color:'var(--border)'}'">${brand.logo?`<img src="${brand.logo}" style="max-width:90%;max-height:90%;object-fit:contain"><div style="position:absolute;bottom:4px;right:6px;background:var(--bg);padding:2px 6px;border-radius:4px;font-size:9px;color:var(--muted)">Cliquer pour changer</div>`:'<div style="text-align:center"><span style="font-size:28px;display:block;margin-bottom:4px">üì§</span><span style="font-size:11px;color:var(--muted)">Glisser ou cliquer pour<br>importer votre logo</span></div>'}</div>
          <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)" style="display:none">
          ${brand.logo?`<button onclick="brand.logo=null;renderDemo();toast('Logo supprim√©')" style="width:100%;margin-top:6px;padding:5px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:10px;cursor:pointer;font-family:inherit">‚úï Supprimer le logo</button>`:''}
        </div>
        <div>
          <div style="font-size:12px;font-weight:600;margin-bottom:8px">Informations marque</div>
          <div class="field" style="margin-bottom:8px"><label style="font-size:10px">Nom de marque</label><input value="${brand.name}" onchange="setBrandProp('name',this.value);renderDemo()" placeholder="Mon Entreprise"></div>
          <div class="field"><label style="font-size:10px">Slogan / Tagline</label><input value="${brand.tagline}" onchange="setBrandProp('tagline',this.value);renderDemo()" placeholder="Accompagnement sur mesure"></div>
          ${brand.logo?`<div style="margin-top:10px;padding:8px 10px;border-radius:8px;background:${color}10;border:1px solid ${color}30"><div style="font-size:10px;color:${color};font-weight:600;margin-bottom:6px">‚ú® Couleurs extraites du logo</div><div style="display:flex;gap:6px;align-items:center">${[brand.colors.primary,brand.colors.accent,brand.colors.secondary].filter(c=>c).map((c,i)=>`<div onclick="applyBrandColor('${c}')" style="width:28px;height:28px;border-radius:6px;background:${c};cursor:pointer;border:2px solid ${color===c?'#fff':'transparent'};box-shadow:0 2px 6px ${c}40;transition:all .15s" title="${i===0?'Principale':i===1?'Accent':'Secondaire'} ‚Äî ${c}"></div>`).join('')}<span style="font-size:9px;color:var(--muted);margin-left:4px">Cliquez pour appliquer</span></div></div>`:'<div style="margin-top:10px;padding:8px 10px;border-radius:8px;background:var(--bg);font-size:10px;color:var(--muted)">üí° Importez votre logo pour extraire automatiquement votre palette de couleurs</div>'}
        </div>
      </div>
      <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
        <div style="font-size:12px;font-weight:600;margin-bottom:10px">Palette de couleurs</div>
        <div style="display:flex;gap:10px;align-items:start;flex-wrap:wrap">
          <div style="text-align:center"><div style="font-size:9px;color:var(--muted);margin-bottom:4px">Principale</div><div onclick="document.getElementById('cpPrimary').click()" style="width:44px;height:44px;border-radius:10px;background:${brand.colors.primary};cursor:pointer;border:3px solid rgba(255,255,255,.15);box-shadow:0 2px 8px ${brand.colors.primary}40;transition:all .2s" title="${brand.colors.primary}"></div><input type="color" id="cpPrimary" value="${brand.colors.primary}" onchange="applyBrandColor(this.value)" style="display:none"></div>
          <div style="text-align:center"><div style="font-size:9px;color:var(--muted);margin-bottom:4px">Accent</div><div onclick="document.getElementById('cpAccent').click()" style="width:44px;height:44px;border-radius:10px;background:${brand.colors.accent};cursor:pointer;border:3px solid rgba(255,255,255,.15);transition:all .2s" title="${brand.colors.accent}"></div><input type="color" id="cpAccent" value="${brand.colors.accent}" onchange="brand.colors.accent=this.value;renderDemo()" style="display:none"></div>
          <div style="text-align:center"><div style="font-size:9px;color:var(--muted);margin-bottom:4px">Secondaire</div><div onclick="document.getElementById('cpSecondary').click()" style="width:44px;height:44px;border-radius:10px;background:${brand.colors.secondary};cursor:pointer;border:3px solid rgba(255,255,255,.15);transition:all .2s" title="${brand.colors.secondary}"></div><input type="color" id="cpSecondary" value="${brand.colors.secondary}" onchange="brand.colors.secondary=this.value;renderDemo()" style="display:none"></div>
          <div style="width:1px;height:44px;background:var(--border);margin-top:13px"></div>
          ${COLORS.map(c=>`<div style="text-align:center"><div style="font-size:9px;color:var(--muted);margin-bottom:4px">${c.n}</div><div style="width:32px;height:32px;border-radius:8px;background:${c.h};cursor:pointer;border:2px solid ${color===c.h?'#fff':'transparent'};transition:all .2s;margin-top:6px" onclick="applyBrandColor('${c.h}')" title="${c.n}"></div></div>`).join('')}
        </div>
      </div>
      ${brand.logo?`<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
        <div style="font-size:12px;font-weight:600;margin-bottom:10px">üëÅ Aper√ßu en-t√™te documents</div>
        <div style="padding:16px 20px;border-radius:10px;background:#fff;display:flex;align-items:center;gap:14px">
          <img src="${brand.logo}" style="height:36px;object-fit:contain">
          <div><div style="font-size:14px;font-weight:700;color:${brand.colors.secondary||'#1a1a2e'}">${brand.name}</div>${brand.tagline?`<div style="font-size:10px;color:#888">${brand.tagline}</div>`:''}</div>
          <div style="margin-left:auto;text-align:right;font-size:9px;color:#aaa;line-height:1.6">${bizConfig.name}<br>${bizConfig.siret?'SIRET '+bizConfig.siret:''}<br>${bizConfig.email}</div>
        </div>
        <div style="margin-top:8px;padding:12px 16px;border-radius:10px;background:${brand.colors.primary}10;border:1px solid ${brand.colors.primary}30;display:flex;align-items:center;gap:10px">
          <div style="width:6px;height:6px;border-radius:50%;background:${brand.colors.primary}"></div>
          <span style="font-size:11px;color:${brand.colors.primary};font-weight:600">Ce branding sera appliqu√© aux factures, certificats, exports PDF Qualiopi et emails</span>
        </div>
      </div>`:''}
    </div>
    <div style="padding:20px;border-radius:14px;background:var(--card);border:1px solid var(--border)">
      <div style="font-size:14px;font-weight:700;margin-bottom:14px">üí≥ Abonnement</div>
      <div style="font-size:18px;font-weight:800;color:${color}">Fondateur</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px">9‚Ç¨/mois ¬∑ Tout inclus √† vie</div>
      <div style="margin-top:14px;padding:10px;border-radius:8px;background:var(--bg);font-size:11px;color:var(--muted)">Mentions auto sur factures : ${isMicro()&&bizConfig.tvaFranchise?'"TVA non applicable, art. 293 B du CGI"':'TVA '+bizConfig.tvaRate+'% ¬∑ N¬∞ TVA '+bizConfig.tvaNum}${bizType!=='micro'&&bizConfig.rcs?' ¬∑ '+bizConfig.rcs:''}</div>
    </div>
  </div>`;
}
function setBizType(t){bizType=t;if(t==='micro'){bizConfig.tvaFranchise=true;bizConfig.urssafRate=21.2;}else{bizConfig.tvaFranchise=false;}renderDemo();toast('üè¢ Type : '+(t==='micro'?'Micro-entreprise':t==='ei_reel'?'EI au r√©el':t==='eurl'?'EURL/SARL':'SASU/SAS'));}
// INIT
renderLandingMods();
</script>
</body></html>